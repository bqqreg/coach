<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Coach">
  <title>Coach Adaptativo</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap');
    
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
      min-height: 100dvh;
    }
    
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
      min-height: 52px;
    }
    
    .btn-primary { background: #16a34a; color: white; }
    .btn-primary:active { background: #15803d; transform: scale(0.98); }
    .btn-primary:disabled { background: #86efac; cursor: not-allowed; }
    .btn-secondary { background: white; border: 1px solid #e2e8f0; color: #1e293b; }
    .btn-secondary:active { background: #f1f5f9; }
    .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
    .btn-danger:active { background: #fecaca; }
    .btn-warning { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
    .btn-sm { min-height: 40px; padding: 0.5rem 1rem; font-size: 0.875rem; }
    
    .card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .input {
      width: 100%;
      padding: 0.875rem 1rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      color: #1e293b;
      font-size: 16px;
    }
    
    .input:focus { outline: none; border-color: #16a34a; }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e2e8f0;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #16a34a;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .toggle {
      position: relative;
      width: 52px;
      height: 32px;
      background: #e2e8f0;
      border-radius: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .toggle.active { background: #16a34a; }
    
    .toggle::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .toggle.active::after { transform: translateX(20px); }
    
    .day-badge {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
    }
    
    .day-a { background: #dcfce7; color: #16a34a; border: 2px solid #16a34a; }
    .day-b { background: #dbeafe; color: #2563eb; border: 2px solid #2563eb; }
    .day-c { background: #fef3c7; color: #d97706; border: 2px solid #d97706; }
    
    .exercise-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .exercise-card.completed { border-color: #86efac; background: #f0fdf4; }
    .exercise-card.postponed { border-color: #fde68a; background: #fffbeb; }
    .exercise-card.potencia { border-left: 4px solid #ef4444; }
    .exercise-card.fuerza { border-left: 4px solid #3b82f6; }
    .exercise-card.resistencia { border-left: 4px solid #8b5cf6; }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .badge-potencia { background: #fee2e2; color: #dc2626; }
    .badge-fuerza { background: #dbeafe; color: #2563eb; }
    .badge-resistencia { background: #ede9fe; color: #7c3aed; }
    .badge-postponed { background: #fef3c7; color: #d97706; }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-casa { background: #fef3c7; color: #92400e; }
    
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    
    .screen { display: none; padding: 1rem; padding-bottom: 100px; }
    .screen.active { display: block; }
    
    .exercise-link {
      color: #1e293b;
      text-decoration: none;
      border-bottom: 1px dashed #94a3b8;
    }
    
    .info-box {
      background: #f1f5f9;
      border-left: 3px solid #3b82f6;
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      font-size: 0.875rem;
    }
    
    .info-box.warning { border-left-color: #f59e0b; background: #fffbeb; }
    .info-box.error { border-left-color: #ef4444; background: #fef2f2; }
    .info-box.success { border-left-color: #16a34a; background: #f0fdf4; }
    
    .timer-display {
      font-size: 3rem;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      color: #1e293b;
    }
    
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring circle { fill: none; stroke-width: 8; }
    .progress-ring .bg { stroke: #e2e8f0; }
    .progress-ring .progress { stroke: #16a34a; stroke-linecap: round; }
    
    .time-btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #e2e8f0;
      background: white;
      transition: all 0.15s;
    }
    .time-btn.selected { border-color: #16a34a; background: #f0fdf4; }
    
    .location-btn {
      flex: 1;
      padding: 1.5rem 1rem;
      border-radius: 16px;
      text-align: center;
      border: 2px solid #e2e8f0;
      background: white;
      cursor: pointer;
    }
    .location-btn.selected { border-color: #16a34a; background: #f0fdf4; }
    
    .preview-exercise {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.875rem;
    }
    
    .preview-exercise:last-child { border-bottom: none; }
    
    .postponed-bar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: #fffbeb;
      border-top: 1px solid #fde68a;
      padding: 0.75rem 1rem;
      z-index: 25;
    }
    
    .last-weight {
      font-size: 0.7rem;
      color: #16a34a;
      background: #dcfce7;
      padding: 2px 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body x-data="app()" x-init="init()">
  
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/95 backdrop-blur border-b border-slate-200 px-4 py-3">
    <div class="flex items-center justify-between">
      <h1 class="text-lg font-semibold text-slate-800" x-text="screenTitles[currentScreen]"></h1>
      <div class="flex items-center gap-2">
        <template x-if="currentSession && currentScreen === 'home'">
          <button @click="showCancelModal = true" class="p-2 rounded-lg bg-red-50 text-red-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </template>
        <button @click="showBackupModal = true" class="p-2 rounded-lg bg-slate-100 relative" x-show="currentScreen === 'home'">
          <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          <span x-show="needsBackupReminder()" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- ==================== HOME ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'home' }">
    
    <!-- Paso 1: Elegir ubicaci√≥n -->
    <template x-if="!todayCheckin">
      <div class="card mb-4">
        <h2 class="font-semibold mb-4">¬øD√≥nde entrenas hoy?</h2>
        <div class="flex gap-3 mb-4">
          <button 
            @click="checkinForm.ubicacion = 'gym'" 
            class="location-btn"
            :class="{ 'selected': checkinForm.ubicacion === 'gym' }"
          >
            <div class="text-3xl mb-2">üèãÔ∏è</div>
            <div class="font-medium">Gimnasio</div>
          </button>
          <button 
            @click="checkinForm.ubicacion = 'casa'" 
            class="location-btn"
            :class="{ 'selected': checkinForm.ubicacion === 'casa' }"
          >
            <div class="text-3xl mb-2">üè†</div>
            <div class="font-medium">Casa</div>
          </button>
        </div>
        
        <!-- Aviso si no hay material en casa -->
        <template x-if="checkinForm.ubicacion === 'casa' && !tieneMaterialCasa()">
          <div class="info-box warning mb-4">
            <span class="font-medium">‚ö†Ô∏è No tienes material configurado</span>
            <p class="text-xs mt-1">Ve a Ajustes ‚Üí Material en casa para a√±adir tu equipo.</p>
          </div>
        </template>
        
        <button 
          @click="showCheckinModal = true" 
          class="btn btn-primary w-full"
          :disabled="!checkinForm.ubicacion"
        >
          Continuar
        </button>
      </div>
    </template>
    
    <!-- Estado de hoy (despu√©s del check-in) -->
    <template x-if="todayCheckin && !currentSession">
      <div>
        <!-- Resumen -->
        <div class="card mb-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-xl" x-text="todayCheckin.ubicacion === 'gym' ? 'üèãÔ∏è' : 'üè†'"></span>
              <span class="text-sm text-slate-500" x-text="todayCheckin.ubicacion === 'gym' ? 'Gimnasio' : 'Casa'"></span>
              <span class="text-sm text-slate-400">¬∑</span>
              <span class="text-sm text-slate-500" x-text="todayCheckin.tiempo + ' min'"></span>
            </div>
            <button @click="resetCheckin()" class="text-sm text-green-600">Cambiar</button>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-2xl" x-text="getStateEmoji(todayCheckin.estado)"></span>
            <div class="flex-1 grid grid-cols-2 gap-2 text-sm">
              <div>Rodilla: <span class="mono" x-text="todayCheckin.dolorRodilla + '/10'"></span></div>
              <div>Cuello: <span class="mono" x-text="todayCheckin.dolorCuello + '/10'"></span></div>
            </div>
          </div>
        </div>
        
        <!-- D√≠a que toca -->
        <div class="card mb-4">
          <div class="flex items-center gap-4 mb-3">
            <div class="day-badge" :class="'day-' + nextDayType.toLowerCase()" x-text="nextDayType"></div>
            <div>
              <div class="font-semibold" x-text="getDayTitle(nextDayType)"></div>
              <div class="text-sm text-slate-500">
                <span x-text="getEstimatedDuration() + ' min'"></span> ¬∑ 
                <span x-text="getPreviewExerciseCount() + ' ejercicios'"></span>
              </div>
            </div>
          </div>
          
          <!-- Preview de ejercicios -->
          <div class="mb-4">
            <button @click="showPreview = !showPreview" class="text-sm text-green-600 mb-2">
              <span x-text="showPreview ? '‚ñº Ocultar ejercicios' : '‚ñ∂ Ver ejercicios'"></span>
            </button>
            
            <template x-if="showPreview">
              <div class="bg-slate-50 rounded-lg p-3 mt-2">
                <template x-for="block in getPreviewBlocks()" :key="block.name">
                  <div class="mb-3">
                    <div class="text-xs font-semibold text-slate-400 uppercase mb-1 flex items-center gap-2">
                      <span x-text="block.name"></span>
                      <span class="badge" :class="'badge-' + block.tipo" x-text="block.badge" x-show="block.badge"></span>
                    </div>
                    <template x-for="ex in block.exercises" :key="ex.id">
                      <div class="preview-exercise">
                        <span class="text-slate-400">‚Ä¢</span>
                        <span x-text="ex.name"></span>
                        <span class="text-slate-400 text-xs" x-text="ex.prescription"></span>
                        <template x-if="getLastWeight(ex.id)">
                          <span class="last-weight" x-text="'√öltimo: ' + getLastWeight(ex.id) + 'kg'"></span>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
          
          <!-- Error si sesi√≥n inv√°lida -->
          <template x-if="!isSessionValid()">
            <div class="info-box error mb-4">
              <span class="font-medium">‚ùå No hay suficientes ejercicios</span>
              <p class="text-xs mt-1" x-text="getSessionError()"></p>
            </div>
          </template>
          
          <button 
            @click="generateSession()" 
            class="btn btn-primary w-full"
            :disabled="!isSessionValid()"
          >
            Empezar entrenamiento
          </button>
        </div>
        
        <!-- Estructura semanal -->
        <div class="card">
          <h3 class="font-semibold mb-3">Tu semana</h3>
          <div class="space-y-2">
            <div class="flex items-center gap-3 p-2 rounded-lg" :class="nextDayType === 'A' ? 'bg-green-50' : ''">
              <div class="day-badge day-a text-sm w-8 h-8">A</div>
              <div class="flex-1 text-sm">
                <div class="font-medium">Tir√≥n + Posterior</div>
                <div class="text-xs text-slate-500">Espalda, RDL, Core</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-2 rounded-lg" :class="nextDayType === 'B' ? 'bg-blue-50' : ''">
              <div class="day-badge day-b text-sm w-8 h-8">B</div>
              <div class="flex-1 text-sm">
                <div class="font-medium">Pierna + Empuje</div>
                <div class="text-xs text-slate-500">Sentadilla, Press, Core</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-2 rounded-lg" :class="nextDayType === 'C' ? 'bg-amber-50' : ''">
              <div class="day-badge day-c text-sm w-8 h-8">C</div>
              <div class="flex-1 text-sm">
                <div class="font-medium">Espalda completa</div>
                <div class="text-xs text-slate-500">Remos, Jal√≥n, Core</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
    
    <!-- Sesi√≥n activa -->
    <template x-if="currentSession">
      <div>
        <!-- Cabecera sesi√≥n -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="day-badge" :class="'day-' + currentSession.dayType.toLowerCase()" x-text="currentSession.dayType"></div>
            <div>
              <div class="font-semibold" x-text="getDayTitle(currentSession.dayType)"></div>
              <div class="text-sm text-slate-500">
                <span x-text="getCompletedCount()"></span>/<span x-text="getTotalCount()"></span> ejercicios
                <span class="text-slate-400 ml-2" x-text="currentSession.ubicacion === 'casa' ? 'üè†' : 'üèãÔ∏è'"></span>
              </div>
            </div>
          </div>
          <button @click="showPainModal = true" class="btn btn-danger btn-sm">
            Me duele
          </button>
        </div>
        
        <!-- Bloques de ejercicios -->
        <template x-for="(block, blockIdx) in currentSession.blocks" :key="blockIdx">
          <div class="mb-6" x-show="block.exercises.length > 0">
            <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3 flex items-center gap-2">
              <span x-text="block.name"></span>
              <template x-if="block.tipo">
                <span class="badge" :class="'badge-' + block.tipo" x-text="block.badge"></span>
              </template>
            </h3>
            
            <!-- Instrucci√≥n del bloque -->
            <template x-if="block.instruccion">
              <p class="text-xs text-slate-500 mb-2 italic" x-text="block.instruccion"></p>
            </template>
            
            <template x-for="(exercise, exIdx) in block.exercises" :key="exercise.id + '-' + exIdx">
              <div 
                class="exercise-card" 
                :class="{ 
                  'completed': exercise.completed, 
                  'postponed': exercise.postponed,
                  [block.tipo]: block.tipo 
                }"
                x-show="!exercise.postponed"
              >
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <a 
                        :href="'https://www.google.com/search?q=' + encodeURIComponent(exercise.name + ' ejercicio gym')"
                        target="_blank"
                        class="exercise-link font-medium"
                        @click.stop
                        x-text="exercise.name"
                      ></a>
                      <template x-if="exercise.esCasa">
                        <span class="badge badge-casa text-xs">üè†</span>
                      </template>
                    </div>
                    <div class="text-sm text-slate-500 mt-1" x-text="exercise.prescription"></div>
                    <template x-if="exercise.tempo">
                      <div class="text-xs text-slate-400 mt-1" x-text="'Tempo: ' + exercise.tempo"></div>
                    </template>
                    <!-- √öltimo peso usado -->
                    <template x-if="getLastWeight(exercise.id)">
                      <div class="text-xs text-green-600 mt-1">
                        üí° √öltimo peso: <span class="font-medium" x-text="getLastWeight(exercise.id) + 'kg'"></span>
                      </div>
                    </template>
                  </div>
                  
                  <div class="flex items-center gap-1">
                    <!-- Posponer -->
                    <template x-if="!exercise.completed && !exercise.postponed">
                      <button 
                        @click="postponeExercise(blockIdx, exIdx)"
                        class="w-9 h-9 rounded-full flex items-center justify-center bg-slate-100 text-slate-500"
                        title="Posponer"
                      >
                        <span class="text-sm">‚è≠Ô∏è</span>
                      </button>
                    </template>
                    
                    <!-- Completar -->
                    <button 
                      @click="toggleComplete(blockIdx, exIdx)"
                      class="w-9 h-9 rounded-full flex items-center justify-center"
                      :class="exercise.completed ? 'bg-green-500 text-white' : 'bg-slate-100'"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <!-- Timer -->
                <template x-if="exercise.restTime && !exercise.postponed">
                  <button 
                    @click="startTimer(exercise.restTime)"
                    class="btn btn-secondary btn-sm w-full mt-2"
                  >
                    ‚è±Ô∏è Descanso <span x-text="exercise.restTime"></span>s
                  </button>
                </template>
                
                <!-- Tracking sets -->
                <template x-if="exercise.trackSets && exercise.sets && !exercise.postponed">
                  <div class="mt-3 pt-3 border-t border-slate-100">
                    <div class="grid grid-cols-4 gap-2 text-xs text-slate-400 mb-2">
                      <span>Set</span><span>Peso</span><span>Reps</span><span>RIR</span>
                    </div>
                    <template x-for="(set, setIdx) in exercise.sets" :key="setIdx">
                      <div class="grid grid-cols-4 gap-2 mb-2">
                        <span class="mono text-sm py-2" x-text="setIdx + 1"></span>
                        <input type="number" x-model.number="set.weight" @change="saveSession()" class="input py-1 px-2 text-sm" placeholder="kg">
                        <input type="number" x-model.number="set.reps" @change="saveSession()" class="input py-1 px-2 text-sm" placeholder="reps">
                        <input type="number" x-model.number="set.rir" @change="saveSession()" class="input py-1 px-2 text-sm" placeholder="rir">
                      </div>
                    </template>
                  </div>
                </template>
                
                <!-- Alternativas -->
                <template x-if="exercise.substitutes && exercise.substitutes.length > 0 && !exercise.postponed">
                  <div class="mt-2 pt-2 border-t border-slate-100">
                    <button 
                      @click="exercise.showSubs = !exercise.showSubs"
                      class="text-xs text-green-600"
                    >
                      <span x-text="exercise.showSubs ? 'Ocultar alternativas' : '‚ÜîÔ∏è Alternativas'"></span>
                    </button>
                    <template x-if="exercise.showSubs">
                      <div class="mt-2 flex flex-wrap gap-2">
                        <template x-for="sub in exercise.substitutes" :key="sub">
                          <button 
                            @click="swapExercise(blockIdx, exIdx, sub)"
                            class="text-xs py-1 px-2 rounded bg-slate-100"
                            x-text="sub"
                          ></button>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
        
        <!-- Finalizar -->
        <button @click="confirmFinish()" class="btn btn-primary w-full mb-4">
          ‚úì Finalizar entrenamiento
        </button>
      </div>
    </template>
    
  </div>
  
  <!-- Barra de pospuestos (fija) -->
  <template x-if="currentSession && getPostponedExercises().length > 0">
    <div class="postponed-bar">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-amber-600">‚è≥</span>
          <span class="text-sm font-medium" x-text="getPostponedExercises().length + ' pospuesto(s)'"></span>
        </div>
        <button @click="showPostponedModal = true" class="text-sm text-amber-700 font-medium">
          Ver ‚Üí
        </button>
      </div>
    </div>
  </template>

  <!-- ==================== AJUSTES ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'settings' }">
    <div class="space-y-4">
      
      <!-- Perfil de salud -->
      <div class="card">
        <h3 class="font-semibold mb-3">Restricciones de salud</h3>
        <div class="space-y-3">
          <label class="flex items-center justify-between">
            <span class="text-sm">Problemas cervicales</span>
            <div class="toggle" :class="{ 'active': profile.problemasCuello }" @click="profile.problemasCuello = !profile.problemasCuello; saveProfile()"></div>
          </label>
          <label class="flex items-center justify-between">
            <span class="text-sm">Tendinopat√≠a rotuliana</span>
            <div class="toggle" :class="{ 'active': profile.tendinopatiaRodilla }" @click="profile.tendinopatiaRodilla = !profile.tendinopatiaRodilla; saveProfile()"></div>
          </label>
        </div>
      </div>
      
      <!-- Umbrales -->
      <div class="card">
        <h3 class="font-semibold mb-3">Umbrales de dolor</h3>
        <p class="text-xs text-slate-500 mb-4">Si superas estos niveles, adapto ejercicios.</p>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Rodilla m√°ximo</span>
              <span class="mono" x-text="profile.umbralRodilla + '/10'"></span>
            </div>
            <input type="range" class="slider" min="1" max="10" x-model.number="profile.umbralRodilla" @change="saveProfile()">
          </div>
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Cuello m√°ximo</span>
              <span class="mono" x-text="profile.umbralCuello + '/10'"></span>
            </div>
            <input type="range" class="slider" min="1" max="10" x-model.number="profile.umbralCuello" @change="saveProfile()">
          </div>
        </div>
      </div>
      
      <!-- Tiempos descanso -->
      <div class="card">
        <h3 class="font-semibold mb-3">Tiempos de descanso (segundos)</h3>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-slate-500">üî• Potencia</label>
            <input type="number" class="input mt-1 text-center" x-model.number="profile.descansoPotencia" @change="saveProfile()">
          </div>
          <div>
            <label class="text-xs text-slate-500">üí™ Fuerza</label>
            <input type="number" class="input mt-1 text-center" x-model.number="profile.descansoFuerza" @change="saveProfile()">
          </div>
          <div>
            <label class="text-xs text-slate-500">üîÑ Resist.</label>
            <input type="number" class="input mt-1 text-center" x-model.number="profile.descansoResistencia" @change="saveProfile()">
          </div>
        </div>
      </div>
      
      <!-- Material en casa -->
      <div class="card">
        <h3 class="font-semibold mb-3">üè† Mi material en casa</h3>
        <p class="text-xs text-slate-500 mb-3">Marca lo que tengas disponible</p>
        <div class="space-y-3">
          <template x-for="(item, key) in materialCasa" :key="key">
            <div>
              <label class="flex items-center justify-between">
                <span class="text-sm" x-text="materialNames[key]"></span>
                <div class="toggle" :class="{ 'active': item.tiene }" @click="item.tiene = !item.tiene; saveMaterial()"></div>
              </label>
              <template x-if="item.tiene && item.pesoConfig">
                <div class="mt-2 ml-4">
                  <label class="text-xs text-slate-500">Pesos disponibles (kg)</label>
                  <input type="text" class="input mt-1 text-sm" placeholder="ej: 5, 10, 15, 20" x-model="item.pesos" @change="saveMaterial()">
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Backup -->
      <div class="card">
        <h3 class="font-semibold mb-3">Backup</h3>
        <div class="space-y-3">
          <label class="flex items-center justify-between">
            <div>
              <span class="text-sm">Auto-backup</span>
              <p class="text-xs text-slate-500">Descarga JSON al terminar</p>
            </div>
            <div class="toggle" :class="{ 'active': profile.autoBackup }" @click="profile.autoBackup = !profile.autoBackup; saveProfile()"></div>
          </label>
          <div class="text-xs text-slate-500">
            √öltimo backup: <span x-text="getLastBackupDate()"></span>
          </div>
          <div class="text-xs text-slate-500">
            Sesiones desde backup: <span x-text="profile.sessionsSinceBackup || 0"></span>
          </div>
        </div>
      </div>
      
      <!-- Borrar datos -->
      <div class="card">
        <h3 class="font-semibold mb-3 text-red-600">Zona peligrosa</h3>
        <button @click="confirmReset()" class="btn btn-danger w-full">
          üóëÔ∏è Borrar todos los datos
        </button>
      </div>
      
    </div>
  </div>

  <!-- ==================== STATS ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'stats' }">
    <div class="space-y-4">
      
      <div class="card">
        <h3 class="font-semibold mb-3">Esta semana</h3>
        <div class="flex items-end gap-1 h-16 mb-2">
          <template x-for="(day, idx) in weekDays" :key="idx">
            <div class="flex-1 flex flex-col items-center">
              <div class="w-full rounded-t" :class="getWorkoutDayClass(day)" :style="'height: ' + getWorkoutDayHeight(day) + 'px'"></div>
              <span class="text-xs text-slate-400 mt-1" x-text="day.label"></span>
            </div>
          </template>
        </div>
        <div class="text-center">
          <span class="text-2xl font-semibold" x-text="weeklyStats.completed"></span>
          <span class="text-slate-500">/ 3 sesiones</span>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold mb-3">Totales</h3>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-green-600" x-text="recentSessions.length"></div>
            <div class="text-xs text-slate-500">Sesiones</div>
          </div>
          <div>
            <div class="text-2xl font-bold" x-text="getTotalCompletedSessions()"></div>
            <div class="text-xs text-slate-500">Completas</div>
          </div>
          <div>
            <div class="text-2xl font-bold" x-text="getStreakDays()"></div>
            <div class="text-xs text-slate-500">Racha</div>
          </div>
        </div>
      </div>
      
      <!-- Progresi√≥n de peso por ejercicio -->
      <div class="card">
        <h3 class="font-semibold mb-3">üìà Progresi√≥n</h3>
        <template x-if="Object.keys(exerciseHistory).length === 0">
          <p class="text-sm text-slate-500">A√∫n no hay datos. Registra peso en tus ejercicios.</p>
        </template>
        <div class="space-y-3">
          <template x-for="(data, exId) in getTopExercises()" :key="exId">
            <div class="p-3 bg-slate-50 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-sm" x-text="data.name"></span>
                <span class="text-green-600 font-bold" x-text="data.maxWeight + ' kg'"></span>
              </div>
              <div class="flex gap-1 h-8">
                <template x-for="(w, idx) in data.history.slice(-10)" :key="idx">
                  <div 
                    class="flex-1 bg-green-400 rounded-t"
                    :style="'height: ' + (w / data.maxWeight * 100) + '%'"
                    :title="w + 'kg'"
                  ></div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold mb-3">M√©tricas</h3>
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="text-xs text-slate-500">Peso (kg)</label>
            <input type="number" class="input mt-1" x-model.number="metrics.peso" @change="saveMetrics()" step="0.1">
          </div>
          <div class="flex-1">
            <label class="text-xs text-slate-500">Cintura (cm)</label>
            <input type="number" class="input mt-1" x-model.number="metrics.cintura" @change="saveMetrics()" step="0.5">
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold mb-3">Historial</h3>
        <div class="space-y-2 max-h-60 overflow-y-auto">
          <template x-for="session in recentSessions.slice(0, 20)" :key="session.date">
            <div class="flex items-center gap-3 py-2 border-b border-slate-100">
              <div class="day-badge text-xs w-8 h-8" :class="'day-' + (session.dayType || 'a').toLowerCase()" x-text="session.dayType || '?'"></div>
              <div class="flex-1">
                <div class="text-sm" x-text="formatDate(session.date)"></div>
                <div class="text-xs text-slate-500">
                  <span x-text="session.ubicacion === 'casa' ? 'üè†' : 'üèãÔ∏è'"></span>
                  <span x-text="session.completedExercises + '/' + session.totalExercises"></span>
                </div>
              </div>
              <span class="text-green-500" x-show="session.completed">‚úì</span>
            </div>
          </template>
        </div>
      </div>
      
    </div>
  </div>

  <!-- ==================== MODALES ==================== -->
  
  <!-- Check-in Modal -->
  <div x-show="showCheckinModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-end" @click.self="showCheckinModal = false">
    <div class="bg-white w-full rounded-t-2xl p-6 safe-bottom max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-semibold mb-6">¬øC√≥mo est√°s hoy?</h2>
      
      <div class="space-y-6">
        <!-- Tiempo disponible -->
        <div>
          <label class="text-sm font-medium mb-3 block">¬øCu√°nto tiempo tienes?</label>
          <div class="flex gap-2">
            <button @click="checkinForm.tiempo = 20" class="time-btn" :class="{ 'selected': checkinForm.tiempo === 20 }">
              <div class="font-bold">20</div>
              <div class="text-xs text-slate-500">min</div>
            </button>
            <button @click="checkinForm.tiempo = 30" class="time-btn" :class="{ 'selected': checkinForm.tiempo === 30 }">
              <div class="font-bold">30</div>
              <div class="text-xs text-slate-500">min</div>
            </button>
            <button @click="checkinForm.tiempo = 45" class="time-btn" :class="{ 'selected': checkinForm.tiempo === 45 }">
              <div class="font-bold">45</div>
              <div class="text-xs text-slate-500">min</div>
            </button>
            <button @click="checkinForm.tiempo = 60" class="time-btn" :class="{ 'selected': checkinForm.tiempo === 60 }">
              <div class="font-bold">60</div>
              <div class="text-xs text-slate-500">min</div>
            </button>
            <button @click="checkinForm.tiempo = 90" class="time-btn" :class="{ 'selected': checkinForm.tiempo === 90 }">
              <div class="font-bold">90</div>
              <div class="text-xs text-slate-500">min</div>
            </button>
          </div>
        </div>
        
        <!-- Estado general -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">Estado general</label>
            <span class="text-2xl" x-text="getStateEmoji(checkinForm.estado)"></span>
          </div>
          <input type="range" class="slider" min="1" max="5" x-model.number="checkinForm.estado">
        </div>
        
        <!-- Dolor rodilla -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">Dolor rodilla</label>
            <span class="mono text-sm" x-text="checkinForm.dolorRodilla + '/10'"></span>
          </div>
          <input type="range" class="slider" min="0" max="10" x-model.number="checkinForm.dolorRodilla">
        </div>
        
        <!-- Dolor cuello -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">Dolor cuello</label>
            <span class="mono text-sm" x-text="checkinForm.dolorCuello + '/10'"></span>
          </div>
          <input type="range" class="slider" min="0" max="10" x-model.number="checkinForm.dolorCuello">
        </div>
        
        <!-- Gym saturado (solo si es gym) -->
        <template x-if="checkinForm.ubicacion === 'gym'">
          <div class="flex items-center justify-between">
            <div>
              <label class="text-sm">Gym saturado</label>
              <p class="text-xs text-slate-500">Priorizar√© peso libre</p>
            </div>
            <div class="toggle" :class="{ 'active': checkinForm.gymSaturado }" @click="checkinForm.gymSaturado = !checkinForm.gymSaturado"></div>
          </div>
        </template>
      </div>
      
      <button @click="submitCheckin()" class="btn btn-primary w-full mt-6">Guardar</button>
    </div>
  </div>
  
  <!-- Timer Modal -->
  <div x-show="showTimerModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center" @click.self="stopTimer()">
    <div class="bg-white rounded-2xl text-center p-8 mx-4 shadow-xl">
      <p class="text-slate-500 mb-4">Descanso</p>
      <div class="relative w-48 h-48 mx-auto mb-4">
        <svg class="progress-ring w-full h-full" viewBox="0 0 100 100">
          <circle class="bg" cx="50" cy="50" r="45"/>
          <circle class="progress" cx="50" cy="50" r="45" :stroke-dasharray="283" :stroke-dashoffset="283 - (283 * timerProgress / 100)"/>
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span class="timer-display" :class="{ 'text-green-600': timerSeconds === 0 }" x-text="formatTimer(timerSeconds)"></span>
        </div>
      </div>
      <div class="flex gap-3 justify-center">
        <button @click="addTimerSeconds(-15)" class="btn btn-secondary btn-sm">-15s</button>
        <button @click="stopTimer()" class="btn btn-primary btn-sm px-6">OK</button>
        <button @click="addTimerSeconds(15)" class="btn btn-secondary btn-sm">+15s</button>
      </div>
    </div>
  </div>
  
  <!-- Pain Modal -->
  <div x-show="showPainModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" @click.self="showPainModal = false">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">¬øQu√© te duele?</h2>
      <div class="space-y-2">
        <button @click="handlePain('rodilla')" class="btn btn-secondary w-full justify-start">ü¶µ Rodilla</button>
        <button @click="handlePain('cuello')" class="btn btn-secondary w-full justify-start">ü¶¥ Cuello</button>
        <button @click="handlePain('espalda')" class="btn btn-secondary w-full justify-start">üîô Espalda baja</button>
        <button @click="handlePain('hombro')" class="btn btn-secondary w-full justify-start">üí™ Hombro</button>
      </div>
      <button @click="showPainModal = false" class="btn btn-secondary w-full mt-4">Cancelar</button>
    </div>
  </div>
  
  <!-- Postponed Modal -->
  <div x-show="showPostponedModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-end" @click.self="showPostponedModal = false">
    <div class="bg-white w-full rounded-t-2xl p-6 safe-bottom max-h-[70vh] overflow-y-auto">
      <h2 class="text-xl font-semibold mb-4">‚è≥ Ejercicios pospuestos</h2>
      <div class="space-y-3">
        <template x-for="ex in getPostponedExercises()" :key="ex.id">
          <div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg">
            <div>
              <div class="font-medium" x-text="ex.name"></div>
              <div class="text-sm text-slate-500" x-text="ex.prescription"></div>
            </div>
            <button @click="restoreFromModal(ex)" class="btn btn-sm btn-primary">
              Hacer ahora
            </button>
          </div>
        </template>
      </div>
      <button @click="showPostponedModal = false" class="btn btn-secondary w-full mt-4">Cerrar</button>
    </div>
  </div>
  
  <!-- Cancel Session Modal -->
  <div x-show="showCancelModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" @click.self="showCancelModal = false">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-2">¬øCancelar sesi√≥n?</h2>
      <p class="text-sm text-slate-500 mb-4">Se perder√° el progreso de esta sesi√≥n.</p>
      <div class="space-y-2">
        <button @click="cancelSession()" class="btn btn-danger w-full">S√≠, cancelar</button>
        <button @click="showCancelModal = false" class="btn btn-secondary w-full">Continuar entrenando</button>
      </div>
    </div>
  </div>
  
  <!-- Finish Confirmation Modal -->
  <div x-show="showFinishModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" @click.self="showFinishModal = false">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-2">¬øFinalizar sesi√≥n?</h2>
      <template x-if="getIncompleteCount() > 0">
        <div class="info-box warning mb-4">
          <span>Tienes <strong x-text="getIncompleteCount()"></strong> ejercicios sin completar</span>
        </div>
      </template>
      <template x-if="getPostponedExercises().length > 0">
        <div class="info-box warning mb-4">
          <span>Tienes <strong x-text="getPostponedExercises().length"></strong> ejercicios pospuestos</span>
        </div>
      </template>
      <div class="space-y-2">
        <button @click="finishSession()" class="btn btn-primary w-full">S√≠, finalizar</button>
        <button @click="showFinishModal = false" class="btn btn-secondary w-full">Seguir entrenando</button>
      </div>
    </div>
  </div>
  
  <!-- Backup Modal -->
  <div x-show="showBackupModal" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4" @click.self="showBackupModal = false">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-2">Backup</h2>
      <template x-if="needsBackupReminder()">
        <div class="info-box warning mb-4">
          <span class="text-sm">‚ö†Ô∏è Llevas <span x-text="profile.sessionsSinceBackup"></span> sesiones sin backup</span>
        </div>
      </template>
      <div class="space-y-3">
        <button @click="exportData()" class="btn btn-primary w-full">üì§ Exportar datos</button>
        <label class="btn btn-secondary w-full cursor-pointer">
          üì• Importar datos
          <input type="file" accept=".json" @change="importData($event)" class="hidden">
        </label>
      </div>
      <button @click="showBackupModal = false" class="btn btn-secondary w-full mt-4">Cerrar</button>
    </div>
  </div>
  
  <!-- Backup Reminder Modal -->
  <div x-show="showBackupReminder" x-transition class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-2">üíæ ¬øHacer backup?</h2>
      <p class="text-sm text-slate-600 mb-4">Llevas <span x-text="profile.sessionsSinceBackup"></span> sesiones sin guardar.</p>
      <div class="space-y-2">
        <button @click="exportData(); showBackupReminder = false" class="btn btn-primary w-full">S√≠, exportar</button>
        <button @click="showBackupReminder = false" class="btn btn-secondary w-full">Recordar despu√©s</button>
      </div>
    </div>
  </div>

  <!-- ==================== NAVEGACI√ìN ==================== -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 safe-bottom z-30">
    <div class="flex justify-around py-2">
      <button @click="currentScreen = 'home'" class="flex flex-col items-center py-2 px-4" :class="currentScreen === 'home' ? 'text-green-600' : 'text-slate-400'">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span class="text-xs mt-1">Hoy</span>
      </button>
      <button @click="currentScreen = 'settings'" class="flex flex-col items-center py-2 px-4" :class="currentScreen === 'settings' ? 'text-green-600' : 'text-slate-400'">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span class="text-xs mt-1">Ajustes</span>
      </button>
      <button @click="currentScreen = 'stats'" class="flex flex-col items-center py-2 px-4" :class="currentScreen === 'stats' ? 'text-green-600' : 'text-slate-400'">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        <span class="text-xs mt-1">Stats</span>
      </button>
    </div>
  </nav>

  <script>
    const APP_VERSION = '4.1';
    
    // ============================================
    // BIBLIOTECA DE EJERCICIOS
    // ============================================
    const EJERCICIOS = {
      // WARMUP (sin equipo)
      'respiracion': { id: 'respiracion', name: 'Respiraci√≥n diafragm√°tica', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      'cat-cow': { id: 'cat-cow', name: 'Cat-Cow', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['bird-dog'] },
      'wall-slides': { id: 'wall-slides', name: 'Wall slides', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      'bird-dog': { id: 'bird-dog', name: 'Bird-Dog', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      'puente-gluteo': { id: 'puente-gluteo', name: 'Puente de gl√∫teo', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      
      // ========== POTENCIA GYM ==========
      'remo-polea-potencia': { id: 'remo-polea-potencia', name: 'Remo en polea (explosivo)', patron: 'potencia', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['remo-banda-potencia'], soloGym: true },
      'jalon-potencia': { id: 'jalon-potencia', name: 'Jal√≥n polea (explosivo)', patron: 'potencia', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['dominadas-explosivas'], soloGym: true },
      'prensa-potencia': { id: 'prensa-potencia', name: 'Prensa (explosiva)', patron: 'potencia', requiereEquipo: ['prensa'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-goblet-potencia'], soloGym: true },
      
      // ========== POTENCIA CASA ==========
      'remo-banda-potencia': { id: 'remo-banda-potencia', name: 'Remo con banda (explosivo)', patron: 'potencia', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      'dominadas-explosivas': { id: 'dominadas-explosivas', name: 'Dominadas explosivas', patron: 'potencia', requiereEquipo: ['barraDominadas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['remo-banda-potencia'], soloCasa: true },
      'sentadilla-goblet-potencia': { id: 'sentadilla-goblet-potencia', name: 'Sentadilla goblet (explosiva)', patron: 'potencia', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-peso-corporal'], soloCasa: true },
      'sentadilla-peso-corporal': { id: 'sentadilla-peso-corporal', name: 'Sentadilla explosiva', patron: 'potencia', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      
      // ========== FUERZA - TIR√ìN ==========
      'remo-mancuerna': { id: 'remo-mancuerna', name: 'Remo con mancuerna', patron: 'tiron', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['remo-banda'] },
      'remo-polea': { id: 'remo-polea', name: 'Remo en polea', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['remo-mancuerna', 'remo-banda'], soloGym: true },
      'remo-banda': { id: 'remo-banda', name: 'Remo con banda', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      'jalon-polea': { id: 'jalon-polea', name: 'Jal√≥n en polea', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['dominadas', 'jalon-banda'], soloGym: true },
      'dominadas': { id: 'dominadas', name: 'Dominadas', patron: 'tiron', requiereEquipo: ['barraDominadas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['jalon-banda'] },
      'jalon-banda': { id: 'jalon-banda', name: 'Jal√≥n con banda', patron: 'tiron', requiereEquipo: ['bandas', 'barraDominadas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      'face-pull-polea': { id: 'face-pull-polea', name: 'Face Pull', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['face-pull-banda'], soloGym: true },
      'face-pull-banda': { id: 'face-pull-banda', name: 'Face Pull con banda', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['band-pull-apart'], soloCasa: true },
      'band-pull-apart': { id: 'band-pull-apart', name: 'Band Pull-Apart', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      
      // ========== FUERZA - BISAGRA ==========
      'rdl-mancuernas': { id: 'rdl-mancuernas', name: 'RDL con mancuernas', patron: 'bisagra', requiereEquipo: ['mancuernas'], riesgoRodilla: 1, riesgoCuello: 1, sustitutos: ['rdl-banda', 'puente-peso'] },
      'rdl-banda': { id: 'rdl-banda', name: 'RDL con banda', patron: 'bisagra', requiereEquipo: ['bandas'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['puente-gluteo'], soloCasa: true },
      'curl-femoral': { id: 'curl-femoral', name: 'Curl femoral', patron: 'bisagra', requiereEquipo: ['maquina'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['curl-femoral-banda'], soloGym: true },
      'curl-femoral-banda': { id: 'curl-femoral-banda', name: 'Curl femoral con banda', patron: 'bisagra', requiereEquipo: ['bandas'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      'puente-peso': { id: 'puente-peso', name: 'Puente gl√∫teo con peso', patron: 'bisagra', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['puente-gluteo'] },
      
      // ========== FUERZA - SENTADILLA ==========
      'sentadilla-goblet': { id: 'sentadilla-goblet', name: 'Sentadilla Goblet', patron: 'sentadilla', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-cuerpo'] },
      'sentadilla-cuerpo': { id: 'sentadilla-cuerpo', name: 'Sentadilla a caja', patron: 'sentadilla', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [] },
      'prensa': { id: 'prensa', name: 'Prensa', patron: 'sentadilla', requiereEquipo: ['prensa'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-goblet'], soloGym: true },
      'split-squat': { id: 'split-squat', name: 'Split Squat', patron: 'sentadilla', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['step-up'] },
      'step-up': { id: 'step-up', name: 'Step-up', patron: 'sentadilla', requiereEquipo: ['step'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['sentadilla-cuerpo'] },
      
      // ========== FUERZA - EMPUJE ==========
      'press-mancuernas': { id: 'press-mancuernas', name: 'Press mancuernas', patron: 'empuje', requiereEquipo: ['mancuernas', 'banco'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['press-suelo', 'flexiones'] },
      'press-suelo': { id: 'press-suelo', name: 'Press en suelo', patron: 'empuje', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['flexiones'] },
      'flexiones': { id: 'flexiones', name: 'Flexiones', patron: 'empuje', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: [] },
      'elevaciones-laterales': { id: 'elevaciones-laterales', name: 'Elevaciones laterales', patron: 'empuje', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['elevaciones-banda'] },
      'elevaciones-banda': { id: 'elevaciones-banda', name: 'Elevaciones con banda', patron: 'empuje', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true },
      
      // ========== CORE ==========
      'pallof-polea': { id: 'pallof-polea', name: 'Pallof Press', patron: 'core', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['pallof-banda'], soloGym: true },
      'pallof-banda': { id: 'pallof-banda', name: 'Pallof con banda', patron: 'core', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['plancha-lateral'], soloCasa: true },
      'plancha-lateral': { id: 'plancha-lateral', name: 'Plancha lateral', patron: 'core', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      'dead-bug': { id: 'dead-bug', name: 'Dead Bug', patron: 'core', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] },
      'rueda-abdominal': { id: 'rueda-abdominal', name: 'Rueda abdominal', patron: 'core', requiereEquipo: ['ruedaAbdominal'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['dead-bug'] },
      
      // ========== CARDIO ==========
      'bicicleta': { id: 'bicicleta', name: 'Bicicleta', patron: 'cardio', requiereEquipo: ['bicicleta'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['cinta', 'remo-ergometro'], soloGym: true },
      'cinta': { id: 'cinta', name: 'Cinta inclinada', patron: 'cardio', requiereEquipo: ['cinta'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['bicicleta'], soloGym: true },
      'remo-ergometro': { id: 'remo-ergometro', name: 'Remo erg√≥metro', patron: 'cardio', requiereEquipo: ['remo'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['bicicleta'], soloGym: true },
      'escaleras': { id: 'escaleras', name: 'Subir/bajar escaleras', patron: 'cardio', requiereEquipo: ['escaleras'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['marcha-sitio'], soloCasa: true },
      'saltar-cuerda': { id: 'saltar-cuerda', name: 'Saltar cuerda', patron: 'cardio', requiereEquipo: ['cuerda'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['jumping-jacks'] },
      'jumping-jacks': { id: 'jumping-jacks', name: 'Jumping Jacks', patron: 'cardio', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['marcha-sitio'] },
      'marcha-sitio': { id: 'marcha-sitio', name: 'Marcha en el sitio', patron: 'cardio', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [] }
    };

    // ============================================
    // APP
    // ============================================
    function app() {
      return {
        currentScreen: 'home',
        screenTitles: { home: 'Entrenamiento', settings: 'Ajustes', stats: 'Estad√≠sticas' },
        
        // Modals
        showCheckinModal: false,
        showTimerModal: false,
        showPainModal: false,
        showBackupModal: false,
        showBackupReminder: false,
        showPostponedModal: false,
        showCancelModal: false,
        showFinishModal: false,
        showPreview: false,
        
        // Timer
        timerSeconds: 0,
        timerTotal: 0,
        timerProgress: 100,
        timerInterval: null,
        
        // Profile
        profile: {
          problemasCuello: true,
          tendinopatiaRodilla: true,
          umbralRodilla: 5,
          umbralCuello: 4,
          descansoPotencia: 120,
          descansoFuerza: 90,
          descansoResistencia: 45,
          autoBackup: false,
          sessionsSinceBackup: 0,
          lastBackupDate: null
        },
        
        // Material en casa
        materialCasa: {
          mancuernas: { tiene: false, pesoConfig: true, pesos: '' },
          bandas: { tiene: false, pesoConfig: false },
          barraDominadas: { tiene: false, pesoConfig: false },
          trx: { tiene: false, pesoConfig: false },
          kettlebell: { tiene: false, pesoConfig: true, pesos: '' },
          miniBandas: { tiene: false, pesoConfig: false },
          ruedaAbdominal: { tiene: false, pesoConfig: false },
          cuerda: { tiene: false, pesoConfig: false },
          banco: { tiene: false, pesoConfig: false },
          step: { tiene: false, pesoConfig: false },
          escaleras: { tiene: false, pesoConfig: false }
        },
        
        materialNames: {
          mancuernas: 'Mancuernas',
          bandas: 'Bandas el√°sticas',
          barraDominadas: 'Barra dominadas',
          trx: 'TRX / Anillas',
          kettlebell: 'Kettlebell',
          miniBandas: 'Mini bandas',
          ruedaAbdominal: 'Rueda abdominal',
          cuerda: 'Cuerda de saltar',
          banco: 'Banco',
          step: 'Step / Caj√≥n',
          escaleras: 'Escaleras en casa'
        },
        
        // Check-in
        checkinForm: { ubicacion: null, tiempo: 45, estado: 3, dolorRodilla: 0, dolorCuello: 0, gymSaturado: false },
        todayCheckin: null,
        
        // D√≠a
        nextDayType: 'A',
        
        // Sesi√≥n
        currentSession: null,
        recentSessions: [],
        
        // Hist√≥rico de pesos
        exerciseHistory: {},
        
        // M√©tricas
        metrics: { peso: null, cintura: null },
        weekDays: [],
        weeklyStats: { completed: 0 },
        
        // ==================== INIT ====================
        init() {
          this.loadAllData();
          this.checkTodayCheckin();
          this.calculateNextDay();
          this.calculateWeekDays();
          this.calculateStats();
        },
        
        loadAllData() {
          const keys = ['profile', 'materialCasa', 'recentSessions', 'nextDayType', 'currentSession', 'metrics', 'exerciseHistory'];
          keys.forEach(key => {
            const data = localStorage.getItem('coach_' + key);
            if (data) {
              try {
                const parsed = JSON.parse(data);
                if (typeof this[key] === 'object' && !Array.isArray(this[key])) {
                  this[key] = { ...this[key], ...parsed };
                } else {
                  this[key] = parsed;
                }
              } catch(e) {}
            }
          });
          
          const todayData = localStorage.getItem('coach_todayCheckin');
          if (todayData) {
            try {
              const parsed = JSON.parse(todayData);
              if (new Date(parsed.date).toDateString() === new Date().toDateString()) {
                this.todayCheckin = parsed;
              }
            } catch(e) {}
          }
        },
        
        saveProfile() { localStorage.setItem('coach_profile', JSON.stringify(this.profile)); },
        saveMaterial() { localStorage.setItem('coach_materialCasa', JSON.stringify(this.materialCasa)); },
        saveNextDay() { localStorage.setItem('coach_nextDayType', JSON.stringify(this.nextDayType)); },
        saveSessions() { localStorage.setItem('coach_recentSessions', JSON.stringify(this.recentSessions)); },
        saveSession() { if (this.currentSession) localStorage.setItem('coach_currentSession', JSON.stringify(this.currentSession)); },
        saveMetrics() { localStorage.setItem('coach_metrics', JSON.stringify(this.metrics)); },
        saveExerciseHistory() { localStorage.setItem('coach_exerciseHistory', JSON.stringify(this.exerciseHistory)); },
        
        // ==================== MATERIAL ====================
        tieneMaterialCasa() {
          return Object.values(this.materialCasa).some(m => m.tiene);
        },
        
        tieneEquipo(equipoList, esCasa) {
          if (!equipoList || equipoList.length === 0) return true;
          
          if (esCasa) {
            return equipoList.every(eq => this.materialCasa[eq]?.tiene);
          }
          return true; // Gym tiene todo
        },
        
        // ==================== CHECK-IN ====================
        checkTodayCheckin() {
          const todayData = localStorage.getItem('coach_todayCheckin');
          if (todayData) {
            try {
              const parsed = JSON.parse(todayData);
              if (new Date(parsed.date).toDateString() === new Date().toDateString()) {
                this.todayCheckin = parsed;
              }
            } catch(e) {}
          }
        },
        
        submitCheckin() {
          this.todayCheckin = {
            date: new Date().toISOString(),
            ...this.checkinForm
          };
          localStorage.setItem('coach_todayCheckin', JSON.stringify(this.todayCheckin));
          this.showCheckinModal = false;
        },
        
        resetCheckin() {
          this.todayCheckin = null;
          this.checkinForm = { ubicacion: null, tiempo: 45, estado: 3, dolorRodilla: 0, dolorCuello: 0, gymSaturado: false };
          localStorage.removeItem('coach_todayCheckin');
        },
        
        getStateEmoji(state) { return ['', 'üò´', 'üòî', 'üòê', 'üôÇ', 'üí™'][state] || 'üòê'; },
        
        // ==================== D√çAS ====================
        calculateNextDay() {
          if (this.recentSessions.length === 0) {
            this.nextDayType = 'A';
            return;
          }
          const last = this.recentSessions[0];
          const rotation = { 'A': 'B', 'B': 'C', 'C': 'A' };
          this.nextDayType = rotation[last.dayType] || 'A';
        },
        
        getDayTitle(day) {
          return { 'A': 'Tir√≥n + Posterior', 'B': 'Pierna + Empuje', 'C': 'Espalda completa' }[day];
        },
        
        // ==================== PREVIEW Y VALIDACI√ìN ====================
        getPreviewBlocks() {
          if (!this.todayCheckin) return [];
          return this.buildBlocks(true);
        },
        
        getPreviewExerciseCount() {
          const blocks = this.getPreviewBlocks();
          let count = 0;
          blocks.forEach(b => count += b.exercises.length);
          return count;
        },
        
        getEstimatedDuration() {
          const blocks = this.getPreviewBlocks();
          let totalSets = 0;
          let restTotal = 0;
          
          blocks.forEach(b => {
            b.exercises.forEach(e => {
              const sets = parseInt(e.prescription.match(/(\d+)x/)?.[1] || 2);
              totalSets += sets;
              restTotal += (e.restTime || 60) * sets;
            });
          });
          
          const workTime = totalSets * 45; // 45s por set
          const warmup = 5 * 60;
          const total = warmup + workTime + restTotal;
          return Math.round(total / 60);
        },
        
        isSessionValid() {
          const blocks = this.getPreviewBlocks();
          const mainBlocks = blocks.filter(b => ['potencia', 'fuerza', 'resistencia'].includes(b.tipo));
          
          // Al menos 3 ejercicios principales
          let mainExercises = 0;
          mainBlocks.forEach(b => mainExercises += b.exercises.length);
          
          return mainExercises >= 3;
        },
        
        getSessionError() {
          if (!this.todayCheckin) return '';
          
          if (this.todayCheckin.ubicacion === 'casa' && !this.tieneMaterialCasa()) {
            return 'Configura tu material en casa en Ajustes.';
          }
          
          const blocks = this.getPreviewBlocks();
          const emptyBlocks = blocks.filter(b => b.tipo && b.exercises.length === 0);
          
          if (emptyBlocks.length > 0) {
            return `Faltan ejercicios para: ${emptyBlocks.map(b => b.name).join(', ')}. Revisa tu material.`;
          }
          
          return 'No hay suficientes ejercicios disponibles.';
        },
        
        // ==================== GENERAR SESI√ìN ====================
        buildBlocks(isPreview = false) {
          const day = this.nextDayType;
          const c = this.todayCheckin;
          if (!c) return [];
          
          const esCasa = c.ubicacion === 'casa';
          const tiempo = c.tiempo;
          const gymSaturado = c.gymSaturado;
          const dolorRodilla = c.dolorRodilla >= this.profile.umbralRodilla;
          const dolorCuello = c.dolorCuello >= this.profile.umbralCuello;
          
          let blocks = [];
          
          // Warmup (siempre si tiempo >= 20)
          if (tiempo >= 20) {
            blocks.push({
              name: 'Calentamiento',
              exercises: [
                this.makeExercise('respiracion', '5 respiraciones', esCasa, false),
                this.makeExercise('cat-cow', '10 reps', esCasa, false),
                this.makeExercise('wall-slides', '10 reps', esCasa, false),
                this.makeExercise('puente-gluteo', '10 reps', esCasa, false)
              ].filter(e => e)
            });
          }
          
          // Bloques principales seg√∫n d√≠a
          if (day === 'A') {
            blocks = blocks.concat(this.buildDayA(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello));
          } else if (day === 'B') {
            blocks = blocks.concat(this.buildDayB(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello));
          } else {
            blocks = blocks.concat(this.buildDayC(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello));
          }
          
          // Core (si tiempo >= 30)
          if (tiempo >= 30) {
            const coreEx = esCasa 
              ? (this.tieneEquipo(['bandas'], true) ? 'pallof-banda' : 'plancha-lateral')
              : 'pallof-polea';
            
            const coreExercises = [this.makeExercise(coreEx, '2x10 cada lado', esCasa, false)];
            if (tiempo >= 45) {
              coreExercises.push(this.makeExercise('dead-bug', '2x10 cada lado', esCasa, false));
            }
            
            blocks.push({
              name: 'Core',
              exercises: coreExercises.filter(e => e)
            });
          }
          
          // Cardio (si tiempo >= 45) - con alternativas visibles
          if (tiempo >= 45) {
            const cardioTime = tiempo >= 60 ? '10-15 min Z2' : '8 min Z2';
            const cardioOptions = [];
            
            if (esCasa) {
              // Orden de preferencia para casa
              if (this.tieneEquipo(['escaleras'], true)) {
                cardioOptions.push({ id: 'escaleras', name: 'Subir/bajar escaleras' });
              }
              if (this.tieneEquipo(['cuerda'], true) && !dolorRodilla) {
                cardioOptions.push({ id: 'saltar-cuerda', name: 'Saltar cuerda' });
              }
              if (!dolorRodilla) {
                cardioOptions.push({ id: 'jumping-jacks', name: 'Jumping Jacks' });
              }
              cardioOptions.push({ id: 'marcha-sitio', name: 'Marcha en el sitio' });
            } else {
              // Gym: todas las m√°quinas
              cardioOptions.push({ id: 'bicicleta', name: 'Bicicleta' });
              if (!dolorRodilla) {
                cardioOptions.push({ id: 'cinta', name: 'Cinta inclinada' });
              }
              cardioOptions.push({ id: 'remo-ergometro', name: 'Remo erg√≥metro' });
            }
            
            // Crear ejercicio principal con alternativas
            if (cardioOptions.length > 0) {
              const mainEx = this.makeExercise(cardioOptions[0].id, cardioTime, esCasa, false);
              if (mainEx) {
                mainEx.showSubs = true;
                mainEx.substitutes = cardioOptions.slice(1).map(o => o.name);
                
                blocks.push({
                  name: 'Cardio Zona 2',
                  instruccion: 'Ritmo conversacional. Elige la opci√≥n que prefieras.',
                  exercises: [mainEx]
                });
              }
            }
          }
          
          return blocks;
        },
        
        buildDayA(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello) {
          const blocks = [];
          
          // Potencia
          let potenciaEx = esCasa 
            ? (this.tieneEquipo(['bandas'], true) ? 'remo-banda-potencia' : null)
            : 'remo-polea-potencia';
          
          if (potenciaEx) {
            blocks.push({
              name: 'Potencia',
              tipo: 'potencia',
              badge: 'üî• Fibras r√°pidas',
              instruccion: 'INTENCI√ìN de velocidad al subir. Baja controlado.',
              exercises: [this.makeExercise(potenciaEx, '2-3x6-8', esCasa, true, 'potencia', gymSaturado)].filter(e => e)
            });
          }
          
          // Fuerza
          const fuerzaExercises = [];
          
          // RDL
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas'], true)) {
              fuerzaExercises.push(this.makeExercise('rdl-mancuernas', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            } else if (this.tieneEquipo(['bandas'], true)) {
              fuerzaExercises.push(this.makeExercise('rdl-banda', '3x12-15', esCasa, true, 'fuerza', gymSaturado));
            }
          } else {
            fuerzaExercises.push(this.makeExercise('rdl-mancuernas', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Jal√≥n
          if (esCasa) {
            if (this.tieneEquipo(['barraDominadas'], true)) {
              fuerzaExercises.push(this.makeExercise('dominadas', '3x m√°x', esCasa, true, 'fuerza', gymSaturado));
            } else if (this.tieneEquipo(['bandas'], true)) {
              fuerzaExercises.push(this.makeExercise('jalon-banda', '3x12-15', esCasa, true, 'fuerza', gymSaturado));
            }
          } else {
            fuerzaExercises.push(this.makeExercise('jalon-polea', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Curl femoral (si tiempo)
          if (tiempo >= 60) {
            if (esCasa && this.tieneEquipo(['bandas'], true)) {
              fuerzaExercises.push(this.makeExercise('curl-femoral-banda', '2x15', esCasa, true, 'fuerza', gymSaturado));
            } else if (!esCasa) {
              fuerzaExercises.push(this.makeExercise('curl-femoral', '2x12', esCasa, true, 'fuerza', gymSaturado));
            }
          }
          
          blocks.push({
            name: 'Fuerza',
            tipo: 'fuerza',
            badge: 'üí™ Hipertrofia',
            instruccion: 'Controlado: 2s subida, 2s bajada.',
            exercises: fuerzaExercises.filter(e => e)
          });
          
          // Resistencia
          let resistEx = esCasa
            ? (this.tieneEquipo(['bandas'], true) ? 'face-pull-banda' : 'band-pull-apart')
            : 'face-pull-polea';
          
          // Si no tiene bandas en casa, no hay ejercicio de resistencia de tir√≥n
          if (esCasa && !this.tieneEquipo(['bandas'], true)) {
            resistEx = null;
          }
          
          if (resistEx) {
            blocks.push({
              name: 'Resistencia',
              tipo: 'resistencia',
              badge: 'üîÑ Fibras lentas',
              instruccion: 'Tempo lento, siente el m√∫sculo.',
              exercises: [this.makeExercise(resistEx, '2x15-20', esCasa, true, 'resistencia', gymSaturado)].filter(e => e)
            });
          }
          
          return blocks;
        },
        
        buildDayB(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello) {
          const blocks = [];
          
          // Potencia (evitar si dolor rodilla alto)
          let potenciaEx = null;
          if (!dolorRodilla) {
            if (esCasa) {
              if (this.tieneEquipo(['mancuernas'], true)) {
                potenciaEx = 'sentadilla-goblet-potencia';
              } else {
                potenciaEx = 'sentadilla-peso-corporal';
              }
            } else {
              potenciaEx = 'prensa-potencia';
            }
          } else {
            // Si hay dolor rodilla, hacer potencia de tren superior
            potenciaEx = esCasa 
              ? (this.tieneEquipo(['bandas'], true) ? 'remo-banda-potencia' : null)
              : 'jalon-potencia';
          }
          
          if (potenciaEx) {
            blocks.push({
              name: 'Potencia',
              tipo: 'potencia',
              badge: 'üî• Fibras r√°pidas',
              instruccion: 'INTENCI√ìN de velocidad al subir. Baja controlado.',
              exercises: [this.makeExercise(potenciaEx, '2-3x6-8', esCasa, true, 'potencia', gymSaturado)].filter(e => e)
            });
          }
          
          // Fuerza
          const fuerzaExercises = [];
          
          // Sentadilla
          if (!dolorRodilla || dolorRodilla) {
            const squatEx = dolorRodilla ? 'sentadilla-cuerpo' : 
              (esCasa ? (this.tieneEquipo(['mancuernas'], true) ? 'sentadilla-goblet' : 'sentadilla-cuerpo') : 'sentadilla-goblet');
            fuerzaExercises.push(this.makeExercise(squatEx, '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Split squat (si tiempo y no dolor)
          if (tiempo >= 60 && !dolorRodilla) {
            if (this.tieneEquipo(['mancuernas'], esCasa) || !esCasa) {
              fuerzaExercises.push(this.makeExercise('split-squat', '2x10 cada', esCasa, true, 'fuerza', gymSaturado));
            }
          }
          
          // Press
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas', 'banco'], true)) {
              fuerzaExercises.push(this.makeExercise('press-mancuernas', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            } else if (this.tieneEquipo(['mancuernas'], true)) {
              fuerzaExercises.push(this.makeExercise('press-suelo', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            } else {
              fuerzaExercises.push(this.makeExercise('flexiones', '3x m√°x', esCasa, true, 'fuerza', gymSaturado));
            }
          } else {
            fuerzaExercises.push(this.makeExercise('press-mancuernas', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Remo (mantener frecuencia tir√≥n)
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas'], true)) {
              fuerzaExercises.push(this.makeExercise('remo-mancuerna', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            } else if (this.tieneEquipo(['bandas'], true)) {
              fuerzaExercises.push(this.makeExercise('remo-banda', '3x12-15', esCasa, true, 'fuerza', gymSaturado));
            }
          } else {
            fuerzaExercises.push(this.makeExercise('remo-mancuerna', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          blocks.push({
            name: 'Fuerza',
            tipo: 'fuerza',
            badge: 'üí™ Hipertrofia',
            instruccion: 'Controlado: 2s subida, 2s bajada.',
            exercises: fuerzaExercises.filter(e => e)
          });
          
          // Resistencia
          let resistEx = esCasa
            ? (this.tieneEquipo(['mancuernas'], true) ? 'elevaciones-laterales' : 
               (this.tieneEquipo(['bandas'], true) ? 'elevaciones-banda' : null))
            : 'elevaciones-laterales';
          
          if (resistEx) {
            blocks.push({
              name: 'Resistencia',
              tipo: 'resistencia',
              badge: 'üîÑ Fibras lentas',
              instruccion: 'Tempo lento, siente el m√∫sculo.',
              exercises: [this.makeExercise(resistEx, '2x15-20', esCasa, true, 'resistencia', gymSaturado)].filter(e => e)
            });
          }
          
          return blocks;
        },
        
        buildDayC(esCasa, tiempo, gymSaturado, dolorRodilla, dolorCuello) {
          const blocks = [];
          
          // Potencia
          let potenciaEx = esCasa 
            ? (this.tieneEquipo(['barraDominadas'], true) ? 'dominadas-explosivas' : 
               (this.tieneEquipo(['bandas'], true) ? 'remo-banda-potencia' : null))
            : 'jalon-potencia';
          
          if (potenciaEx) {
            blocks.push({
              name: 'Potencia',
              tipo: 'potencia',
              badge: 'üî• Fibras r√°pidas',
              instruccion: 'INTENCI√ìN de velocidad al subir. Baja controlado.',
              exercises: [this.makeExercise(potenciaEx, '2-3x6-8', esCasa, true, 'potencia', gymSaturado)].filter(e => e)
            });
          }
          
          // Fuerza - Alto volumen espalda
          const fuerzaExercises = [];
          
          // Remo 1
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas'], true)) {
              fuerzaExercises.push(this.makeExercise('remo-mancuerna', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            } else if (this.tieneEquipo(['bandas'], true)) {
              fuerzaExercises.push(this.makeExercise('remo-banda', '3x12-15', esCasa, true, 'fuerza', gymSaturado));
            }
          } else {
            fuerzaExercises.push(this.makeExercise('remo-mancuerna', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Remo 2 (variante)
          if (!esCasa) {
            fuerzaExercises.push(this.makeExercise('remo-polea', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          // Jal√≥n (si tiempo)
          if (tiempo >= 45) {
            if (esCasa) {
              if (this.tieneEquipo(['barraDominadas'], true)) {
                fuerzaExercises.push(this.makeExercise('dominadas', '3x m√°x', esCasa, true, 'fuerza', gymSaturado));
              }
            } else {
              fuerzaExercises.push(this.makeExercise('jalon-polea', '3x10-12', esCasa, true, 'fuerza', gymSaturado));
            }
          }
          
          // RDL
          if (this.tieneEquipo(['mancuernas'], esCasa) || !esCasa) {
            fuerzaExercises.push(this.makeExercise('rdl-mancuernas', '2x12', esCasa, true, 'fuerza', gymSaturado));
          }
          
          blocks.push({
            name: 'Fuerza',
            tipo: 'fuerza',
            badge: 'üí™ Hipertrofia',
            instruccion: 'Controlado: 2s subida, 2s bajada.',
            exercises: fuerzaExercises.filter(e => e)
          });
          
          // Resistencia
          const resistExercises = [];
          
          if (esCasa && this.tieneEquipo(['bandas'], true)) {
            resistExercises.push(this.makeExercise('face-pull-banda', '2x15-20', esCasa, true, 'resistencia', gymSaturado));
            resistExercises.push(this.makeExercise('band-pull-apart', '2x20', esCasa, false, 'resistencia', gymSaturado));
          } else if (!esCasa) {
            resistExercises.push(this.makeExercise('face-pull-polea', '2x15-20', esCasa, true, 'resistencia', gymSaturado));
            resistExercises.push(this.makeExercise('band-pull-apart', '2x20', esCasa, false, 'resistencia', gymSaturado));
          }
          
          if (resistExercises.length > 0) {
            blocks.push({
              name: 'Resistencia',
              tipo: 'resistencia',
              badge: 'üîÑ Fibras lentas',
              instruccion: 'Tempo lento, siente el m√∫sculo.',
              exercises: resistExercises.filter(e => e)
            });
          }
          
          return blocks;
        },
        
        generateSession() {
          const blocks = this.buildBlocks(false);
          
          this.currentSession = {
            id: Date.now(),
            date: new Date().toISOString(),
            dayType: this.nextDayType,
            ubicacion: this.todayCheckin.ubicacion,
            tiempo: this.todayCheckin.tiempo,
            blocks: blocks,
            completed: false
          };
          
          this.saveSession();
        },
        
        makeExercise(id, prescription, esCasa, trackSets = false, tipo = null, gymSaturado = false) {
          const ex = EJERCICIOS[id];
          if (!ex) return null;
          
          // Verificar si es solo gym/casa
          if (esCasa && ex.soloGym) return null;
          if (!esCasa && ex.soloCasa) return null;
          
          // Verificar equipo
          if (!this.tieneEquipo(ex.requiereEquipo, esCasa)) {
            // Buscar sustituto
            for (const subId of (ex.sustitutos || [])) {
              const sub = this.makeExercise(subId, prescription, esCasa, trackSets, tipo, gymSaturado);
              if (sub) return sub;
            }
            return null;
          }
          
          // Descanso seg√∫n tipo
          let restTime = null;
          if (tipo === 'potencia') restTime = this.profile.descansoPotencia;
          else if (tipo === 'fuerza') restTime = this.profile.descansoFuerza;
          else if (tipo === 'resistencia') restTime = this.profile.descansoResistencia;
          
          // Calcular sets
          const numSets = parseInt(prescription.match(/(\d+)x/)?.[1] || 2);
          
          // Sustitutos
          const subs = (ex.sustitutos || []).map(s => EJERCICIOS[s]?.name).filter(Boolean);
          
          return {
            id: ex.id,
            name: ex.name,
            prescription: prescription,
            trackSets: trackSets,
            sets: trackSets ? Array(numSets).fill(null).map(() => ({ weight: null, reps: null, rir: null })) : [],
            restTime: restTime,
            substitutes: subs,
            completed: false,
            postponed: false,
            showSubs: gymSaturado,
            esCasa: esCasa && ex.soloCasa
          };
        },
        
        // ==================== √öLTIMO PESO ====================
        getLastWeight(exId) {
          const history = this.exerciseHistory[exId];
          if (!history || history.length === 0) return null;
          return history[history.length - 1];
        },
        
        saveExerciseWeight(exId, weight) {
          if (!weight || weight <= 0) return;
          if (!this.exerciseHistory[exId]) {
            this.exerciseHistory[exId] = [];
          }
          this.exerciseHistory[exId].push(weight);
          // Mantener solo √∫ltimos 20
          if (this.exerciseHistory[exId].length > 20) {
            this.exerciseHistory[exId] = this.exerciseHistory[exId].slice(-20);
          }
          this.saveExerciseHistory();
        },
        
        getTopExercises() {
          const result = {};
          for (const [exId, history] of Object.entries(this.exerciseHistory)) {
            if (history.length >= 2) {
              const ex = EJERCICIOS[exId];
              result[exId] = {
                name: ex?.name || exId,
                history: history,
                maxWeight: Math.max(...history)
              };
            }
          }
          return result;
        },
        
        // ==================== EJERCICIOS ====================
        postponeExercise(blockIdx, exIdx) {
          this.currentSession.blocks[blockIdx].exercises[exIdx].postponed = true;
          this.saveSession();
        },
        
        restoreExercise(blockIdx, exIdx) {
          this.currentSession.blocks[blockIdx].exercises[exIdx].postponed = false;
          this.saveSession();
        },
        
        restoreFromModal(ex) {
          for (let b = 0; b < this.currentSession.blocks.length; b++) {
            for (let e = 0; e < this.currentSession.blocks[b].exercises.length; e++) {
              if (this.currentSession.blocks[b].exercises[e].id === ex.id && 
                  this.currentSession.blocks[b].exercises[e].postponed) {
                this.currentSession.blocks[b].exercises[e].postponed = false;
                break;
              }
            }
          }
          this.saveSession();
          this.showPostponedModal = false;
        },
        
        getPostponedExercises() {
          if (!this.currentSession) return [];
          const postponed = [];
          this.currentSession.blocks.forEach(b => {
            b.exercises.forEach(e => {
              if (e.postponed) postponed.push(e);
            });
          });
          return postponed;
        },
        
        getCompletedCount() {
          if (!this.currentSession) return 0;
          let count = 0;
          this.currentSession.blocks.forEach(b => {
            b.exercises.forEach(e => { if (e.completed) count++; });
          });
          return count;
        },
        
        getTotalCount() {
          if (!this.currentSession) return 0;
          let count = 0;
          this.currentSession.blocks.forEach(b => { count += b.exercises.length; });
          return count;
        },
        
        getIncompleteCount() {
          return this.getTotalCount() - this.getCompletedCount();
        },
        
        toggleComplete(blockIdx, exIdx) {
          const ex = this.currentSession.blocks[blockIdx].exercises[exIdx];
          ex.completed = !ex.completed;
          ex.postponed = false;
          
          // Guardar peso si est√° completo
          if (ex.completed && ex.trackSets && ex.sets) {
            const maxWeight = Math.max(...ex.sets.map(s => s.weight || 0));
            if (maxWeight > 0) {
              this.saveExerciseWeight(ex.id, maxWeight);
            }
          }
          
          this.saveSession();
        },
        
        swapExercise(blockIdx, exIdx, newName) {
          const newEx = Object.values(EJERCICIOS).find(e => e.name === newName);
          if (!newEx || !this.currentSession) return;
          const old = this.currentSession.blocks[blockIdx].exercises[exIdx];
          this.currentSession.blocks[blockIdx].exercises[exIdx] = {
            ...old,
            id: newEx.id,
            name: newEx.name,
            substitutes: (newEx.sustitutos || []).map(s => EJERCICIOS[s]?.name).filter(Boolean),
            showSubs: false
          };
          this.saveSession();
        },
        
        handlePain(area) {
          if (!this.currentSession) return;
          this.currentSession.blocks.forEach(b => {
            b.exercises.forEach(e => {
              const ex = EJERCICIOS[e.id];
              if (!ex) return;
              let flag = false;
              if (area === 'rodilla' && ex.riesgoRodilla >= 2) flag = true;
              if (area === 'cuello' && ex.riesgoCuello >= 2) flag = true;
              if (area === 'espalda' && ex.patron === 'bisagra') flag = true;
              if (area === 'hombro' && ex.patron === 'empuje') flag = true;
              if (flag) e.showSubs = true;
            });
          });
          this.saveSession();
          this.showPainModal = false;
        },
        
        // ==================== FINALIZAR ====================
        confirmFinish() {
          if (this.getIncompleteCount() > 0 || this.getPostponedExercises().length > 0) {
            this.showFinishModal = true;
          } else {
            this.finishSession();
          }
        },
        
        finishSession() {
          if (!this.currentSession) return;
          
          let completed = 0, total = 0;
          this.currentSession.blocks.forEach(b => {
            b.exercises.forEach(e => {
              total++;
              if (e.completed) completed++;
            });
          });
          
          this.recentSessions.unshift({
            date: this.currentSession.date,
            dayType: this.currentSession.dayType,
            ubicacion: this.currentSession.ubicacion,
            tiempo: this.currentSession.tiempo,
            completed: completed >= total * 0.7,
            completedExercises: completed,
            totalExercises: total
          });
          
          this.saveSessions();
          this.calculateNextDay();
          this.saveNextDay();
          localStorage.removeItem('coach_currentSession');
          this.currentSession = null;
          this.resetCheckin();
          this.calculateStats();
          
          // Backup tracking
          this.profile.sessionsSinceBackup = (this.profile.sessionsSinceBackup || 0) + 1;
          this.saveProfile();
          
          this.showFinishModal = false;
          
          // Auto-backup o recordatorio
          if (this.profile.autoBackup) {
            this.exportData();
          } else if (this.profile.sessionsSinceBackup >= 5) {
            this.showBackupReminder = true;
          }
        },
        
        cancelSession() {
          localStorage.removeItem('coach_currentSession');
          this.currentSession = null;
          this.showCancelModal = false;
        },
        
        // ==================== TIMER ====================
        startTimer(seconds) {
          this.timerSeconds = seconds;
          this.timerTotal = seconds;
          this.timerProgress = 100;
          this.showTimerModal = true;
          if (this.timerInterval) clearInterval(this.timerInterval);
          this.timerInterval = setInterval(() => {
            if (this.timerSeconds > 0) {
              this.timerSeconds--;
              this.timerProgress = (this.timerSeconds / this.timerTotal) * 100;
            } else {
              this.timerFinished();
            }
          }, 1000);
        },
        
        timerFinished() {
          clearInterval(this.timerInterval);
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.frequency.value = 800;
            osc.start();
            setTimeout(() => osc.stop(), 200);
          } catch(e) {}
        },
        
        stopTimer() {
          if (this.timerInterval) clearInterval(this.timerInterval);
          this.showTimerModal = false;
        },
        
        addTimerSeconds(s) {
          this.timerSeconds = Math.max(0, this.timerSeconds + s);
          this.timerTotal = Math.max(this.timerTotal, this.timerSeconds);
          this.timerProgress = (this.timerSeconds / this.timerTotal) * 100;
        },
        
        formatTimer(s) {
          return Math.floor(s/60) + ':' + (s%60).toString().padStart(2, '0');
        },
        
        // ==================== STATS ====================
        calculateWeekDays() {
          const days = [];
          const names = ['D','L','M','X','J','V','S'];
          const today = new Date();
          for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            days.push({ date: d.toDateString(), label: names[d.getDay()] });
          }
          this.weekDays = days;
        },
        
        calculateStats() {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - 6);
          this.weeklyStats.completed = this.recentSessions.filter(s => new Date(s.date) >= weekStart).length;
        },
        
        getWorkoutDayClass(day) {
          const s = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          if (!s) return 'bg-slate-200';
          return s.completed ? 'bg-green-500' : 'bg-amber-400';
        },
        
        getWorkoutDayHeight(day) {
          const s = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          return s ? (s.completed ? 50 : 30) : 10;
        },
        
        getTotalCompletedSessions() {
          return this.recentSessions.filter(s => s.completed).length;
        },
        
        getStreakDays() {
          let streak = 0;
          const today = new Date();
          for (let i = 0; i < 30; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            if (this.recentSessions.some(s => new Date(s.date).toDateString() === d.toDateString())) streak++;
            else if (i > 0) break;
          }
          return streak;
        },
        
        formatDate(str) {
          const d = new Date(str);
          const today = new Date();
          if (d.toDateString() === today.toDateString()) return 'Hoy';
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          if (d.toDateString() === yesterday.toDateString()) return 'Ayer';
          return d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        },
        
        // ==================== BACKUP ====================
        needsBackupReminder() {
          return (this.profile.sessionsSinceBackup || 0) >= 5;
        },
        
        getLastBackupDate() {
          if (!this.profile.lastBackupDate) return 'Nunca';
          return new Date(this.profile.lastBackupDate).toLocaleDateString('es-ES');
        },
        
        exportData() {
          const data = {
            version: APP_VERSION,
            date: new Date().toISOString(),
            profile: this.profile,
            materialCasa: this.materialCasa,
            recentSessions: this.recentSessions,
            nextDayType: this.nextDayType,
            metrics: this.metrics,
            exerciseHistory: this.exerciseHistory
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `coach-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          
          this.profile.sessionsSinceBackup = 0;
          this.profile.lastBackupDate = new Date().toISOString();
          this.saveProfile();
          this.showBackupModal = false;
        },
        
        async importData(e) {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const data = JSON.parse(await file.text());
            if (data.profile) { this.profile = { ...this.profile, ...data.profile }; this.saveProfile(); }
            if (data.materialCasa) { this.materialCasa = { ...this.materialCasa, ...data.materialCasa }; this.saveMaterial(); }
            if (data.recentSessions) { this.recentSessions = data.recentSessions; this.saveSessions(); }
            if (data.nextDayType) { this.nextDayType = data.nextDayType; this.saveNextDay(); }
            if (data.metrics) { this.metrics = { ...this.metrics, ...data.metrics }; this.saveMetrics(); }
            if (data.exerciseHistory) { this.exerciseHistory = data.exerciseHistory; this.saveExerciseHistory(); }
            this.calculateStats();
            alert('‚úÖ Datos importados correctamente');
          } catch(err) {
            alert('‚ùå Error: ' + err.message);
          }
          e.target.value = '';
          this.showBackupModal = false;
        },
        
        confirmReset() {
          if (confirm('¬øSeguro que quieres borrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
            localStorage.clear();
            location.reload();
          }
        }
      };
    }
  </script>
</body>
</html>
