<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Coach">
  <title>Coach Adaptativo</title>
  
  <!-- PWA -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23111' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='%23f0f0f0'>üí™</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600&display=swap');
    
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface-2: #1a1a1a;
      --border: #2a2a2a;
      --text: #e5e5e5;
      --text-muted: #737373;
      --accent: #22c55e;
      --accent-dim: #166534;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      overscroll-behavior: none;
    }
    
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
      min-height: 56px;
    }
    
    .btn-primary {
      background: var(--accent);
      color: #000;
    }
    
    .btn-primary:active {
      background: var(--accent-dim);
      transform: scale(0.98);
    }
    
    .btn-secondary {
      background: var(--surface-2);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:active {
      background: var(--border);
    }
    
    .btn-danger {
      background: #7f1d1d;
      color: #fecaca;
    }
    
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
    }
    
    .input {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 16px;
    }
    
    .input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--surface-2);
      outline: none;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
    }
    
    .toggle {
      position: relative;
      width: 52px;
      height: 32px;
      background: var(--surface-2);
      border-radius: 16px;
      transition: background 0.2s;
      cursor: pointer;
    }
    
    .toggle.active {
      background: var(--accent);
    }
    
    .toggle::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    
    .toggle.active::after {
      transform: translateX(20px);
    }
    
    .tab-active {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
    }
    
    .exercise-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .exercise-card.completed {
      border-color: var(--accent-dim);
      background: rgba(34, 197, 94, 0.05);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge-green { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    .badge-yellow { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
    .badge-red { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .badge-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    
    .safe-bottom {
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    .screen {
      display: none;
      padding: 1rem;
      padding-bottom: 100px;
    }
    
    .screen.active {
      display: block;
    }
  </style>
</head>
<body x-data="app()" x-init="init()">
  
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-[#0a0a0a]/90 backdrop-blur-sm border-b border-[#2a2a2a] px-4 py-3">
    <div class="flex items-center justify-between">
      <h1 class="text-lg font-semibold" x-text="screenTitles[currentScreen]"></h1>
      <div class="flex items-center gap-2">
        <template x-if="currentScreen === 'home'">
          <button @click="showBackupModal = true" class="p-2 rounded-lg bg-[#1a1a1a]">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
          </button>
        </template>
      </div>
    </div>
  </header>

  <!-- Screens -->
  
  <!-- HOME -->
  <div class="screen" :class="{ 'active': currentScreen === 'home' }">
    <div class="fade-in">
      
      <!-- Estado actual -->
      <template x-if="!todayCheckin">
        <div class="card mb-4">
          <p class="text-[#737373] mb-3">No has hecho el check-in de hoy</p>
          <button @click="showCheckinModal = true" class="btn btn-primary w-full">
            Check-in r√°pido
          </button>
        </div>
      </template>
      
      <template x-if="todayCheckin">
        <div class="card mb-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm text-[#737373]">Estado hoy</span>
            <button @click="showCheckinModal = true" class="text-sm text-[#22c55e]">Editar</button>
          </div>
          <div class="grid grid-cols-3 gap-3 text-center">
            <div>
              <div class="text-2xl mb-1" x-text="getStateEmoji(todayCheckin.estado)"></div>
              <div class="text-xs text-[#737373]">Estado</div>
            </div>
            <div>
              <div class="text-2xl mb-1" x-text="todayCheckin.dolorRodilla > 3 ? 'ü¶µ‚ö†Ô∏è' : 'ü¶µ'"></div>
              <div class="text-xs text-[#737373]" x-text="'Rodilla ' + todayCheckin.dolorRodilla + '/10'"></div>
            </div>
            <div>
              <div class="text-2xl mb-1" x-text="todayCheckin.dolorCuello > 3 ? 'ü¶¥‚ö†Ô∏è' : 'ü¶¥'"></div>
              <div class="text-xs text-[#737373]" x-text="'Cuello ' + todayCheckin.dolorCuello + '/10'"></div>
            </div>
          </div>
        </div>
      </template>
      
      <!-- Sesi√≥n de hoy -->
      <template x-if="todayCheckin && !currentSession">
        <div class="card mb-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="badge" :class="getSessionTypeBadge(recommendedSessionType)">
              Sesi√≥n <span x-text="recommendedSessionType"></span>
            </span>
            <span class="text-sm text-[#737373]" x-text="getSessionTypeReason(recommendedSessionType)"></span>
          </div>
          <p class="text-sm text-[#737373] mb-4" x-text="getSessionDescription(recommendedSessionType)"></p>
          <button @click="generateSession()" class="btn btn-primary w-full">
            Generar sesi√≥n
          </button>
        </div>
      </template>
      
      <!-- Sesi√≥n activa -->
      <template x-if="currentSession">
        <div>
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="badge" :class="getSessionTypeBadge(currentSession.type)">
                Sesi√≥n <span x-text="currentSession.type"></span>
              </span>
              <span class="text-sm text-[#737373]" x-text="currentSession.duration + ' min'"></span>
            </div>
            <button @click="showPainModal = true" class="btn btn-danger text-sm py-2 px-3">
              Me duele
            </button>
          </div>
          
          <!-- Bloques -->
          <template x-for="(block, blockIdx) in currentSession.blocks" :key="blockIdx">
            <div class="mb-6">
              <h3 class="text-sm font-semibold text-[#737373] uppercase tracking-wide mb-3" x-text="block.name"></h3>
              
              <template x-for="(exercise, exIdx) in block.exercises" :key="exercise.id + '-' + exIdx">
                <div class="exercise-card" :class="{ 'completed': exercise.completed }">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                      <div class="font-medium" x-text="exercise.name"></div>
                      <div class="text-sm text-[#737373]" x-text="exercise.prescription"></div>
                    </div>
                    <button 
                      @click="exercise.completed = !exercise.completed; saveSession()"
                      class="w-8 h-8 rounded-full flex items-center justify-center"
                      :class="exercise.completed ? 'bg-[#22c55e] text-black' : 'bg-[#1a1a1a]'"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Sustituciones -->
                  <template x-if="exercise.substitutes && exercise.substitutes.length > 0">
                    <div class="mt-2 pt-2 border-t border-[#2a2a2a]">
                      <button 
                        @click="exercise.showSubs = !exercise.showSubs"
                        class="text-xs text-[#22c55e] flex items-center gap-1"
                      >
                        <span x-text="exercise.showSubs ? 'Ocultar alternativas' : 'Ver alternativas'"></span>
                        <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': exercise.showSubs }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                      </button>
                      <template x-if="exercise.showSubs">
                        <div class="mt-2 space-y-1">
                          <template x-for="sub in exercise.substitutes" :key="sub">
                            <button 
                              @click="swapExercise(blockIdx, exIdx, sub)"
                              class="block w-full text-left text-sm py-1 px-2 rounded bg-[#1a1a1a] hover:bg-[#2a2a2a]"
                              x-text="sub"
                            ></button>
                          </template>
                        </div>
                      </template>
                    </div>
                  </template>
                  
                  <!-- Registro de sets -->
                  <template x-if="exercise.trackSets">
                    <div class="mt-3 pt-3 border-t border-[#2a2a2a]">
                      <div class="grid grid-cols-4 gap-2 text-xs text-[#737373] mb-2">
                        <span>Set</span>
                        <span>Peso</span>
                        <span>Reps</span>
                        <span>RIR</span>
                      </div>
                      <template x-for="(set, setIdx) in exercise.sets" :key="setIdx">
                        <div class="grid grid-cols-4 gap-2 mb-2">
                          <span class="mono text-sm py-2" x-text="setIdx + 1"></span>
                          <input 
                            type="number" 
                            x-model.number="set.weight"
                            @change="saveSession()"
                            class="input py-2 px-2 text-sm mono"
                            placeholder="kg"
                          >
                          <input 
                            type="number" 
                            x-model.number="set.reps"
                            @change="saveSession()"
                            class="input py-2 px-2 text-sm mono"
                            placeholder="reps"
                          >
                          <input 
                            type="number" 
                            x-model.number="set.rir"
                            @change="saveSession()"
                            class="input py-2 px-2 text-sm mono"
                            placeholder="rir"
                            min="0"
                            max="5"
                          >
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
          
          <!-- Finalizar -->
          <button @click="finishSession()" class="btn btn-primary w-full mt-4">
            Finalizar sesi√≥n
          </button>
        </div>
      </template>
      
      <!-- Historial reciente -->
      <template x-if="!currentSession && recentSessions.length > 0">
        <div class="mt-6">
          <h3 class="text-sm font-semibold text-[#737373] uppercase tracking-wide mb-3">√öltimas sesiones</h3>
          <template x-for="session in recentSessions.slice(0, 3)" :key="session.date">
            <div class="card mb-2 flex items-center justify-between">
              <div>
                <div class="font-medium" x-text="formatDate(session.date)"></div>
                <div class="text-sm text-[#737373]">
                  Sesi√≥n <span x-text="session.type"></span> ¬∑ <span x-text="session.completedExercises"></span>/<span x-text="session.totalExercises"></span> ejercicios
                </div>
              </div>
              <span class="badge badge-green" x-show="session.completed">‚úì</span>
            </div>
          </template>
        </div>
      </template>
      
    </div>
  </div>
  
  <!-- PERFIL -->
  <div class="screen" :class="{ 'active': currentScreen === 'profile' }">
    <div class="fade-in space-y-4">
      
      <!-- Objetivos -->
      <div class="card">
        <h3 class="font-semibold mb-3">Objetivos (orden de prioridad)</h3>
        <div class="space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <span class="w-6 h-6 rounded-full bg-[#22c55e] text-black flex items-center justify-center text-xs font-bold">1</span>
            <span>Salud f√≠sica y evitar lesiones</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-6 h-6 rounded-full bg-[#22c55e]/70 text-black flex items-center justify-center text-xs font-bold">2</span>
            <span>Equilibrio postural (espalda > pecho)</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-6 h-6 rounded-full bg-[#22c55e]/50 text-black flex items-center justify-center text-xs font-bold">3</span>
            <span>Est√©tica atl√©tica</span>
          </div>
        </div>
      </div>
      
      <!-- Restricciones -->
      <div class="card">
        <h3 class="font-semibold mb-3">Restricciones de salud</h3>
        <div class="space-y-3">
          <label class="flex items-center justify-between">
            <span class="text-sm">Historial mareos vasovagales</span>
            <div 
              class="toggle" 
              :class="{ 'active': profile.historialMareos }"
              @click="profile.historialMareos = !profile.historialMareos; saveProfile()"
            ></div>
          </label>
          <label class="flex items-center justify-between">
            <span class="text-sm">Problemas cervicales</span>
            <div 
              class="toggle" 
              :class="{ 'active': profile.problemasCuello }"
              @click="profile.problemasCuello = !profile.problemasCuello; saveProfile()"
            ></div>
          </label>
          <label class="flex items-center justify-between">
            <span class="text-sm">Tendinopat√≠a rotuliana</span>
            <div 
              class="toggle" 
              :class="{ 'active': profile.tendinopatiaRodilla }"
              @click="profile.tendinopatiaRodilla = !profile.tendinopatiaRodilla; saveProfile()"
            ></div>
          </label>
          <label class="flex items-center justify-between">
            <span class="text-sm">Cifosis/escoliosis</span>
            <div 
              class="toggle" 
              :class="{ 'active': profile.cifosis }"
              @click="profile.cifosis = !profile.cifosis; saveProfile()"
            ></div>
          </label>
        </div>
      </div>
      
      <!-- Umbrales -->
      <div class="card">
        <h3 class="font-semibold mb-3">Umbrales de seguridad</h3>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Dolor rodilla m√°ximo</span>
              <span class="mono" x-text="profile.umbralRodilla + '/10'"></span>
            </div>
            <input 
              type="range" 
              class="slider" 
              min="1" 
              max="10" 
              x-model.number="profile.umbralRodilla"
              @change="saveProfile()"
            >
            <p class="text-xs text-[#737373] mt-1">Si superas este umbral, se evitan ejercicios de impacto</p>
          </div>
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Dolor cuello m√°ximo</span>
              <span class="mono" x-text="profile.umbralCuello + '/10'"></span>
            </div>
            <input 
              type="range" 
              class="slider" 
              min="1" 
              max="10" 
              x-model.number="profile.umbralCuello"
              @change="saveProfile()"
            >
            <p class="text-xs text-[#737373] mt-1">Si superas este umbral, se evitan ejercicios overhead y cargas altas</p>
          </div>
        </div>
      </div>
      
      <!-- Tiempos -->
      <div class="card">
        <h3 class="font-semibold mb-3">Configuraci√≥n de sesiones</h3>
        <div class="space-y-4">
          <div>
            <label class="text-sm text-[#737373]">Duraci√≥n sesi√≥n ma√±ana (min)</label>
            <input 
              type="number" 
              class="input mt-1" 
              x-model.number="profile.duracionManana"
              @change="saveProfile()"
            >
          </div>
          <div>
            <label class="text-sm text-[#737373]">Duraci√≥n sesi√≥n tarde (min)</label>
            <input 
              type="number" 
              class="input mt-1" 
              x-model.number="profile.duracionTarde"
              @change="saveProfile()"
            >
          </div>
          <div>
            <label class="text-sm text-[#737373]">Hora corte tarde (saturaci√≥n auto)</label>
            <input 
              type="time" 
              class="input mt-1" 
              x-model="profile.horaCorte"
              @change="saveProfile()"
            >
          </div>
          <div>
            <label class="text-sm text-[#737373]">RIR objetivo (repeticiones en reserva)</label>
            <input 
              type="number" 
              class="input mt-1" 
              x-model.number="profile.rirObjetivo"
              @change="saveProfile()"
              min="1"
              max="5"
            >
            <p class="text-xs text-[#737373] mt-1">Recomendado: 2-3 (nunca al fallo)</p>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- GYM -->
  <div class="screen" :class="{ 'active': currentScreen === 'gym' }">
    <div class="fade-in space-y-4">
      
      <div class="card">
        <h3 class="font-semibold mb-3">Equipamiento disponible</h3>
        <div class="space-y-3">
          <template x-for="(available, equip) in gym.equipamiento" :key="equip">
            <label class="flex items-center justify-between">
              <span class="text-sm" x-text="equipNames[equip]"></span>
              <div 
                class="toggle" 
                :class="{ 'active': available }"
                @click="gym.equipamiento[equip] = !gym.equipamiento[equip]; saveGym()"
              ></div>
            </label>
          </template>
        </div>
      </div>
      
      <div class="card">
        <h3 class="font-semibold mb-3">N√∫mero de racks</h3>
        <input 
          type="number" 
          class="input" 
          x-model.number="gym.numRacks"
          @change="saveGym()"
          min="0"
          max="10"
        >
        <p class="text-xs text-[#737373] mt-2">Si hay pocos racks, la app priorizar√° alternativas sin rack</p>
      </div>
      
      <div class="card">
        <h3 class="font-semibold mb-3">Saturaci√≥n por franja</h3>
        <div class="space-y-3">
          <div>
            <label class="text-sm text-[#737373]">Ma√±anas (antes de las 12:00)</label>
            <select class="input mt-1" x-model="gym.saturacionManana" @change="saveGym()">
              <option value="bajo">Bajo - siempre hay sitio</option>
              <option value="medio">Medio - a veces esperas</option>
              <option value="alto">Alto - dif√≠cil encontrar equipo</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-[#737373]">Tardes (despu√©s de las 16:00)</label>
            <select class="input mt-1" x-model="gym.saturacionTarde" @change="saveGym()">
              <option value="bajo">Bajo - siempre hay sitio</option>
              <option value="medio">Medio - a veces esperas</option>
              <option value="alto">Alto - dif√≠cil encontrar equipo</option>
            </select>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- DASHBOARD -->
  <div class="screen" :class="{ 'active': currentScreen === 'dashboard' }">
    <div class="fade-in space-y-4">
      
      <!-- Adherencia -->
      <div class="card">
        <h3 class="font-semibold mb-3">Adherencia esta semana</h3>
        <div class="flex items-end gap-1 h-24 mb-2">
          <template x-for="(day, idx) in weekDays" :key="idx">
            <div class="flex-1 flex flex-col items-center">
              <div 
                class="w-full rounded-t"
                :class="getWorkoutDayClass(day)"
                :style="'height: ' + getWorkoutDayHeight(day) + 'px'"
              ></div>
              <span class="text-xs text-[#737373] mt-1" x-text="day.label"></span>
            </div>
          </template>
        </div>
        <div class="text-center">
          <span class="text-2xl font-semibold" x-text="weeklyStats.completed"></span>
          <span class="text-[#737373]">/ <span x-text="weeklyStats.planned"></span> sesiones</span>
        </div>
      </div>
      
      <!-- Peso y cintura -->
      <div class="card">
        <h3 class="font-semibold mb-3">Peso y cintura</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-[#737373]">Peso actual (kg)</label>
            <input 
              type="number" 
              class="input mt-1" 
              x-model.number="metrics.pesoActual"
              @change="addWeightEntry()"
              step="0.1"
            >
            <template x-if="metrics.pesoTendencia">
              <p class="text-xs mt-1" :class="metrics.pesoTendencia < 0 ? 'text-[#22c55e]' : 'text-[#f59e0b]'">
                <span x-text="metrics.pesoTendencia > 0 ? '+' : ''"></span><span x-text="metrics.pesoTendencia.toFixed(1)"></span> kg (7 d√≠as)
              </p>
            </template>
          </div>
          <div>
            <label class="text-sm text-[#737373]">Cintura (cm)</label>
            <input 
              type="number" 
              class="input mt-1" 
              x-model.number="metrics.cinturaActual"
              @change="addWaistEntry()"
              step="0.5"
            >
            <template x-if="metrics.cinturaTendencia">
              <p class="text-xs mt-1" :class="metrics.cinturaTendencia < 0 ? 'text-[#22c55e]' : 'text-[#f59e0b]'">
                <span x-text="metrics.cinturaTendencia > 0 ? '+' : ''"></span><span x-text="metrics.cinturaTendencia.toFixed(1)"></span> cm (14 d√≠as)
              </p>
            </template>
          </div>
        </div>
      </div>
      
      <!-- Ejercicios referencia -->
      <div class="card">
        <h3 class="font-semibold mb-3">Progreso en ejercicios clave</h3>
        <div class="space-y-3">
          <template x-for="lift in referenceLifts" :key="lift.name">
            <div class="flex items-center justify-between">
              <span class="text-sm" x-text="lift.name"></span>
              <div class="text-right">
                <span class="mono font-semibold" x-text="lift.current ? lift.current + ' kg' : '-'"></span>
                <template x-if="lift.trend">
                  <span class="text-xs ml-2" :class="lift.trend > 0 ? 'text-[#22c55e]' : 'text-[#f59e0b]'">
                    <span x-text="lift.trend > 0 ? '‚Üë' : '‚Üì'"></span>
                  </span>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Estado promedio -->
      <div class="card">
        <h3 class="font-semibold mb-3">Estado promedio (√∫ltimos 7 d√≠as)</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-[#737373]">Estado general</span>
            <div class="text-xl" x-text="avgStats.estado ? getStateEmoji(avgStats.estado) : '-'"></div>
          </div>
          <div>
            <span class="text-[#737373]">Dolor rodilla</span>
            <div class="mono" x-text="avgStats.rodilla !== null ? avgStats.rodilla.toFixed(1) + '/10' : '-'"></div>
          </div>
          <div>
            <span class="text-[#737373]">Dolor cuello</span>
            <div class="mono" x-text="avgStats.cuello !== null ? avgStats.cuello.toFixed(1) + '/10' : '-'"></div>
          </div>
          <div>
            <span class="text-[#737373]">Sesiones</span>
            <div class="mono" x-text="avgStats.sesiones + ' esta semana'"></div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- CHECK-IN MODAL -->
  <div 
    x-show="showCheckinModal" 
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 bg-black/80 flex items-end justify-center"
    @click.self="showCheckinModal = false"
  >
    <div 
      class="bg-[#141414] w-full max-w-lg rounded-t-2xl p-6 safe-bottom"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="translate-y-full"
      x-transition:enter-end="translate-y-0"
    >
      <h2 class="text-xl font-semibold mb-6">Check-in r√°pido</h2>
      
      <div class="space-y-6">
        <!-- Estado general -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">¬øC√≥mo est√°s hoy?</label>
            <span class="text-2xl" x-text="getStateEmoji(checkinForm.estado)"></span>
          </div>
          <input 
            type="range" 
            class="slider" 
            min="1" 
            max="5" 
            x-model.number="checkinForm.estado"
          >
          <div class="flex justify-between text-xs text-[#737373] mt-1">
            <span>Fatal</span>
            <span>Genial</span>
          </div>
        </div>
        
        <!-- Dolor rodilla -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">Dolor rodilla</label>
            <span class="mono text-sm" x-text="checkinForm.dolorRodilla + '/10'"></span>
          </div>
          <input 
            type="range" 
            class="slider" 
            min="0" 
            max="10" 
            x-model.number="checkinForm.dolorRodilla"
          >
        </div>
        
        <!-- Dolor cuello -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="text-sm">Dolor cuello</label>
            <span class="mono text-sm" x-text="checkinForm.dolorCuello + '/10'"></span>
          </div>
          <input 
            type="range" 
            class="slider" 
            min="0" 
            max="10" 
            x-model.number="checkinForm.dolorCuello"
          >
        </div>
        
        <!-- Gym saturado -->
        <div class="flex items-center justify-between">
          <div>
            <label class="text-sm">Gym saturado ahora</label>
            <p class="text-xs text-[#737373]">¬øNo hay racks/bancos libres?</p>
          </div>
          <div 
            class="toggle" 
            :class="{ 'active': checkinForm.gymSaturado }"
            @click="checkinForm.gymSaturado = !checkinForm.gymSaturado"
          ></div>
        </div>
        
        <!-- Tiempo -->
        <div>
          <label class="text-sm text-[#737373]">Tiempo disponible (min)</label>
          <input 
            type="number" 
            class="input mt-1" 
            x-model.number="checkinForm.tiempoDisponible"
          >
        </div>
      </div>
      
      <button @click="submitCheckin()" class="btn btn-primary w-full mt-6">
        Guardar check-in
      </button>
    </div>
  </div>

  <!-- PAIN MODAL -->
  <div 
    x-show="showPainModal" 
    x-transition
    class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"
    @click.self="showPainModal = false"
  >
    <div class="bg-[#141414] w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">¬øQu√© te duele?</h2>
      
      <div class="space-y-3">
        <button @click="handlePain('rodilla')" class="btn btn-secondary w-full justify-start">
          ü¶µ Rodilla
        </button>
        <button @click="handlePain('cuello')" class="btn btn-secondary w-full justify-start">
          ü¶¥ Cuello / cervicales
        </button>
        <button @click="handlePain('espalda')" class="btn btn-secondary w-full justify-start">
          üîô Espalda baja
        </button>
        <button @click="handlePain('hombro')" class="btn btn-secondary w-full justify-start">
          üí™ Hombro
        </button>
        <button @click="handlePain('general')" class="btn btn-secondary w-full justify-start">
          üòµ Mareo / malestar general
        </button>
      </div>
      
      <button @click="showPainModal = false" class="btn btn-secondary w-full mt-4">
        Cancelar
      </button>
    </div>
  </div>

  <!-- BACKUP MODAL -->
  <div 
    x-show="showBackupModal" 
    x-transition
    class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"
    @click.self="showBackupModal = false"
  >
    <div class="bg-[#141414] w-full max-w-sm rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">Backup de datos</h2>
      <p class="text-sm text-[#737373] mb-6">Guarda el archivo en iCloud, Notas o env√≠alo por email para no perder tus datos.</p>
      
      <div class="space-y-3">
        <button @click="exportData()" class="btn btn-primary w-full">
          üì§ Exportar datos
        </button>
        <label class="btn btn-secondary w-full cursor-pointer">
          üì• Importar datos
          <input type="file" accept=".json" @change="importData($event)" class="hidden">
        </label>
      </div>
      
      <button @click="showBackupModal = false" class="btn btn-secondary w-full mt-4">
        Cerrar
      </button>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 bg-[#0a0a0a] border-t border-[#2a2a2a] safe-bottom z-30">
    <div class="flex justify-around py-2">
      <button 
        @click="currentScreen = 'home'" 
        class="flex flex-col items-center py-2 px-4"
        :class="currentScreen === 'home' ? 'text-[#22c55e]' : 'text-[#737373]'"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        <span class="text-xs mt-1">Hoy</span>
      </button>
      <button 
        @click="currentScreen = 'profile'" 
        class="flex flex-col items-center py-2 px-4"
        :class="currentScreen === 'profile' ? 'text-[#22c55e]' : 'text-[#737373]'"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <span class="text-xs mt-1">Perfil</span>
      </button>
      <button 
        @click="currentScreen = 'gym'" 
        class="flex flex-col items-center py-2 px-4"
        :class="currentScreen === 'gym' ? 'text-[#22c55e]' : 'text-[#737373]'"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
        <span class="text-xs mt-1">Gym</span>
      </button>
      <button 
        @click="currentScreen = 'dashboard'" 
        class="flex flex-col items-center py-2 px-4"
        :class="currentScreen === 'dashboard' ? 'text-[#22c55e]' : 'text-[#737373]'"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <span class="text-xs mt-1">Stats</span>
      </button>
    </div>
  </nav>

  <script>
    // ============================================
    // BIBLIOTECA DE EJERCICIOS
    // ============================================
    const EJERCICIOS = {
      // WARMUP
      'respiracion-diafragmatica': {
        id: 'respiracion-diafragmatica',
        name: 'Respiraci√≥n diafragm√°tica',
        patron: 'warmup',
        musculos: ['diafragma', 'core'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: -1, // Beneficioso
        sustitutos: [],
        notas: 'Inhala 4s, mant√©n 4s, exhala 6s. 5 ciclos.'
      },
      'cat-cow': {
        id: 'cat-cow',
        name: 'Cat-Cow',
        patron: 'warmup',
        musculos: ['columna', 'core'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: ['bird-dog'],
        notas: '10 repeticiones lentas'
      },
      'rotaciones-cuello': {
        id: 'rotaciones-cuello',
        name: 'Rotaciones de cuello suaves',
        patron: 'warmup',
        musculos: ['cuello', 'trapecio'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: [],
        notas: '5 en cada direcci√≥n, muy lentas'
      },
      'dislocaciones-hombro': {
        id: 'dislocaciones-hombro',
        name: 'Dislocaciones con banda',
        patron: 'warmup',
        musculos: ['hombros', 'escapulas'],
        equipo: ['banda'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['circulos-brazos'],
        notas: '10 repeticiones'
      },
      'circulos-brazos': {
        id: 'circulos-brazos',
        name: 'C√≠rculos de brazos',
        patron: 'warmup',
        musculos: ['hombros'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: [],
        notas: '10 en cada direcci√≥n'
      },
      'bird-dog': {
        id: 'bird-dog',
        name: 'Bird-Dog',
        patron: 'warmup',
        musculos: ['core', 'gluteo', 'espalda'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['dead-bug'],
        notas: '8 cada lado, mantener 3s'
      },
      'dead-bug': {
        id: 'dead-bug',
        name: 'Dead Bug',
        patron: 'warmup',
        musculos: ['core'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['bird-dog'],
        notas: '8 cada lado'
      },
      'movilidad-cadera-90-90': {
        id: 'movilidad-cadera-90-90',
        name: 'Movilidad cadera 90/90',
        patron: 'warmup',
        musculos: ['cadera'],
        equipo: ['ninguno'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['sentadilla-goblet-ligera'],
        notas: '5 transiciones cada lado'
      },
      'sentadilla-goblet-ligera': {
        id: 'sentadilla-goblet-ligera',
        name: 'Sentadilla goblet ligera',
        patron: 'warmup',
        musculos: ['cuadriceps', 'gluteo', 'cadera'],
        equipo: ['mancuerna'],
        riesgoRodilla: 2,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['sentadilla-caja'],
        notas: '10 reps con peso ligero'
      },
      'wall-slides': {
        id: 'wall-slides',
        name: 'Wall slides',
        patron: 'warmup',
        musculos: ['escapulas', 'hombros'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: [],
        notas: '10 repeticiones'
      },
      
      // BISAGRA (Hip Hinge)
      'rdl-mancuernas': {
        id: 'rdl-mancuernas',
        name: 'RDL con mancuernas',
        patron: 'bisagra',
        musculos: ['isquios', 'gluteo', 'espalda baja'],
        equipo: ['mancuernas'],
        riesgoRodilla: 1,
        riesgoCuello: 1,
        riesgoMareo: 2,
        sustitutos: ['rdl-barra', 'peso-muerto-sumo', 'curl-femoral-tumbado'],
        notas: 'Referencia. Mantener espalda neutra.',
        esReferencia: true
      },
      'rdl-barra': {
        id: 'rdl-barra',
        name: 'RDL con barra',
        patron: 'bisagra',
        musculos: ['isquios', 'gluteo', 'espalda baja'],
        equipo: ['barra', 'rack'],
        riesgoRodilla: 1,
        riesgoCuello: 1,
        riesgoMareo: 3,
        sustitutos: ['rdl-mancuernas', 'peso-muerto-sumo'],
        notas: 'Mantener espalda neutra'
      },
      'peso-muerto-sumo': {
        id: 'peso-muerto-sumo',
        name: 'Peso muerto sumo',
        patron: 'bisagra',
        musculos: ['isquios', 'gluteo', 'aductores'],
        equipo: ['barra', 'rack'],
        riesgoRodilla: 2,
        riesgoCuello: 1,
        riesgoMareo: 3,
        sustitutos: ['rdl-mancuernas', 'hip-thrust'],
        notas: 'Pies anchos, puntas afuera'
      },
      'hip-thrust': {
        id: 'hip-thrust',
        name: 'Hip Thrust',
        patron: 'bisagra',
        musculos: ['gluteo', 'isquios'],
        equipo: ['banco', 'barra'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['hip-thrust-maquina', 'puente-gluteo', 'hip-thrust-mancuerna'],
        notas: 'Foco en gl√∫teo, no hiperextender lumbar'
      },
      'hip-thrust-maquina': {
        id: 'hip-thrust-maquina',
        name: 'Hip Thrust m√°quina',
        patron: 'bisagra',
        musculos: ['gluteo', 'isquios'],
        equipo: ['maquina-hip-thrust'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['hip-thrust', 'puente-gluteo'],
        notas: 'Alternativa si no hay banco'
      },
      'hip-thrust-mancuerna': {
        id: 'hip-thrust-mancuerna',
        name: 'Hip Thrust con mancuerna',
        patron: 'bisagra',
        musculos: ['gluteo', 'isquios'],
        equipo: ['banco', 'mancuerna'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['puente-gluteo', 'hip-thrust'],
        notas: 'Para cuando no hay barra libre'
      },
      'puente-gluteo': {
        id: 'puente-gluteo',
        name: 'Puente de gl√∫teo',
        patron: 'bisagra',
        musculos: ['gluteo'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: [],
        notas: 'Opci√≥n sin equipo'
      },
      'curl-femoral-tumbado': {
        id: 'curl-femoral-tumbado',
        name: 'Curl femoral tumbado',
        patron: 'bisagra',
        musculos: ['isquios'],
        equipo: ['maquina-femoral'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['curl-femoral-sentado', 'rdl-mancuernas'],
        notas: 'Control en exc√©ntrica'
      },
      'curl-femoral-sentado': {
        id: 'curl-femoral-sentado',
        name: 'Curl femoral sentado',
        patron: 'bisagra',
        musculos: ['isquios'],
        equipo: ['maquina-femoral'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['curl-femoral-tumbado'],
        notas: 'Alternativa si no hay m√°quina tumbado'
      },
      
      // SENTADILLA (Squat)
      'sentadilla-goblet': {
        id: 'sentadilla-goblet',
        name: 'Sentadilla Goblet',
        patron: 'sentadilla',
        musculos: ['cuadriceps', 'gluteo'],
        equipo: ['mancuerna'],
        riesgoRodilla: 2,
        riesgoCuello: 0,
        riesgoMareo: 2,
        sustitutos: ['sentadilla-caja', 'prensa', 'split-squat'],
        notas: 'Profundidad c√≥moda, no forzar'
      },
      'sentadilla-caja': {
        id: 'sentadilla-caja',
        name: 'Sentadilla a caja',
        patron: 'sentadilla',
        musculos: ['cuadriceps', 'gluteo'],
        equipo: ['caja', 'mancuerna'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['sentadilla-goblet', 'prensa'],
        notas: 'Control total. Bueno para rodilla.'
      },
      'prensa': {
        id: 'prensa',
        name: 'Prensa de piernas',
        patron: 'sentadilla',
        musculos: ['cuadriceps', 'gluteo'],
        equipo: ['prensa'],
        riesgoRodilla: 2,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['sentadilla-goblet', 'extension-cuadriceps'],
        notas: 'Pies altos para m√°s gl√∫teo, bajos para cu√°driceps'
      },
      'split-squat': {
        id: 'split-squat',
        name: 'Split Squat',
        patron: 'sentadilla',
        musculos: ['cuadriceps', 'gluteo'],
        equipo: ['mancuernas'],
        riesgoRodilla: 2,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['sentadilla-goblet', 'prensa'],
        notas: 'Unilateral, bueno para equilibrio'
      },
      'extension-cuadriceps': {
        id: 'extension-cuadriceps',
        name: 'Extensi√≥n de cu√°driceps',
        patron: 'sentadilla',
        musculos: ['cuadriceps'],
        equipo: ['maquina-extension'],
        riesgoRodilla: 3,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['sentadilla-goblet'],
        notas: 'Evitar si dolor rodilla alto. Peso moderado.'
      },
      'step-up': {
        id: 'step-up',
        name: 'Step Up',
        patron: 'sentadilla',
        musculos: ['cuadriceps', 'gluteo'],
        equipo: ['caja', 'mancuernas'],
        riesgoRodilla: 2,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['split-squat', 'prensa'],
        notas: 'Altura moderada'
      },
      
      // EMPUJE HORIZONTAL
      'press-mancuernas-plano': {
        id: 'press-mancuernas-plano',
        name: 'Press mancuernas plano',
        patron: 'empuje-horizontal',
        musculos: ['pecho', 'triceps', 'hombro anterior'],
        equipo: ['mancuernas', 'banco'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 2,
        sustitutos: ['press-maquina', 'flexiones', 'press-mancuernas-inclinado'],
        notas: 'Referencia. Esc√°pulas retra√≠das.',
        esReferencia: true
      },
      'press-mancuernas-inclinado': {
        id: 'press-mancuernas-inclinado',
        name: 'Press mancuernas inclinado',
        patron: 'empuje-horizontal',
        musculos: ['pecho superior', 'triceps', 'hombro anterior'],
        equipo: ['mancuernas', 'banco'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 2,
        sustitutos: ['press-maquina', 'press-mancuernas-plano'],
        notas: '30-45 grados de inclinaci√≥n'
      },
      'press-maquina': {
        id: 'press-maquina',
        name: 'Press de pecho m√°quina',
        patron: 'empuje-horizontal',
        musculos: ['pecho', 'triceps'],
        equipo: ['maquina-press'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['press-mancuernas-plano', 'flexiones'],
        notas: 'Buena opci√≥n si gym saturado'
      },
      'flexiones': {
        id: 'flexiones',
        name: 'Flexiones',
        patron: 'empuje-horizontal',
        musculos: ['pecho', 'triceps', 'core'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 1,
        sustitutos: ['press-maquina'],
        notas: 'Sin equipo necesario'
      },
      'aperturas-mancuernas': {
        id: 'aperturas-mancuernas',
        name: 'Aperturas con mancuernas',
        patron: 'empuje-horizontal',
        musculos: ['pecho'],
        equipo: ['mancuernas', 'banco'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['aperturas-polea', 'press-mancuernas-plano'],
        notas: 'Peso ligero, estiramiento controlado'
      },
      'aperturas-polea': {
        id: 'aperturas-polea',
        name: 'Aperturas en polea',
        patron: 'empuje-horizontal',
        musculos: ['pecho'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['aperturas-mancuernas'],
        notas: 'Tensi√≥n constante'
      },
      
      // EMPUJE VERTICAL (con precauci√≥n por cuello)
      'press-hombro-mancuernas-sentado': {
        id: 'press-hombro-mancuernas-sentado',
        name: 'Press hombro mancuernas sentado',
        patron: 'empuje-vertical',
        musculos: ['hombro', 'triceps'],
        equipo: ['mancuernas', 'banco'],
        riesgoRodilla: 0,
        riesgoCuello: 3,
        riesgoMareo: 2,
        sustitutos: ['elevaciones-laterales', 'press-hombro-maquina'],
        notas: 'PRECAUCI√ìN si cuello alto. Peso moderado.'
      },
      'press-hombro-maquina': {
        id: 'press-hombro-maquina',
        name: 'Press hombro m√°quina',
        patron: 'empuje-vertical',
        musculos: ['hombro', 'triceps'],
        equipo: ['maquina-hombro'],
        riesgoRodilla: 0,
        riesgoCuello: 2,
        riesgoMareo: 1,
        sustitutos: ['elevaciones-laterales'],
        notas: 'M√°s seguro que mancuernas libres'
      },
      'elevaciones-laterales': {
        id: 'elevaciones-laterales',
        name: 'Elevaciones laterales',
        patron: 'empuje-vertical',
        musculos: ['hombro lateral'],
        equipo: ['mancuernas'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: ['elevaciones-laterales-polea', 'maquina-laterales'],
        notas: 'Peso ligero, control'
      },
      'elevaciones-laterales-polea': {
        id: 'elevaciones-laterales-polea',
        name: 'Elevaciones laterales polea',
        patron: 'empuje-vertical',
        musculos: ['hombro lateral'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['elevaciones-laterales'],
        notas: 'Tensi√≥n constante'
      },
      'elevaciones-frontales': {
        id: 'elevaciones-frontales',
        name: 'Elevaciones frontales',
        patron: 'empuje-vertical',
        musculos: ['hombro anterior'],
        equipo: ['mancuernas'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: [],
        notas: 'Generalmente no necesario (ya trabaja en press)'
      },
      
      // TIR√ìN HORIZONTAL (prioridad alta por desbalance)
      'remo-mancuerna': {
        id: 'remo-mancuerna',
        name: 'Remo con mancuerna',
        patron: 'tiron-horizontal',
        musculos: ['dorsal', 'romboides', 'biceps'],
        equipo: ['mancuerna', 'banco'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 1,
        sustitutos: ['remo-polea', 'remo-maquina', 'remo-barra'],
        notas: 'Referencia. Espalda neutra, retracci√≥n escapular.',
        esReferencia: true
      },
      'remo-polea': {
        id: 'remo-polea',
        name: 'Remo en polea baja',
        patron: 'tiron-horizontal',
        musculos: ['dorsal', 'romboides', 'biceps'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['remo-mancuerna', 'remo-maquina'],
        notas: 'Buena opci√≥n si gym saturado'
      },
      'remo-maquina': {
        id: 'remo-maquina',
        name: 'Remo en m√°quina',
        patron: 'tiron-horizontal',
        musculos: ['dorsal', 'romboides'],
        equipo: ['maquina-remo'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['remo-polea', 'remo-mancuerna'],
        notas: 'M√°quina Hammer o similar'
      },
      'remo-barra': {
        id: 'remo-barra',
        name: 'Remo con barra',
        patron: 'tiron-horizontal',
        musculos: ['dorsal', 'romboides', 'biceps', 'espalda baja'],
        equipo: ['barra'],
        riesgoRodilla: 0,
        riesgoCuello: 2,
        riesgoMareo: 2,
        sustitutos: ['remo-mancuerna', 'remo-polea'],
        notas: 'M√°s demandante para espalda baja'
      },
      'face-pull': {
        id: 'face-pull',
        name: 'Face Pull',
        patron: 'tiron-horizontal',
        musculos: ['trapecio medio', 'deltoides posterior', 'rotadores externos'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: ['band-pull-apart', 'remo-alto-polea'],
        notas: 'Esencial para salud de hombros'
      },
      'band-pull-apart': {
        id: 'band-pull-apart',
        name: 'Band Pull-Apart',
        patron: 'tiron-horizontal',
        musculos: ['trapecio medio', 'deltoides posterior'],
        equipo: ['banda'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['face-pull'],
        notas: 'Sin equipo pesado necesario'
      },
      'remo-alto-polea': {
        id: 'remo-alto-polea',
        name: 'Remo alto en polea',
        patron: 'tiron-horizontal',
        musculos: ['deltoides posterior', 'trapecio'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['face-pull', 'band-pull-apart'],
        notas: 'Codos altos, enfoque en posterior'
      },
      
      // TIR√ìN VERTICAL
      'jalon-polea': {
        id: 'jalon-polea',
        name: 'Jal√≥n en polea alta',
        patron: 'tiron-vertical',
        musculos: ['dorsal', 'biceps'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: ['jalon-maquina', 'pulldown-brazos-rectos'],
        notas: 'Agarre medio, llevar a pecho'
      },
      'jalon-maquina': {
        id: 'jalon-maquina',
        name: 'Jal√≥n en m√°quina',
        patron: 'tiron-vertical',
        musculos: ['dorsal', 'biceps'],
        equipo: ['maquina-jalon'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['jalon-polea'],
        notas: 'Guiado, bueno para principiantes'
      },
      'pulldown-brazos-rectos': {
        id: 'pulldown-brazos-rectos',
        name: 'Pulldown brazos rectos',
        patron: 'tiron-vertical',
        musculos: ['dorsal'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['jalon-polea'],
        notas: 'Aislamiento de dorsal'
      },
      
      // CORE
      'plancha': {
        id: 'plancha',
        name: 'Plancha frontal',
        patron: 'core',
        musculos: ['core', 'hombros'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 1,
        riesgoMareo: 0,
        sustitutos: ['dead-bug', 'bird-dog'],
        notas: '30-60s, mantener neutro'
      },
      'plancha-lateral': {
        id: 'plancha-lateral',
        name: 'Plancha lateral',
        patron: 'core',
        musculos: ['oblicuos', 'core'],
        equipo: ['ninguno'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['pallof-press'],
        notas: '20-30s cada lado'
      },
      'pallof-press': {
        id: 'pallof-press',
        name: 'Pallof Press',
        patron: 'core',
        musculos: ['core', 'oblicuos'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['plancha-lateral'],
        notas: 'Anti-rotaci√≥n, excelente para core'
      },
      'crunch-polea': {
        id: 'crunch-polea',
        name: 'Crunch en polea',
        patron: 'core',
        musculos: ['recto abdominal'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 2,
        riesgoMareo: 0,
        sustitutos: ['plancha'],
        notas: 'Evitar si cuello alto'
      },
      
      // BRAZOS (accesorios)
      'curl-biceps-mancuernas': {
        id: 'curl-biceps-mancuernas',
        name: 'Curl b√≠ceps mancuernas',
        patron: 'brazos',
        musculos: ['biceps'],
        equipo: ['mancuernas'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['curl-biceps-polea', 'curl-martillo'],
        notas: 'Control, sin balanceo'
      },
      'curl-biceps-polea': {
        id: 'curl-biceps-polea',
        name: 'Curl b√≠ceps polea',
        patron: 'brazos',
        musculos: ['biceps'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['curl-biceps-mancuernas'],
        notas: 'Tensi√≥n constante'
      },
      'curl-martillo': {
        id: 'curl-martillo',
        name: 'Curl martillo',
        patron: 'brazos',
        musculos: ['biceps', 'braquial'],
        equipo: ['mancuernas'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['curl-biceps-mancuernas'],
        notas: 'Agarre neutro'
      },
      'triceps-polea': {
        id: 'triceps-polea',
        name: 'Extensi√≥n tr√≠ceps polea',
        patron: 'brazos',
        musculos: ['triceps'],
        equipo: ['polea'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['triceps-mancuerna'],
        notas: 'Codos fijos'
      },
      'triceps-mancuerna': {
        id: 'triceps-mancuerna',
        name: 'Extensi√≥n tr√≠ceps mancuerna',
        patron: 'brazos',
        musculos: ['triceps'],
        equipo: ['mancuerna'],
        riesgoRodilla: 0,
        riesgoCuello: 2,
        riesgoMareo: 0,
        sustitutos: ['triceps-polea'],
        notas: 'Overhead: precauci√≥n si cuello alto'
      },
      
      // CARDIO (sin impacto)
      'bicicleta-estatica': {
        id: 'bicicleta-estatica',
        name: 'Bicicleta est√°tica',
        patron: 'cardio',
        musculos: ['cardiovascular', 'piernas'],
        equipo: ['bicicleta'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['remo-ergometro', 'eliptica', 'cinta-caminar'],
        notas: 'Zona 2: poder hablar. 10-15 min.'
      },
      'remo-ergometro': {
        id: 'remo-ergometro',
        name: 'Remo erg√≥metro',
        patron: 'cardio',
        musculos: ['cardiovascular', 'espalda', 'piernas'],
        equipo: ['remo'],
        riesgoRodilla: 1,
        riesgoCuello: 1,
        riesgoMareo: 1,
        sustitutos: ['bicicleta-estatica', 'eliptica'],
        notas: 'T√©cnica correcta. Zona 2: 10-15 min.'
      },
      'eliptica': {
        id: 'eliptica',
        name: 'El√≠ptica',
        patron: 'cardio',
        musculos: ['cardiovascular'],
        equipo: ['eliptica'],
        riesgoRodilla: 0,
        riesgoCuello: 0,
        riesgoMareo: 1,
        sustitutos: ['bicicleta-estatica'],
        notas: 'Sin impacto. 10-15 min.'
      },
      'cinta-caminar': {
        id: 'cinta-caminar',
        name: 'Cinta - Caminar inclinado',
        patron: 'cardio',
        musculos: ['cardiovascular', 'piernas'],
        equipo: ['cinta'],
        riesgoRodilla: 1,
        riesgoCuello: 0,
        riesgoMareo: 0,
        sustitutos: ['bicicleta-estatica'],
        notas: 'Inclinaci√≥n 8-12%, velocidad 5-6 km/h'
      }
    };

    // ============================================
    // APLICACI√ìN PRINCIPAL
    // ============================================
    function app() {
      return {
        // Estado de navegaci√≥n
        currentScreen: 'home',
        screenTitles: {
          home: 'Hoy',
          profile: 'Perfil',
          gym: 'Gimnasio',
          dashboard: 'Estad√≠sticas'
        },
        
        // Modales
        showCheckinModal: false,
        showPainModal: false,
        showBackupModal: false,
        
        // Nombres de equipo
        equipNames: {
          rack: 'Rack / Jaula',
          banco: 'Banco plano/inclinado',
          mancuernas: 'Mancuernas',
          barra: 'Barra ol√≠mpica',
          polea: 'Poleas',
          prensa: 'Prensa de piernas',
          maquinaFemoral: 'M√°quina femoral',
          maquinaHipThrust: 'M√°quina hip thrust',
          bicicleta: 'Bicicleta est√°tica',
          remo: 'Remo erg√≥metro',
          cinta: 'Cinta de correr',
          eliptica: 'El√≠ptica',
          bandas: 'Bandas el√°sticas'
        },
        
        // Datos del perfil
        profile: {
          historialMareos: true,
          problemasCuello: true,
          tendinopatiaRodilla: true,
          cifosis: true,
          umbralRodilla: 5,
          umbralCuello: 4,
          duracionManana: 55,
          duracionTarde: 45,
          horaCorte: '16:00',
          rirObjetivo: 2
        },
        
        // Datos del gym
        gym: {
          equipamiento: {
            rack: true,
            banco: true,
            mancuernas: true,
            barra: true,
            polea: true,
            prensa: true,
            maquinaFemoral: true,
            maquinaHipThrust: false,
            bicicleta: true,
            remo: true,
            cinta: true,
            eliptica: false,
            bandas: true
          },
          numRacks: 2,
          saturacionManana: 'bajo',
          saturacionTarde: 'alto'
        },
        
        // Check-in
        checkinForm: {
          estado: 3,
          dolorRodilla: 0,
          dolorCuello: 0,
          gymSaturado: false,
          tiempoDisponible: 55
        },
        todayCheckin: null,
        
        // Sesi√≥n actual
        currentSession: null,
        recommendedSessionType: 'A',
        
        // Historial
        recentSessions: [],
        checkinHistory: [],
        weightHistory: [],
        waistHistory: [],
        exerciseHistory: {},
        
        // M√©tricas
        metrics: {
          pesoActual: null,
          pesoTendencia: null,
          cinturaActual: null,
          cinturaTendencia: null
        },
        
        // Stats
        weekDays: [],
        weeklyStats: { completed: 0, planned: 4 },
        avgStats: { estado: null, rodilla: null, cuello: null, sesiones: 0 },
        referenceLifts: [
          { name: 'RDL mancuernas', id: 'rdl-mancuernas', current: null, trend: null },
          { name: 'Press mancuernas', id: 'press-mancuernas-plano', current: null, trend: null },
          { name: 'Remo mancuerna', id: 'remo-mancuerna', current: null, trend: null }
        ],
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        init() {
          this.loadAllData();
          this.checkTodayCheckin();
          this.calculateWeekDays();
          this.calculateStats();
          this.updateReferenceLifts();
          
          // Auto-ajustar tiempo seg√∫n hora
          const hour = new Date().getHours();
          const [corteH] = this.profile.horaCorte.split(':').map(Number);
          if (hour >= corteH) {
            this.checkinForm.tiempoDisponible = this.profile.duracionTarde;
            this.checkinForm.gymSaturado = this.gym.saturacionTarde === 'alto';
          } else {
            this.checkinForm.tiempoDisponible = this.profile.duracionManana;
            this.checkinForm.gymSaturado = this.gym.saturacionManana === 'alto';
          }
        },
        
        loadAllData() {
          const profile = localStorage.getItem('coach_profile');
          if (profile) this.profile = { ...this.profile, ...JSON.parse(profile) };
          
          const gym = localStorage.getItem('coach_gym');
          if (gym) this.gym = { ...this.gym, ...JSON.parse(gym) };
          
          const sessions = localStorage.getItem('coach_sessions');
          if (sessions) this.recentSessions = JSON.parse(sessions);
          
          const checkins = localStorage.getItem('coach_checkins');
          if (checkins) this.checkinHistory = JSON.parse(checkins);
          
          const weights = localStorage.getItem('coach_weights');
          if (weights) this.weightHistory = JSON.parse(weights);
          
          const waists = localStorage.getItem('coach_waists');
          if (waists) this.waistHistory = JSON.parse(waists);
          
          const exerciseHist = localStorage.getItem('coach_exercise_history');
          if (exerciseHist) this.exerciseHistory = JSON.parse(exerciseHist);
          
          const currentSession = localStorage.getItem('coach_current_session');
          if (currentSession) this.currentSession = JSON.parse(currentSession);
          
          // Cargar m√©tricas actuales
          if (this.weightHistory.length > 0) {
            this.metrics.pesoActual = this.weightHistory[this.weightHistory.length - 1].value;
            this.calculateWeightTrend();
          }
          if (this.waistHistory.length > 0) {
            this.metrics.cinturaActual = this.waistHistory[this.waistHistory.length - 1].value;
            this.calculateWaistTrend();
          }
        },
        
        saveProfile() {
          localStorage.setItem('coach_profile', JSON.stringify(this.profile));
        },
        
        saveGym() {
          localStorage.setItem('coach_gym', JSON.stringify(this.gym));
        },
        
        saveSessions() {
          localStorage.setItem('coach_sessions', JSON.stringify(this.recentSessions));
        },
        
        saveCheckins() {
          localStorage.setItem('coach_checkins', JSON.stringify(this.checkinHistory));
        },
        
        saveSession() {
          if (this.currentSession) {
            localStorage.setItem('coach_current_session', JSON.stringify(this.currentSession));
          }
        },
        
        saveExerciseHistory() {
          localStorage.setItem('coach_exercise_history', JSON.stringify(this.exerciseHistory));
        },
        
        // ============================================
        // CHECK-IN
        // ============================================
        checkTodayCheckin() {
          const today = new Date().toDateString();
          const existing = this.checkinHistory.find(c => new Date(c.date).toDateString() === today);
          if (existing) {
            this.todayCheckin = existing;
            this.calculateRecommendedSession();
          }
        },
        
        submitCheckin() {
          const today = new Date().toISOString();
          const checkin = {
            date: today,
            estado: this.checkinForm.estado,
            dolorRodilla: this.checkinForm.dolorRodilla,
            dolorCuello: this.checkinForm.dolorCuello,
            gymSaturado: this.checkinForm.gymSaturado,
            tiempoDisponible: this.checkinForm.tiempoDisponible
          };
          
          // Actualizar o a√±adir
          const todayStr = new Date().toDateString();
          const existingIdx = this.checkinHistory.findIndex(c => new Date(c.date).toDateString() === todayStr);
          if (existingIdx >= 0) {
            this.checkinHistory[existingIdx] = checkin;
          } else {
            this.checkinHistory.push(checkin);
          }
          
          this.todayCheckin = checkin;
          this.saveCheckins();
          this.calculateRecommendedSession();
          this.showCheckinModal = false;
          this.calculateStats();
        },
        
        // ============================================
        // MOTOR DE REGLAS - TIPO DE SESI√ìN
        // ============================================
        calculateRecommendedSession() {
          if (!this.todayCheckin) {
            this.recommendedSessionType = 'A';
            return;
          }
          
          const c = this.todayCheckin;
          
          // Regla 1: Poco tiempo o energ√≠a muy baja ‚Üí Sesi√≥n C
          if (c.tiempoDisponible < 35 || c.estado <= 2) {
            this.recommendedSessionType = 'C';
            return;
          }
          
          // Regla 2: Dolor alto ‚Üí Sesi√≥n C
          if (c.dolorRodilla >= this.profile.umbralRodilla || 
              c.dolorCuello >= this.profile.umbralCuello) {
            this.recommendedSessionType = 'C';
            return;
          }
          
          // Regla 3: Gym saturado ‚Üí Sesi√≥n B
          if (c.gymSaturado) {
            this.recommendedSessionType = 'B';
            return;
          }
          
          // Regla 4: Estado medio-bajo ‚Üí Sesi√≥n B
          if (c.estado <= 3 && (c.dolorRodilla > 2 || c.dolorCuello > 2)) {
            this.recommendedSessionType = 'B';
            return;
          }
          
          // Default: Sesi√≥n A
          this.recommendedSessionType = 'A';
        },
        
        getSessionTypeBadge(type) {
          return {
            'A': 'badge-green',
            'B': 'badge-yellow',
            'C': 'badge-blue'
          }[type] || 'badge-green';
        },
        
        getSessionTypeReason(type) {
          if (!this.todayCheckin) return '';
          const c = this.todayCheckin;
          
          if (type === 'C') {
            if (c.tiempoDisponible < 35) return '(poco tiempo)';
            if (c.estado <= 2) return '(energ√≠a baja)';
            if (c.dolorRodilla >= this.profile.umbralRodilla) return '(dolor rodilla)';
            if (c.dolorCuello >= this.profile.umbralCuello) return '(dolor cuello)';
          }
          if (type === 'B') {
            if (c.gymSaturado) return '(gym saturado)';
            return '(estado moderado)';
          }
          return '(condiciones √≥ptimas)';
        },
        
        getSessionDescription(type) {
          return {
            'A': 'Sesi√≥n completa con fuerza estructurada. Usa rack y bancos.',
            'B': 'Sesi√≥n adaptada sin depender de rack/banco. Mancuernas y poleas.',
            'C': 'Sesi√≥n m√≠nima efectiva: movilidad + mantenimiento. 30-35 min.'
          }[type];
        },
        
        // ============================================
        // GENERADOR DE SESIONES
        // ============================================
        generateSession() {
          const type = this.recommendedSessionType;
          const checkin = this.todayCheckin;
          const duration = checkin.tiempoDisponible;
          
          let session = {
            id: Date.now(),
            date: new Date().toISOString(),
            type: type,
            duration: duration,
            blocks: [],
            completed: false
          };
          
          // Determinar restricciones activas
          const restrictions = {
            evitarImpacto: this.profile.tendinopatiaRodilla || checkin.dolorRodilla > 3,
            evitarOverhead: checkin.dolorCuello > 3,
            evitarCargasAltas: checkin.dolorCuello > 4 || checkin.estado <= 2,
            evitarValsalva: this.profile.historialMareos && checkin.estado <= 3,
            sinRack: checkin.gymSaturado || type === 'B',
            sinBanco: checkin.gymSaturado && this.gym.numRacks < 2
          };
          
          // Generar bloques seg√∫n tipo
          if (type === 'A') {
            session.blocks = this.generateSessionA(restrictions, duration);
          } else if (type === 'B') {
            session.blocks = this.generateSessionB(restrictions, duration);
          } else {
            session.blocks = this.generateSessionC(restrictions, duration);
          }
          
          this.currentSession = session;
          this.saveSession();
        },
        
        generateSessionA(restrictions, duration) {
          const blocks = [];
          
          // 1. Warmup (siempre)
          blocks.push(this.generateWarmupBlock(restrictions));
          
          // 2. Bloque principal (bisagra o sentadilla rotando)
          const lastSession = this.recentSessions[0];
          const lastPattern = lastSession?.mainPattern || 'sentadilla';
          const todayPattern = lastPattern === 'bisagra' ? 'sentadilla' : 'bisagra';
          
          blocks.push(this.generateMainBlock(todayPattern, restrictions));
          
          // 3. Empuje (priorizar horizontal, limitar vertical si cuello)
          blocks.push(this.generatePushBlock(restrictions));
          
          // 4. Tir√≥n (prioridad alta - m√°s volumen que empuje)
          blocks.push(this.generatePullBlock(restrictions));
          
          // 5. Core
          blocks.push(this.generateCoreBlock(restrictions));
          
          // 6. Cardio final
          if (duration >= 50) {
            blocks.push(this.generateCardioBlock(restrictions, 12));
          }
          
          return blocks;
        },
        
        generateSessionB(restrictions, duration) {
          const blocks = [];
          
          // Sesi√≥n sin rack/banco - todo con mancuernas, poleas, m√°quinas
          restrictions.sinRack = true;
          restrictions.sinBanco = true;
          
          blocks.push(this.generateWarmupBlock(restrictions));
          
          // Principal: RDL mancuernas o hip thrust m√°quina
          const mainExercises = [
            this.getExercise('rdl-mancuernas', restrictions),
            this.getExercise('curl-femoral-tumbado', restrictions)
          ].filter(e => e);
          
          blocks.push({
            name: 'Principal - Posterior',
            exercises: mainExercises.map(e => ({
              ...e,
              prescription: '3x10-12',
              sets: [{ weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          });
          
          // Tir√≥n (prioridad)
          blocks.push({
            name: 'Tir√≥n',
            exercises: [
              this.getExercise('remo-polea', restrictions),
              this.getExercise('jalon-polea', restrictions),
              this.getExercise('face-pull', restrictions)
            ].filter(e => e).map(e => ({
              ...e,
              prescription: e.id === 'face-pull' ? '3x15' : '3x10-12',
              sets: [{ weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          });
          
          // Empuje ligero (m√°quina o flexiones)
          blocks.push({
            name: 'Empuje',
            exercises: [
              this.getExercise('press-maquina', restrictions) || this.getExercise('flexiones', restrictions),
              this.getExercise('elevaciones-laterales', restrictions)
            ].filter(e => e).map(e => ({
              ...e,
              prescription: '3x12',
              sets: [{ weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          });
          
          blocks.push(this.generateCoreBlock(restrictions));
          
          if (duration >= 45) {
            blocks.push(this.generateCardioBlock(restrictions, 10));
          }
          
          return blocks;
        },
        
        generateSessionC(restrictions, duration) {
          const blocks = [];
          
          // Sesi√≥n m√≠nima: movilidad + mantenimiento
          blocks.push(this.generateWarmupBlock(restrictions, true)); // Warmup extendido
          
          // Un ejercicio de cada patr√≥n principal, volumen reducido
          blocks.push({
            name: 'Mantenimiento',
            exercises: [
              this.getExercise('rdl-mancuernas', restrictions),
              this.getExercise('remo-polea', restrictions) || this.getExercise('remo-mancuerna', restrictions),
              this.getExercise('press-maquina', restrictions) || this.getExercise('flexiones', restrictions)
            ].filter(e => e).map(e => ({
              ...e,
              prescription: '2x10 (ligero)',
              sets: [{ weight: null, reps: null, rir: null }, { weight: null, reps: null, rir: null }],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          });
          
          // Correctivos escapulares
          blocks.push({
            name: 'Correctivos',
            exercises: [
              this.getExercise('face-pull', restrictions) || this.getExercise('band-pull-apart', restrictions),
              this.getExercise('wall-slides', restrictions)
            ].filter(e => e).map(e => ({
              ...e,
              prescription: '2x15',
              sets: [],
              trackSets: false,
              completed: false,
              showSubs: false
            }))
          });
          
          if (duration >= 30) {
            blocks.push(this.generateCardioBlock(restrictions, 8));
          }
          
          return blocks;
        },
        
        generateWarmupBlock(restrictions, extended = false) {
          let exercises = [
            this.getExercise('respiracion-diafragmatica', restrictions)
          ];
          
          // Movilidad cuello si hay problemas
          if (this.profile.problemasCuello) {
            exercises.push(this.getExercise('rotaciones-cuello', restrictions));
          }
          
          exercises.push(this.getExercise('cat-cow', restrictions));
          exercises.push(this.getExercise('wall-slides', restrictions));
          
          if (extended) {
            exercises.push(this.getExercise('bird-dog', restrictions));
            exercises.push(this.getExercise('movilidad-cadera-90-90', restrictions));
          }
          
          // Activaci√≥n gl√∫teo
          exercises.push(this.getExercise('puente-gluteo', restrictions));
          
          return {
            name: 'Calentamiento (5-8 min)',
            exercises: exercises.filter(e => e).map(e => ({
              ...e,
              prescription: e.notas || '',
              sets: [],
              trackSets: false,
              completed: false,
              showSubs: false
            }))
          };
        },
        
        generateMainBlock(pattern, restrictions) {
          let exercises = [];
          
          if (pattern === 'bisagra') {
            if (!restrictions.sinRack && this.gym.equipamiento.barra) {
              exercises.push(this.getExercise('rdl-barra', restrictions));
            } else {
              exercises.push(this.getExercise('rdl-mancuernas', restrictions));
            }
            
            if (this.gym.equipamiento.maquinaHipThrust) {
              exercises.push(this.getExercise('hip-thrust-maquina', restrictions));
            } else if (!restrictions.sinBanco) {
              exercises.push(this.getExercise('hip-thrust', restrictions));
            }
            
            exercises.push(this.getExercise('curl-femoral-tumbado', restrictions));
          } else {
            // Sentadilla
            if (restrictions.evitarImpacto || this.todayCheckin?.dolorRodilla > 3) {
              exercises.push(this.getExercise('sentadilla-caja', restrictions));
            } else {
              exercises.push(this.getExercise('sentadilla-goblet', restrictions));
            }
            
            exercises.push(this.getExercise('prensa', restrictions));
            exercises.push(this.getExercise('split-squat', restrictions));
          }
          
          return {
            name: pattern === 'bisagra' ? 'Principal - Bisagra' : 'Principal - Sentadilla',
            mainPattern: pattern,
            exercises: exercises.filter(e => e).slice(0, 3).map((e, i) => ({
              ...e,
              prescription: i === 0 ? '3x8-10' : '3x10-12',
              sets: [
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null }
              ],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          };
        },
        
        generatePushBlock(restrictions) {
          let exercises = [];
          
          // Empuje horizontal (menos volumen que tir√≥n por desbalance)
          if (!restrictions.sinBanco && this.gym.equipamiento.banco) {
            exercises.push(this.getExercise('press-mancuernas-plano', restrictions));
          } else {
            exercises.push(this.getExercise('press-maquina', restrictions) || this.getExercise('flexiones', restrictions));
          }
          
          // Lateral de hombro (siempre ok)
          exercises.push(this.getExercise('elevaciones-laterales', restrictions));
          
          return {
            name: 'Empuje',
            exercises: exercises.filter(e => e).map(e => ({
              ...e,
              prescription: '3x10-12',
              sets: [
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null }
              ],
              trackSets: true,
              completed: false,
              showSubs: false
            }))
          };
        },
        
        generatePullBlock(restrictions) {
          let exercises = [];
          
          // Tir√≥n horizontal (prioridad alta)
          if (!restrictions.sinBanco) {
            exercises.push(this.getExercise('remo-mancuerna', restrictions));
          } else {
            exercises.push(this.getExercise('remo-polea', restrictions) || this.getExercise('remo-maquina', restrictions));
          }
          
          // Tir√≥n vertical
          exercises.push(this.getExercise('jalon-polea', restrictions));
          
          // Face pull (esencial para hombros y postura)
          exercises.push(this.getExercise('face-pull', restrictions) || this.getExercise('band-pull-apart', restrictions));
          
          return {
            name: 'Tir√≥n (prioridad)',
            exercises: exercises.filter(e => e).map((e, i) => ({
              ...e,
              prescription: e.id.includes('face') || e.id.includes('band') ? '3x15-20' : '3x10-12',
              sets: e.id.includes('face') || e.id.includes('band') ? [] : [
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null },
                { weight: null, reps: null, rir: null }
              ],
              trackSets: !(e.id.includes('face') || e.id.includes('band')),
              completed: false,
              showSubs: false
            }))
          };
        },
        
        generateCoreBlock(restrictions) {
          let exercises = [];
          
          exercises.push(this.getExercise('pallof-press', restrictions) || this.getExercise('plancha-lateral', restrictions));
          exercises.push(this.getExercise('dead-bug', restrictions) || this.getExercise('plancha', restrictions));
          
          return {
            name: 'Core',
            exercises: exercises.filter(e => e).map(e => ({
              ...e,
              prescription: '2x30-45s o 2x10 cada lado',
              sets: [],
              trackSets: false,
              completed: false,
              showSubs: false
            }))
          };
        },
        
        generateCardioBlock(restrictions, minutes) {
          let exercise;
          
          if (this.gym.equipamiento.bicicleta && !restrictions.evitarImpacto) {
            exercise = this.getExercise('bicicleta-estatica', restrictions);
          } else if (this.gym.equipamiento.remo) {
            exercise = this.getExercise('remo-ergometro', restrictions);
          } else if (this.gym.equipamiento.cinta) {
            exercise = this.getExercise('cinta-caminar', restrictions);
          } else if (this.gym.equipamiento.eliptica) {
            exercise = this.getExercise('eliptica', restrictions);
          }
          
          if (!exercise) {
            exercise = { id: 'caminar', name: 'Caminar', patron: 'cardio', sustitutos: [] };
          }
          
          return {
            name: 'Cardio - Zona 2',
            exercises: [{
              ...exercise,
              prescription: `${minutes} min a ritmo conversacional`,
              sets: [],
              trackSets: false,
              completed: false,
              showSubs: false
            }]
          };
        },
        
        getExercise(id, restrictions) {
          const ex = EJERCICIOS[id];
          if (!ex) return null;
          
          // Verificar si el ejercicio es seguro
          if (restrictions.evitarOverhead && ex.riesgoCuello >= 3) return null;
          if (restrictions.evitarCargasAltas && ex.riesgoMareo >= 3) return null;
          if (restrictions.evitarImpacto && ex.riesgoRodilla >= 3) return null;
          
          // Verificar equipo
          const tieneEquipo = ex.equipo.every(eq => {
            if (eq === 'ninguno') return true;
            if (eq === 'rack' && restrictions.sinRack) return false;
            if (eq === 'banco' && restrictions.sinBanco) return false;
            
            const equipMap = {
              'mancuernas': 'mancuernas',
              'mancuerna': 'mancuernas',
              'barra': 'barra',
              'polea': 'polea',
              'prensa': 'prensa',
              'maquina-femoral': 'maquinaFemoral',
              'maquina-hip-thrust': 'maquinaHipThrust',
              'bicicleta': 'bicicleta',
              'remo': 'remo',
              'cinta': 'cinta',
              'eliptica': 'eliptica',
              'banda': 'bandas',
              'caja': 'banco'
            };
            
            const key = equipMap[eq];
            return key ? this.gym.equipamiento[key] : true;
          });
          
          if (!tieneEquipo) {
            // Intentar sustituto
            for (const subId of ex.sustitutos) {
              const sub = this.getExercise(subId, restrictions);
              if (sub) return sub;
            }
            return null;
          }
          
          return {
            id: ex.id,
            name: ex.name,
            patron: ex.patron,
            substitutes: ex.sustitutos.map(s => EJERCICIOS[s]?.name).filter(Boolean)
          };
        },
        
        swapExercise(blockIdx, exIdx, newName) {
          const newEx = Object.values(EJERCICIOS).find(e => e.name === newName);
          if (!newEx || !this.currentSession) return;
          
          const oldEx = this.currentSession.blocks[blockIdx].exercises[exIdx];
          this.currentSession.blocks[blockIdx].exercises[exIdx] = {
            ...oldEx,
            id: newEx.id,
            name: newEx.name,
            substitutes: newEx.sustitutos.map(s => EJERCICIOS[s]?.name).filter(Boolean),
            showSubs: false
          };
          
          this.saveSession();
        },
        
        // ============================================
        // DOLOR EN TIEMPO REAL
        // ============================================
        handlePain(area) {
          if (!this.currentSession) return;
          
          let message = '';
          
          if (area === 'general') {
            // Mareo o malestar - detener
            message = 'Recomendaci√≥n: Para la sesi√≥n. Si√©ntate, respira profundo, hidrata.';
            alert(message);
            this.showPainModal = false;
            return;
          }
          
          // Recalcular restricciones y adaptar
          const newRestrictions = {
            evitarImpacto: area === 'rodilla',
            evitarOverhead: area === 'cuello' || area === 'hombro',
            evitarCargasAltas: area === 'cuello' || area === 'espalda',
            evitarValsalva: true,
            sinRack: this.todayCheckin?.gymSaturado,
            sinBanco: false
          };
          
          // Buscar ejercicios que afectan esa √°rea y ofrecer sustitutos
          this.currentSession.blocks.forEach(block => {
            block.exercises.forEach(ex => {
              const originalEx = EJERCICIOS[ex.id];
              if (!originalEx) return;
              
              let needsSwap = false;
              if (area === 'rodilla' && originalEx.riesgoRodilla >= 2) needsSwap = true;
              if (area === 'cuello' && originalEx.riesgoCuello >= 2) needsSwap = true;
              if (area === 'espalda' && originalEx.patron === 'bisagra') needsSwap = true;
              if (area === 'hombro' && (originalEx.patron.includes('empuje') || originalEx.riesgoCuello >= 2)) needsSwap = true;
              
              if (needsSwap) {
                ex.showSubs = true;
                if (!ex.name.includes('‚ö†Ô∏è')) {
                  ex.name = '‚ö†Ô∏è ' + ex.name;
                }
              }
            });
          });
          
          this.saveSession();
          message = 'He marcado los ejercicios que podr√≠an afectarte. Revisa las alternativas.';
          alert(message);
          this.showPainModal = false;
        },
        
        // ============================================
        // FINALIZAR SESI√ìN
        // ============================================
        finishSession() {
          if (!this.currentSession) return;
          
          // Contar ejercicios completados
          let completed = 0;
          let total = 0;
          
          this.currentSession.blocks.forEach(block => {
            block.exercises.forEach(ex => {
              total++;
              if (ex.completed) completed++;
              
              // Guardar historial de ejercicio
              if (ex.trackSets && ex.sets && ex.sets.some(s => s.weight)) {
                if (!this.exerciseHistory[ex.id]) {
                  this.exerciseHistory[ex.id] = [];
                }
                
                const validSets = ex.sets.filter(s => s.weight && s.reps);
                if (validSets.length > 0) {
                  this.exerciseHistory[ex.id].push({
                    date: this.currentSession.date,
                    sets: validSets
                  });
                }
              }
            });
          });
          
          // Guardar sesi√≥n en historial
          const sessionRecord = {
            date: this.currentSession.date,
            type: this.currentSession.type,
            duration: this.currentSession.duration,
            completed: completed === total,
            completedExercises: completed,
            totalExercises: total,
            mainPattern: this.currentSession.blocks.find(b => b.mainPattern)?.mainPattern
          };
          
          this.recentSessions.unshift(sessionRecord);
          if (this.recentSessions.length > 50) {
            this.recentSessions = this.recentSessions.slice(0, 50);
          }
          
          this.saveSessions();
          this.saveExerciseHistory();
          localStorage.removeItem('coach_current_session');
          this.currentSession = null;
          
          this.calculateStats();
          this.updateReferenceLifts();
        },
        
        // ============================================
        // ESTAD√çSTICAS
        // ============================================
        calculateWeekDays() {
          const days = [];
          const today = new Date();
          const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
          
          for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            days.push({
              date: d.toDateString(),
              label: dayNames[d.getDay()],
              isToday: i === 0
            });
          }
          
          this.weekDays = days;
        },
        
        getWorkoutDayClass(day) {
          const session = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          if (!session) return 'bg-[#1a1a1a]';
          return session.completed ? 'bg-[#22c55e]' : 'bg-[#f59e0b]';
        },
        
        getWorkoutDayHeight(day) {
          const session = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          if (!session) return 20;
          return session.completed ? 80 : 50;
        },
        
        calculateStats() {
          // Sesiones esta semana
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - 6);
          weekStart.setHours(0, 0, 0, 0);
          
          const weekSessions = this.recentSessions.filter(s => new Date(s.date) >= weekStart);
          this.weeklyStats.completed = weekSessions.length;
          
          // Check-ins √∫ltimos 7 d√≠as
          const recentCheckins = this.checkinHistory.filter(c => new Date(c.date) >= weekStart);
          
          if (recentCheckins.length > 0) {
            const sumEstado = recentCheckins.reduce((a, c) => a + c.estado, 0);
            const sumRodilla = recentCheckins.reduce((a, c) => a + c.dolorRodilla, 0);
            const sumCuello = recentCheckins.reduce((a, c) => a + c.dolorCuello, 0);
            
            this.avgStats.estado = Math.round(sumEstado / recentCheckins.length);
            this.avgStats.rodilla = sumRodilla / recentCheckins.length;
            this.avgStats.cuello = sumCuello / recentCheckins.length;
          }
          
          this.avgStats.sesiones = weekSessions.length;
        },
        
        updateReferenceLifts() {
          this.referenceLifts.forEach(lift => {
            const history = this.exerciseHistory[lift.id];
            if (history && history.length > 0) {
              const lastEntry = history[history.length - 1];
              const maxWeight = Math.max(...lastEntry.sets.map(s => s.weight || 0));
              lift.current = maxWeight;
              
              if (history.length >= 2) {
                const prevEntry = history[history.length - 2];
                const prevMax = Math.max(...prevEntry.sets.map(s => s.weight || 0));
                lift.trend = maxWeight > prevMax ? 1 : maxWeight < prevMax ? -1 : 0;
              }
            }
          });
        },
        
        addWeightEntry() {
          if (!this.metrics.pesoActual) return;
          
          this.weightHistory.push({
            date: new Date().toISOString(),
            value: this.metrics.pesoActual
          });
          
          localStorage.setItem('coach_weights', JSON.stringify(this.weightHistory));
          this.calculateWeightTrend();
        },
        
        addWaistEntry() {
          if (!this.metrics.cinturaActual) return;
          
          this.waistHistory.push({
            date: new Date().toISOString(),
            value: this.metrics.cinturaActual
          });
          
          localStorage.setItem('coach_waists', JSON.stringify(this.waistHistory));
          this.calculateWaistTrend();
        },
        
        calculateWeightTrend() {
          if (this.weightHistory.length < 2) return;
          
          const last7Days = new Date();
          last7Days.setDate(last7Days.getDate() - 7);
          
          const recent = this.weightHistory.filter(w => new Date(w.date) >= last7Days);
          const older = this.weightHistory.filter(w => new Date(w.date) < last7Days).slice(-7);
          
          if (recent.length > 0 && older.length > 0) {
            const recentAvg = recent.reduce((a, w) => a + w.value, 0) / recent.length;
            const olderAvg = older.reduce((a, w) => a + w.value, 0) / older.length;
            this.metrics.pesoTendencia = recentAvg - olderAvg;
          }
        },
        
        calculateWaistTrend() {
          if (this.waistHistory.length < 2) return;
          
          const last14Days = new Date();
          last14Days.setDate(last14Days.getDate() - 14);
          
          const recent = this.waistHistory.filter(w => new Date(w.date) >= last14Days);
          const older = this.waistHistory.filter(w => new Date(w.date) < last14Days).slice(-4);
          
          if (recent.length > 0 && older.length > 0) {
            const recentAvg = recent.reduce((a, w) => a + w.value, 0) / recent.length;
            const olderAvg = older.reduce((a, w) => a + w.value, 0) / older.length;
            this.metrics.cinturaTendencia = recentAvg - olderAvg;
          }
        },
        
        // ============================================
        // HELPERS
        // ============================================
        getStateEmoji(state) {
          return ['', 'üò´', 'üòî', 'üòê', 'üôÇ', 'üí™'][state] || 'üòê';
        },
        
        formatDate(dateStr) {
          const d = new Date(dateStr);
          const today = new Date();
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          
          if (d.toDateString() === today.toDateString()) return 'Hoy';
          if (d.toDateString() === yesterday.toDateString()) return 'Ayer';
          
          return d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        },
        
        // ============================================
        // BACKUP / RESTORE
        // ============================================
        exportData() {
          const data = {
            exportDate: new Date().toISOString(),
            version: '1.0',
            profile: this.profile,
            gym: this.gym,
            sessions: this.recentSessions,
            checkins: this.checkinHistory,
            weights: this.weightHistory,
            waists: this.waistHistory,
            exerciseHistory: this.exerciseHistory
          };
          
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `coach-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          this.showBackupModal = false;
        },
        
        async importData(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.profile) {
              this.profile = { ...this.profile, ...data.profile };
              this.saveProfile();
            }
            if (data.gym) {
              this.gym = { ...this.gym, ...data.gym };
              this.saveGym();
            }
            if (data.sessions) {
              this.recentSessions = data.sessions;
              this.saveSessions();
            }
            if (data.checkins) {
              this.checkinHistory = data.checkins;
              this.saveCheckins();
            }
            if (data.weights) {
              this.weightHistory = data.weights;
              localStorage.setItem('coach_weights', JSON.stringify(this.weightHistory));
            }
            if (data.waists) {
              this.waistHistory = data.waists;
              localStorage.setItem('coach_waists', JSON.stringify(this.waistHistory));
            }
            if (data.exerciseHistory) {
              this.exerciseHistory = data.exerciseHistory;
              this.saveExerciseHistory();
            }
            
            // Recalcular todo
            this.checkTodayCheckin();
            this.calculateStats();
            this.updateReferenceLifts();
            
            if (this.weightHistory.length > 0) {
              this.metrics.pesoActual = this.weightHistory[this.weightHistory.length - 1].value;
              this.calculateWeightTrend();
            }
            if (this.waistHistory.length > 0) {
              this.metrics.cinturaActual = this.waistHistory[this.waistHistory.length - 1].value;
              this.calculateWaistTrend();
            }
            
            alert('Datos importados correctamente');
            this.showBackupModal = false;
          } catch (e) {
            alert('Error al importar: ' + e.message);
          }
          
          event.target.value = '';
        }
      };
    }
  </script>
</body>
</html>
