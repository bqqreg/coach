<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="bingbot" content="noindex, nofollow">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Coach">
  <title>Coach Adaptativo v4.4</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
      --text-primary: #1e293b;
      --text-secondary: #334155;
      --text-muted: #475569;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --border: #cbd5e1;
      --accent: #059669;
      --accent-light: #d1fae5;
      --danger: #dc2626;
      --warning: #b45309;
      --warning-bg: #fef3c7;
    }
    
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 18px;
      line-height: 1.5;
      min-height: 100vh;
      min-height: 100dvh;
    }
    
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 14px;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.15s ease;
      min-height: 56px;
      cursor: pointer;
      border: none;
    }
    
    .btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:active { background: #047857; transform: scale(0.98); }
    .btn-primary:disabled { background: #a7f3d0; color: #6b7280; cursor: not-allowed; }
    .btn-secondary { background: white; border: 2px solid var(--border); color: var(--text-primary); }
    .btn-secondary:active { background: #f1f5f9; }
    .btn-danger { background: #fef2f2; color: var(--danger); border: 2px solid #fecaca; }
    .btn-warning { background: var(--warning-bg); color: var(--warning); border: 2px solid #fde68a; }
    .btn-sm { min-height: 48px; padding: 0.75rem 1rem; font-size: 0.95rem; }
    
    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .input {
      width: 100%;
      padding: 1rem;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    .input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      background: #e2e8f0;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    
    .toggle {
      position: relative;
      width: 56px;
      height: 32px;
      background: #cbd5e1;
      border-radius: 16px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    
    .toggle:focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    .toggle.active { background: var(--accent); }
    
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 26px;
      height: 26px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    .toggle.active::after { transform: translateX(24px); }
    
    .day-badge {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .day-a { background: #d1fae5; color: #065f46; border: 3px solid #059669; }
    .day-b { background: #dbeafe; color: #1e40af; border: 3px solid #2563eb; }
    .day-c { background: #fef3c7; color: #92400e; border: 3px solid #d97706; }
    
    .exercise-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    
    .exercise-card.completed { border-color: #10b981; background: #ecfdf5; }
    .exercise-card.postponed { border-color: #f59e0b; background: #fffbeb; }
    .exercise-card.potencia { border-left: 5px solid #dc2626; }
    .exercise-card.fuerza { border-left: 5px solid #2563eb; }
    .exercise-card.resistencia { border-left: 5px solid #7c3aed; }
    .exercise-card.core { border-left: 5px solid #059669; }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.75rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .badge-potencia { background: #fee2e2; color: #b91c1c; }
    .badge-fuerza { background: #dbeafe; color: #1d4ed8; }
    .badge-resistencia { background: #ede9fe; color: #6d28d9; }
    .badge-core { background: #d1fae5; color: #065f46; }
    .badge-nivel { background: #e0e7ff; color: #3730a3; }
    
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 24px); }
    
    .screen { display: none; padding: 1.25rem; padding-bottom: 120px; }
    .screen.active { display: block; }
    
    .exercise-link {
      color: var(--text-primary);
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 3px;
      font-weight: 600;
    }
    
    .info-box {
      background: #f1f5f9;
      border-left: 4px solid #3b82f6;
      padding: 1rem 1.25rem;
      border-radius: 0 12px 12px 0;
      font-size: 1rem;
    }
    
    .info-box.warning { border-left-color: var(--warning); background: #fffbeb; }
    .info-box.error { border-left-color: var(--danger); background: #fef2f2; }
    .info-box.success { border-left-color: var(--accent); background: #ecfdf5; }
    
    .timer-display {
      font-size: 4rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--text-primary);
    }
    
    /* Timer flotante */
    .timer-float {
      position: fixed;
      bottom: 90px;
      left: 1rem;
      right: 1rem;
      z-index: 999;
      pointer-events: none;
    }
    
    .timer-float-content {
      background: white;
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      pointer-events: auto;
    }
    
    .timer-float-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: #f1f5f9;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    .timer-float-btn:active {
      background: #e2e8f0;
    }
    
    .timer-float-btn-ok {
      width: 50px;
      height: 40px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }
    
    .timer-float .progress-ring circle { stroke-width: 8; }
    
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring circle { fill: none; stroke-width: 10; }
    .progress-ring .bg { stroke: #e2e8f0; }
    .progress-ring .progress { stroke: var(--accent); stroke-linecap: round; }
    
    .time-btn, .level-btn {
      padding: 0.875rem 0.5rem;
      border-radius: 14px;
      text-align: center;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      min-height: 68px;
    }
    
    .level-btn {
      flex: 1;
      min-width: 0; /* Permite que se encoja */
    }
    
    .level-btn .font-bold {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .time-btn {
      min-width: 56px;
      flex: 1;
    }
    
    .time-btn:focus, .level-btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    .time-btn.selected, .level-btn.selected { border-color: var(--accent); background: var(--accent-light); border-width: 3px; }
    
    /* Responsive para pantallas peque√±as */
    @media (max-width: 380px) {
      .level-btn {
        padding: 0.75rem 0.25rem;
        min-height: 60px;
      }
      .level-btn .text-2xl {
        font-size: 1.25rem;
      }
      .level-btn .font-bold {
        font-size: 0.75rem;
      }
      .time-btn {
        min-width: 48px;
        padding: 0.75rem 0.25rem;
      }
      .time-btn .text-xl {
        font-size: 1rem;
      }
    }
    
    .location-btn {
      flex: 1;
      padding: 1.75rem 1rem;
      border-radius: 18px;
      text-align: center;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
    }
    
    .location-btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    .location-btn.selected { border-color: var(--accent); background: var(--accent-light); border-width: 3px; }
    
    .session-timer {
      position: fixed;
      top: 70px;
      right: 1rem;
      background: white;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 0.5rem 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      font-variant-numeric: tabular-nums;
      z-index: 35;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      font-size: 1.25rem;
    }
    
    .action-btn:focus { outline: 3px solid var(--accent); outline-offset: 2px; }
    .action-btn-default { background: #f1f5f9; color: var(--text-secondary); }
    .action-btn-complete { background: var(--accent); color: white; }
    
    .postponed-bar {
      position: fixed;
      bottom: 80px;
      left: 0;
      right: 0;
      background: #fffbeb;
      border-top: 2px solid #f59e0b;
      padding: 1rem 1.25rem;
      z-index: 25;
    }
    
    .stat-bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.3s; }
    .stat-bar-empty { background: #e2e8f0; }
    .stat-bar-complete { background: var(--accent); }
    .stat-bar-partial { background: #f59e0b; }
    
    .mini-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 60px;
    }
    
    .mini-chart-bar {
      flex: 1;
      background: var(--accent);
      border-radius: 3px 3px 0 0;
      min-height: 4px;
    }
    
    header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.25rem;
    }
    
    header h1 { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
    
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      z-index: 30;
      padding-bottom: env(safe-area-inset-bottom, 8px);
    }
    
    nav button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 1rem;
      background: none;
      border: none;
      cursor: pointer;
      min-height: 64px;
    }
    
    nav button:focus { outline: none; background: #f1f5f9; }
    nav button svg { width: 28px; height: 28px; }
    nav button span { font-size: 0.8rem; margin-top: 4px; font-weight: 500; }
    nav button.active { color: var(--accent); }
    nav button.inactive { color: #94a3b8; }
    
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    
    .modal-center { align-items: center; }
    
    .modal-content {
      background: white;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 1.5rem;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content-center { border-radius: 24px; max-width: 400px; margin: 1rem; }
    .modal-title { font-size: 1.375rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary); }
    
    .onboarding-screen {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: white;
      display: flex;
      flex-direction: column;
      padding: 2rem 1.5rem;
    }
    
    /* Responsive general */
    @media (max-width: 360px) {
      body { font-size: 16px; }
      .card { padding: 1.25rem; }
      .btn { padding: 0.875rem 1.25rem; min-height: 52px; }
      .modal-content { padding: 1.25rem; }
      .modal-title { font-size: 1.25rem; }
      .day-badge { width: 44px; height: 44px; font-size: 1.25rem; }
      .text-3xl { font-size: 1.5rem; }
      .text-2xl { font-size: 1.25rem; }
      .text-lg { font-size: 1rem; }
    }
    
    /* Truncate text helper */
    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body x-data="app()" x-init="init()">
  
  <!-- PIN de acceso -->
  <template x-if="pinLocked">
    <div class="onboarding-screen" style="justify-content: center;">
      <div class="text-center">
        <div class="text-6xl mb-4">üîí</div>
        <h1 class="text-2xl font-bold mb-2" x-text="isCreatingPin ? 'Crea tu PIN' : 'Introduce tu PIN'"></h1>
        <p class="mb-6" style="color: var(--text-secondary);" x-text="isCreatingPin ? 'Elige 4 d√≠gitos para proteger tu app' : 'Acceso protegido'"></p>
        
        <!-- Indicadores de d√≠gitos -->
        <div class="flex justify-center gap-4 mb-6">
          <template x-for="i in 4" :key="i">
            <div class="w-4 h-4 rounded-full" :style="pinValue.length >= i ? 'background: var(--accent)' : 'background: #e2e8f0'"></div>
          </template>
        </div>
        
        <!-- Error -->
        <div x-show="pinError" class="text-red-500 mb-4 font-semibold" x-text="pinError"></div>
        
        <!-- Teclado num√©rico -->
        <div class="grid grid-cols-3 gap-3 max-w-xs mx-auto">
          <template x-for="n in [1,2,3,4,5,6,7,8,9,null,0,'del']" :key="n">
            <button 
              @click="handlePinInput(n)" 
              class="h-16 rounded-2xl text-2xl font-bold"
              :class="n === null ? 'invisible' : 'bg-gray-100 active:bg-gray-200'"
              :disabled="n === null"
              x-text="n === 'del' ? '‚å´' : n"
            ></button>
          </template>
        </div>
        
        <!-- Confirmar al crear -->
        <template x-if="isCreatingPin && pinValue.length === 4">
          <button @click="saveNewPin()" class="btn btn-primary w-full max-w-xs mx-auto mt-6">
            Confirmar PIN
          </button>
        </template>
      </div>
    </div>
  </template>
  
  <!-- M7: Onboarding para primer uso -->
  <template x-if="showOnboarding && !pinLocked">
    <div class="onboarding-screen">
      <div class="flex-1 flex flex-col justify-center">
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">üí™</div>
          <h1 class="text-2xl font-bold mb-2">¬°Bienvenido!</h1>
          <p style="color: var(--text-secondary);">Configura tu nivel para personalizar los entrenamientos</p>
        </div>
        
        <div class="space-y-4">
          <button @click="setInitialLevel(1)" class="w-full p-5 rounded-2xl border-2 text-left" :class="onboardingLevel === 1 ? 'border-green-500 bg-green-50' : 'border-gray-200'">
            <div class="flex items-center gap-4">
              <span class="text-3xl">üå±</span>
              <div>
                <div class="font-bold text-lg">Principiante</div>
                <div style="color: var(--text-secondary);">Menos de 1 a√±o entrenando</div>
                <div class="text-sm mt-1" style="color: var(--text-muted);">Descansos largos, intensidad moderada</div>
              </div>
            </div>
          </button>
          
          <button @click="setInitialLevel(2)" class="w-full p-5 rounded-2xl border-2 text-left" :class="onboardingLevel === 2 ? 'border-green-500 bg-green-50' : 'border-gray-200'">
            <div class="flex items-center gap-4">
              <span class="text-3xl">üí™</span>
              <div>
                <div class="font-bold text-lg">Intermedio</div>
                <div style="color: var(--text-secondary);">1-3 a√±os entrenando</div>
                <div class="text-sm mt-1" style="color: var(--text-muted);">Descansos medios, intensidad alta</div>
              </div>
            </div>
          </button>
          
          <button @click="setInitialLevel(3)" class="w-full p-5 rounded-2xl border-2 text-left" :class="onboardingLevel === 3 ? 'border-green-500 bg-green-50' : 'border-gray-200'">
            <div class="flex items-center gap-4">
              <span class="text-3xl">üî•</span>
              <div>
                <div class="font-bold text-lg">Avanzado</div>
                <div style="color: var(--text-secondary);">M√°s de 3 a√±os entrenando</div>
                <div class="text-sm mt-1" style="color: var(--text-muted);">Descansos cortos, m√°xima intensidad</div>
              </div>
            </div>
          </button>
        </div>
      </div>
      
      <button @click="completeOnboarding()" class="btn btn-primary w-full" :disabled="!onboardingLevel">
        Comenzar
      </button>
    </div>
  </template>

  <!-- Header -->
  <header x-show="!showOnboarding && !pinLocked">
    <div class="flex items-center justify-between">
      <h1 x-text="screenTitles[currentScreen]"></h1>
      <div class="flex items-center gap-3">
        <template x-if="currentSession && currentScreen === 'home'">
          <button @click="showCancelModal = true" class="action-btn" style="background: #fee2e2; color: #dc2626;">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </template>
        <button @click="showBackupModal = true" class="action-btn action-btn-default relative" x-show="currentScreen === 'home'">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          <span x-show="needsBackupReminder()" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full"></span>
        </button>
      </div>
    </div>
  </header>
  
  <!-- M8: Cron√≥metro de sesi√≥n con tiempo restante -->
  <template x-if="currentSession && currentScreen === 'home'">
    <div class="session-timer">
      <div class="flex items-center gap-2">
        <span>‚è±Ô∏è</span>
        <span x-text="formatSessionTime(sessionElapsed)"></span>
        <span style="color: var(--text-muted);">|</span>
        <span style="color: var(--accent);" x-text="'~' + getEstimatedRemaining() + ' min'"></span>
      </div>
    </div>
  </template>

  <!-- ==================== HOME ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'home' && !showOnboarding && !pinLocked }">
    
    <!-- Paso 1: Elegir ubicaci√≥n -->
    <template x-if="!todayCheckin">
      <div class="card mb-5">
        <h2 class="text-lg font-bold mb-5">¬øD√≥nde entrenas hoy?</h2>
        <div class="flex gap-4 mb-5">
          <button @click="checkinForm.ubicacion = 'gym'" class="location-btn" :class="{ 'selected': checkinForm.ubicacion === 'gym' }">
            <div class="text-3xl mb-2">üèãÔ∏è</div>
            <div class="font-semibold text-lg">Gimnasio</div>
          </button>
          <button @click="checkinForm.ubicacion = 'casa'" class="location-btn" :class="{ 'selected': checkinForm.ubicacion === 'casa' }">
            <div class="text-3xl mb-2">üè†</div>
            <div class="font-semibold text-lg">Casa</div>
          </button>
        </div>
        
        <template x-if="checkinForm.ubicacion === 'casa' && !tieneMaterialCasa()">
          <div class="info-box warning mb-5">
            <div class="font-semibold">‚ö†Ô∏è No tienes material configurado</div>
            <p class="text-sm mt-1" style="color: var(--text-secondary);">Ve a Ajustes ‚Üí Material en casa</p>
          </div>
        </template>
        
        <!-- M5: Recordatorio de descarga -->
        <template x-if="shouldShowDeloadReminder()">
          <div class="info-box mb-5" style="border-left-color: #8b5cf6; background: #f5f3ff;">
            <div class="font-semibold">üßò ¬øSemana de descarga?</div>
            <p class="text-sm mt-1" style="color: var(--text-secondary);">
              Llevas <span class="font-bold" x-text="profile.weeksWithoutDeload || 0"></span> semanas entrenando. 
              Considera una semana m√°s suave.
            </p>
            <div class="flex gap-2 mt-3">
              <button @click="dismissDeloadReminder()" class="btn btn-sm btn-secondary flex-1">Me siento bien</button>
              <button @click="acceptDeload()" class="btn btn-sm btn-primary flex-1">S√≠, ir suave</button>
            </div>
          </div>
        </template>
        
        <button @click="showCheckinModal = true" class="btn btn-primary w-full" :disabled="!checkinForm.ubicacion">
          Continuar
        </button>
      </div>
    </template>
    
    <!-- Estado de hoy -->
    <template x-if="todayCheckin && !currentSession">
      <div>
        <div class="card mb-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <span class="text-2xl" x-text="todayCheckin.ubicacion === 'gym' ? 'üèãÔ∏è' : 'üè†'"></span>
              <span style="color: var(--text-secondary);" x-text="todayCheckin.ubicacion === 'gym' ? 'Gimnasio' : 'Casa'"></span>
              <span class="badge badge-nivel" x-text="getNivelLabel(profile.nivel)"></span>
              <template x-if="todayCheckin.deloadWeek">
                <span class="badge" style="background: #f5f3ff; color: #7c3aed;">üßò Descarga</span>
              </template>
            </div>
            <button @click="resetCheckin()" class="btn btn-sm btn-secondary">Cambiar</button>
          </div>
          
          <!-- M6: Aviso visual cuando dolor supera umbral -->
          <template x-if="todayCheckin.dolorRodilla >= profile.umbralRodilla || todayCheckin.dolorCuello >= profile.umbralCuello">
            <div class="info-box warning mb-4">
              <div class="font-semibold">‚ö†Ô∏è Dolor elevado detectado</div>
              <p class="text-sm mt-1" style="color: var(--text-secondary);">
                <template x-if="todayCheckin.dolorRodilla >= profile.umbralRodilla">
                  <span>Rodilla: <span x-text="todayCheckin.dolorRodilla + '/10'"></span> ¬∑ </span>
                </template>
                <template x-if="todayCheckin.dolorCuello >= profile.umbralCuello">
                  <span>Cuello: <span x-text="todayCheckin.dolorCuello + '/10'"></span></span>
                </template>
                <br>Se han adaptado los ejercicios autom√°ticamente.
              </p>
            </div>
          </template>
          
          <div class="flex items-center gap-4">
            <span class="text-3xl" x-text="getStateEmoji(todayCheckin.estado)"></span>
            <div class="flex-1 grid grid-cols-2 gap-3" style="color: var(--text-secondary);">
              <div>Rodilla: <span class="font-bold" :class="todayCheckin.dolorRodilla >= profile.umbralRodilla ? 'text-orange-600' : ''" x-text="todayCheckin.dolorRodilla + '/10'"></span></div>
              <div>Cuello: <span class="font-bold" :class="todayCheckin.dolorCuello >= profile.umbralCuello ? 'text-orange-600' : ''" x-text="todayCheckin.dolorCuello + '/10'"></span></div>
            </div>
          </div>
        </div>
        
        <div class="card mb-5">
          <div class="flex items-center gap-4 mb-4">
            <div class="day-badge" :class="'day-' + nextDayType.toLowerCase()" x-text="nextDayType"></div>
            <div>
              <div class="text-lg font-bold" x-text="getDayTitle(nextDayType)"></div>
              <div style="color: var(--text-secondary);">
                ~<span x-text="todayCheckin.tiempo"></span> min ¬∑ 
                <span x-text="getPreviewExerciseCount()"></span> ejercicios
              </div>
            </div>
          </div>
          
          <div class="mb-5">
            <button @click="showPreview = !showPreview" class="btn btn-secondary w-full">
              <span x-text="showPreview ? '‚ñº Ocultar ejercicios' : '‚ñ∂ Ver ejercicios'"></span>
            </button>
            
            <template x-if="showPreview">
              <div class="bg-gray-50 rounded-xl p-4 mt-4" style="background: #f8fafc;">
                <template x-for="block in getPreviewBlocks()" :key="block.name">
                  <div class="mb-4">
                    <div class="font-bold uppercase text-sm tracking-wide mb-2 flex items-center gap-2" style="color: var(--text-secondary);">
                      <span x-text="block.name"></span>
                      <span class="badge" :class="'badge-' + block.tipo" x-text="block.badge" x-show="block.badge"></span>
                    </div>
                    <template x-for="ex in block.exercises" :key="ex.id">
                      <div class="flex items-center gap-2 py-2 border-b" style="border-color: #e2e8f0;">
                        <span style="color: var(--text-muted);">‚Ä¢</span>
                        <span class="font-semibold" x-text="ex.name"></span>
                        <span style="color: var(--text-muted);" x-text="ex.prescription"></span>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
          
          <template x-if="!isSessionValid()">
            <div class="info-box error mb-5">
              <div class="font-semibold">‚ùå No hay suficientes ejercicios</div>
              <p class="text-sm mt-1" style="color: var(--text-secondary);" x-text="getSessionError()"></p>
            </div>
          </template>
          
          <button @click="generateSession()" class="btn btn-primary w-full" :disabled="!isSessionValid()">
            Empezar entrenamiento
          </button>
        </div>
        
        <div class="card">
          <h3 class="text-lg font-bold mb-4">Tu semana</h3>
          <div class="space-y-3">
            <template x-for="d in ['A', 'B', 'C']" :key="d">
              <div class="flex items-center gap-4 p-3 rounded-xl" :style="nextDayType === d ? 'background: ' + (d === 'A' ? '#ecfdf5' : d === 'B' ? '#eff6ff' : '#fffbeb') : ''">
                <div class="day-badge" :class="'day-' + d.toLowerCase()" style="width:44px;height:44px;font-size:1.25rem;" x-text="d"></div>
                <div class="flex-1">
                  <div class="font-semibold" x-text="getDayTitle(d)"></div>
                  <div style="color: var(--text-secondary);" x-text="getDaySubtitle(d)"></div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>
    
    <!-- Sesi√≥n activa -->
    <template x-if="currentSession">
      <div style="padding-top: 50px;">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-4">
            <div class="day-badge" :class="'day-' + currentSession.dayType.toLowerCase()" x-text="currentSession.dayType"></div>
            <div>
              <div class="text-lg font-bold" x-text="getDayTitle(currentSession.dayType)"></div>
              <div style="color: var(--text-secondary);">
                <span class="font-bold" x-text="getCompletedCount()"></span>/<span x-text="getTotalCount()"></span> ejercicios
              </div>
            </div>
          </div>
          <button @click="showPainModal = true" class="btn btn-danger btn-sm">Me duele</button>
        </div>
        
        <template x-for="(block, blockIdx) in currentSession.blocks" :key="blockIdx">
          <div class="mb-6" x-show="block.exercises.filter(e => !e.removed).length > 0">
            <h3 class="font-bold uppercase tracking-wide mb-3 flex items-center gap-3" style="color: var(--text-secondary);">
              <span x-text="block.name"></span>
              <span class="badge" :class="'badge-' + block.tipo" x-text="block.badge" x-show="block.tipo"></span>
            </h3>
            
            <template x-if="block.instruccion">
              <p class="mb-3 italic" style="color: var(--text-secondary);" x-text="block.instruccion"></p>
            </template>
            
            <template x-for="(exercise, exIdx) in block.exercises" :key="exercise.id + '-' + exIdx">
              <div class="exercise-card" :class="{ 'completed': exercise.completed, 'postponed': exercise.postponed, [block.tipo]: block.tipo }" x-show="!exercise.postponed && !exercise.removed">
                <div class="flex items-start justify-between gap-3 mb-3">
                  <div class="flex-1">
                    <a :href="'https://www.google.com/search?q=' + encodeURIComponent(exercise.name + ' ejercicio')" target="_blank" class="exercise-link" x-text="exercise.name"></a>
                    <div style="color: var(--text-secondary);" x-text="exercise.prescription"></div>
                    <template x-if="getLastValue(exercise.id)">
                      <div class="mt-2 text-sm" style="color: var(--accent);">
                        üí° √öltimo: <span class="font-bold" x-text="getLastValue(exercise.id)"></span>
                        <template x-if="getProgressionHint(exercise.id)">
                          <span class="ml-2 font-semibold" :style="'color: ' + getProgressionHint(exercise.id).color" x-text="getProgressionHint(exercise.id).text"></span>
                        </template>
                      </div>
                    </template>
                  </div>
                  
                  <div class="flex items-center gap-2">
                    <template x-if="!exercise.completed && !exercise.postponed">
                      <button @click="postponeExercise(blockIdx, exIdx)" class="action-btn action-btn-default">‚è≠Ô∏è</button>
                    </template>
                    <button @click="completeExercise(blockIdx, exIdx)" class="action-btn" :class="exercise.completed ? 'action-btn-complete' : 'action-btn-default'">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <!-- M1, M2: Tracking mejorado con placeholders claros -->
                <template x-if="exercise.trackSets && exercise.sets && !exercise.postponed && exercise.trackType !== 'none'">
                  <div class="mt-4 pt-4 border-t-2" style="border-color: #f1f5f9;">
                    <div class="grid gap-3 text-sm font-semibold mb-3" :class="exercise.trackType === 'bodyweight' ? 'grid-cols-3' : 'grid-cols-4'" style="color: var(--text-secondary);">
                      <span>Set</span>
                      <template x-if="exercise.trackType !== 'bodyweight'">
                        <span x-text="getTrackLabel(exercise.trackType)"></span>
                      </template>
                      <span>Reps</span>
                      <span>RIR</span>
                    </div>
                    <template x-for="(set, setIdx) in exercise.sets" :key="setIdx">
                      <div class="grid gap-3 mb-3" :class="exercise.trackType === 'bodyweight' ? 'grid-cols-3' : 'grid-cols-4'">
                        <span class="flex items-center justify-center font-bold text-lg" x-text="setIdx + 1"></span>
                        <template x-if="exercise.trackType !== 'bodyweight'">
                          <div>
                            <input type="text" x-model="set.value" @change="saveSession()" class="input py-2 px-3 text-center" :placeholder="getTrackPlaceholder(exercise.trackType)">
                          </div>
                        </template>
                        <input type="number" x-model.number="set.reps" @change="saveSession()" class="input py-2 px-3 text-center" placeholder="reps">
                        <input type="number" x-model.number="set.rir" @change="saveSession()" class="input py-2 px-3 text-center" placeholder="rir">
                      </div>
                    </template>
                  </div>
                </template>
                
                <!-- M4: Campo de minutos para cardio -->
                <template x-if="exercise.trackType === 'cardio' && !exercise.postponed">
                  <div class="mt-4 pt-4 border-t-2" style="border-color: #f1f5f9;">
                    <div class="flex items-center gap-3">
                      <span class="font-semibold" style="color: var(--text-secondary);">Minutos realizados:</span>
                      <input type="number" x-model.number="exercise.minutesCompleted" @change="saveSession()" class="input py-2 px-3 text-center w-24" placeholder="min">
                    </div>
                  </div>
                </template>
                
                <!-- Isom√©tricos con timer (plancha lateral, etc.) -->
                <template x-if="exercise.trackType === 'isometrico' && !exercise.postponed">
                  <div class="mt-4 pt-4 border-t-2" style="border-color: #f1f5f9;">
                    <div class="text-center mb-3">
                      <p class="text-sm mb-2" style="color: var(--text-secondary);">
                        <span x-text="exercise.prescription"></span>
                      </p>
                      <div class="flex justify-center gap-2 mb-3">
                        <button @click="startIsometricTimer(exercise, 'izq')" class="btn btn-primary flex-1">
                          ‚è±Ô∏è Lado izquierdo
                        </button>
                        <button @click="startIsometricTimer(exercise, 'der')" class="btn btn-secondary flex-1">
                          ‚è±Ô∏è Lado derecho
                        </button>
                      </div>
                      <p class="text-xs" style="color: var(--text-muted);">
                        üí° <strong>Progresi√≥n:</strong> Empieza con 20-30s. Cuando aguantes 45s f√°cil, prueba con pierna elevada o a√±ade rotaci√≥n.
                      </p>
                    </div>
                  </div>
                </template>
                
                <!-- Timer descanso -->
                <template x-if="exercise.restTime && !exercise.postponed">
                  <button @click="startTimer(exercise.restTime)" class="btn btn-secondary w-full mt-3">
                    ‚è±Ô∏è Descanso <span class="font-bold" x-text="exercise.restTime + 's'"></span>
                  </button>
                </template>
                
                <!-- B2: Alternativas filtradas por ubicaci√≥n -->
                <template x-if="exercise.substitutes && exercise.substitutes.length > 0 && !exercise.postponed">
                  <div class="mt-4 pt-4 border-t-2" style="border-color: #f1f5f9;">
                    <button @click="exercise.showSubs = !exercise.showSubs" style="color: var(--accent);" class="font-semibold">
                      <span x-text="exercise.showSubs ? '‚ñº Ocultar alternativas' : '‚ÜîÔ∏è Ver alternativas'"></span>
                    </button>
                    <template x-if="exercise.showSubs">
                      <div class="mt-3 flex flex-wrap gap-2">
                        <template x-for="sub in exercise.substitutes" :key="sub">
                          <button @click="swapExercise(blockIdx, exIdx, sub)" class="btn btn-secondary btn-sm" x-text="sub"></button>
                        </template>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
        
        <button @click="confirmFinish()" class="btn btn-primary w-full mb-5">‚úì Finalizar</button>
      </div>
    </template>
  </div>
  
  <!-- Barra pospuestos -->
  <template x-if="currentSession && getPostponedExercises().length > 0">
    <div class="postponed-bar">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-xl">‚è≥</span>
          <span class="font-semibold" x-text="getPostponedExercises().length + ' pospuesto(s)'"></span>
        </div>
        <button @click="showPostponedModal = true" class="btn btn-warning btn-sm">Ver</button>
      </div>
    </div>
  </template>

  <!-- ==================== AJUSTES ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'settings' && !showOnboarding && !pinLocked }">
    <div class="space-y-5">
      
      <!-- Nivel -->
      <div class="card">
        <h3 class="text-lg font-bold mb-2">Tu nivel</h3>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">Ajusta descansos e intensidad</p>
        <div class="grid grid-cols-3 gap-2">
          <button @click="profile.nivel = 1; saveProfile()" class="level-btn" :class="{ 'selected': profile.nivel === 1 }">
            <div class="text-2xl mb-1">üå±</div>
            <div class="font-bold">Principiante</div>
          </button>
          <button @click="profile.nivel = 2; saveProfile()" class="level-btn" :class="{ 'selected': profile.nivel === 2 }">
            <div class="text-2xl mb-1">üí™</div>
            <div class="font-bold">Intermedio</div>
          </button>
          <button @click="profile.nivel = 3; saveProfile()" class="level-btn" :class="{ 'selected': profile.nivel === 3 }">
            <div class="text-2xl mb-1">üî•</div>
            <div class="font-bold">Avanzado</div>
          </button>
        </div>
        
        <div class="mt-4 p-3 rounded-xl" style="background: #f8fafc;">
          <div class="text-sm font-semibold mb-2">Con tu nivel:</div>
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
            <div>
              <div class="font-bold" style="color: var(--accent);" x-text="getNivelConfig().descansoFuerza + 's'"></div>
              <div class="text-xs" style="color: var(--text-muted);">Descanso</div>
            </div>
            <div>
              <div class="font-bold" style="color: var(--accent);" x-text="getNivelConfig().seriesExtra ? '+1' : 'Normal'"></div>
              <div class="text-xs" style="color: var(--text-muted);">Series</div>
            </div>
            <div>
              <div class="font-bold" style="color: var(--accent);" x-text="getNivelConfig().intensidad"></div>
              <div class="text-xs" style="color: var(--text-muted);">Intensidad</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Restricciones -->
      <div class="card">
        <h3 class="text-lg font-bold mb-4">Restricciones de salud</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between gap-3 py-2">
            <span class="flex-1 min-w-0">Problemas cervicales</span>
            <div class="toggle flex-shrink-0" :class="{ 'active': profile.problemasCuello }" @click="profile.problemasCuello = !profile.problemasCuello; saveProfile()" tabindex="0" role="switch" :aria-checked="profile.problemasCuello"></div>
          </div>
          <div class="flex items-center justify-between gap-3 py-2">
            <span class="flex-1 min-w-0">Tendinopat√≠a rotuliana</span>
            <div class="toggle flex-shrink-0" :class="{ 'active': profile.tendinopatiaRodilla }" @click="profile.tendinopatiaRodilla = !profile.tendinopatiaRodilla; saveProfile()" tabindex="0" role="switch" :aria-checked="profile.tendinopatiaRodilla"></div>
          </div>
        </div>
      </div>
      
      <!-- Umbrales -->
      <div class="card">
        <h3 class="text-lg font-bold mb-4">Umbrales de dolor</h3>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">Si superas este nivel, se adaptan los ejercicios</p>
        <div class="space-y-6">
          <div>
            <div class="flex justify-between items-center mb-3">
              <span class="font-semibold">Rodilla</span>
              <span class="font-bold text-lg px-3 py-1 rounded-lg" style="background: #fef3c7;" x-text="profile.umbralRodilla + '/10'"></span>
            </div>
            <input type="range" class="slider" min="1" max="10" x-model.number="profile.umbralRodilla" @change="saveProfile()">
          </div>
          <div>
            <div class="flex justify-between items-center mb-3">
              <span class="font-semibold">Cuello</span>
              <span class="font-bold text-lg px-3 py-1 rounded-lg" style="background: #fef3c7;" x-text="profile.umbralCuello + '/10'"></span>
            </div>
            <input type="range" class="slider" min="1" max="10" x-model.number="profile.umbralCuello" @change="saveProfile()">
          </div>
        </div>
      </div>
      
      <!-- Material casa -->
      <div class="card">
        <h3 class="text-lg font-bold mb-2">üè† Material en casa</h3>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">Marca lo que tengas</p>
        <div class="space-y-4">
          <template x-for="key in Object.keys(materialNames)" :key="key">
            <div class="py-2 border-b" style="border-color: #f1f5f9;" x-show="materialCasa[key]">
              <div class="flex items-center justify-between gap-3">
                <span class="font-semibold flex-1 min-w-0 truncate" x-text="materialNames[key]"></span>
                <div class="toggle flex-shrink-0" :class="{ 'active': materialCasa[key]?.tiene }" @click="materialCasa[key].tiene = !materialCasa[key].tiene; saveMaterial()" tabindex="0" role="switch" :aria-checked="materialCasa[key]?.tiene"></div>
              </div>
              <template x-if="materialCasa[key]?.tiene && materialCasa[key]?.configType === 'peso'">
                <div class="mt-3">
                  <label class="text-sm block mb-1" style="color: var(--text-secondary);">Pesos disponibles (kg)</label>
                  <input type="text" class="input" placeholder="ej: 5, 10, 15, 20" x-model="materialCasa[key].config" @change="saveMaterial()">
                </div>
              </template>
              <template x-if="materialCasa[key]?.tiene && materialCasa[key]?.configType === 'banda'">
                <div class="mt-3">
                  <label class="text-sm block mb-1" style="color: var(--text-secondary);">Colores/resistencias</label>
                  <input type="text" class="input" placeholder="ej: amarilla, roja, negra" x-model="materialCasa[key].config" @change="saveMaterial()">
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Backup -->
      <div class="card">
        <h3 class="text-lg font-bold mb-4">Backup</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between gap-3 py-2">
            <div class="flex-1 min-w-0">
              <span class="font-semibold block">Auto-backup</span>
              <span class="text-sm" style="color: var(--text-secondary);">Descarga al terminar</span>
            </div>
            <div class="toggle flex-shrink-0" :class="{ 'active': profile.autoBackup }" @click="profile.autoBackup = !profile.autoBackup; saveProfile()" tabindex="0" role="switch" :aria-checked="profile.autoBackup"></div>
          </div>
          <div class="py-2 px-3 rounded-lg" style="background: #f8fafc; color: var(--text-secondary);">
            √öltimo backup: <span class="font-semibold" x-text="getLastBackupDate()"></span>
          </div>
        </div>
      </div>
      
      <div class="card" style="border-color: #fecaca;">
        <h3 class="text-lg font-bold mb-4" style="color: #dc2626;">Zona peligrosa</h3>
        <button @click="confirmReset()" class="btn btn-danger w-full">üóëÔ∏è Borrar todos los datos</button>
      </div>
    </div>
  </div>

  <!-- ==================== STATS ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'stats' && !showOnboarding && !pinLocked }">
    <div class="space-y-5">
      
      <!-- RACHA Y CONSISTENCIA -->
      <div class="card">
        <div class="grid grid-cols-2 gap-4 text-center">
          <div>
            <div class="text-4xl font-bold" style="color: var(--accent);" x-text="getStreak()"></div>
            <div style="color: var(--text-secondary);">üî• Semanas racha</div>
          </div>
          <div>
            <div class="text-4xl font-bold" x-text="getSessionsThisYear()"></div>
            <div style="color: var(--text-secondary);">üìÖ Sesiones a√±o</div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t-2" style="border-color: #f1f5f9;">
          <div class="flex justify-between text-sm">
            <span style="color: var(--text-secondary);">Este mes</span>
            <span class="font-bold" x-text="getSessionsThisMonth() + ' sesiones'"></span>
          </div>
          <div class="flex justify-between text-sm mt-1">
            <span style="color: var(--text-secondary);">Media semanal</span>
            <span class="font-bold" x-text="getAvgSessionsPerWeek() + ' / semana'"></span>
          </div>
        </div>
      </div>
      
      <!-- TUS PRs -->
      <div class="card">
        <h3 class="text-lg font-bold mb-4">üí™ Tus PRs</h3>
        <div class="space-y-3">
          <template x-for="exId in prExercises" :key="exId">
            <div class="flex items-center justify-between py-2 border-b" style="border-color: #f1f5f9;">
              <div class="flex items-center gap-3">
                <button @click="selectedPRExercise = exId" 
                        class="w-8 h-8 rounded-full flex items-center justify-center text-sm"
                        :style="selectedPRExercise === exId ? 'background: var(--accent); color: white;' : 'background: #f1f5f9;'">
                  üìà
                </button>
                <span class="font-medium" x-text="getPRExerciseName(exId)"></span>
              </div>
              <div class="text-right">
                <template x-if="getPR(exId)">
                  <div>
                    <span class="text-xl font-bold" style="color: var(--accent);" x-text="getPR(exId).value"></span>
                    <span class="text-sm" style="color: var(--text-secondary);" x-text="getPRUnit(exId)"></span>
                    <div class="text-xs" style="color: var(--text-muted);" x-text="formatPRDate(getPR(exId).date)"></div>
                  </div>
                </template>
                <template x-if="!getPR(exId)">
                  <span class="text-sm" style="color: var(--text-muted);">Sin datos</span>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
      
      <!-- GR√ÅFICO EVOLUCI√ìN PR -->
      <div class="card">
        <h3 class="text-lg font-bold mb-2">üìà Evoluci√≥n: <span x-text="getPRExerciseName(selectedPRExercise)"></span></h3>
        <template x-if="getPRHistory(selectedPRExercise).length > 1">
          <div>
            <div class="flex items-end gap-1 h-32 mt-4 mb-2" style="border-bottom: 2px solid #e2e8f0;">
              <template x-for="(entry, idx) in getPRHistory(selectedPRExercise).slice(-20)" :key="idx">
                <div class="flex-1 rounded-t transition-all"
                     :style="'background: var(--accent); height: ' + getPRBarHeight(selectedPRExercise, entry.value) + '%;'"
                     :title="entry.value + ' ' + getPRUnit(selectedPRExercise) + ' - ' + entry.date">
                </div>
              </template>
            </div>
            <div class="flex justify-between text-xs" style="color: var(--text-muted);">
              <span x-text="getPRHistory(selectedPRExercise).length > 0 ? getPRHistory(selectedPRExercise)[Math.max(0, getPRHistory(selectedPRExercise).length - 20)].date : ''"></span>
              <span x-text="getPRHistory(selectedPRExercise).length > 0 ? getPRHistory(selectedPRExercise)[getPRHistory(selectedPRExercise).length - 1].date : ''"></span>
            </div>
            <div class="mt-3 text-center">
              <span class="text-sm" style="color: var(--text-secondary);">Progreso total: </span>
              <span class="font-bold" :style="getPRProgress(selectedPRExercise) >= 0 ? 'color: var(--accent);' : 'color: var(--danger);'">
                <span x-text="getPRProgress(selectedPRExercise) >= 0 ? '+' : ''"></span><span x-text="getPRProgress(selectedPRExercise)"></span>
                <span x-text="getPRUnit(selectedPRExercise)"></span>
              </span>
            </div>
          </div>
        </template>
        <template x-if="getPRHistory(selectedPRExercise).length <= 1">
          <p class="text-center py-8" style="color: var(--text-muted);">
            Entrena m√°s veces para ver la evoluci√≥n
          </p>
        </template>
      </div>
      
      <!-- TOTAL HIST√ìRICO (simplificado) -->
      <div class="card">
        <div class="flex justify-between items-center">
          <span style="color: var(--text-secondary);">Total sesiones registradas</span>
          <span class="text-2xl font-bold" x-text="recentSessions.length"></span>
        </div>
      </div>
      
    </div>
  </div>

  <!-- ==================== PANTALLA MOVILIDAD ==================== -->
  <div class="screen" :class="{ 'active': currentScreen === 'mobility' && !showOnboarding && !pinLocked }">
    <div class="space-y-4">
      
      <!-- Selector de rutina -->
      <template x-if="!mobilitySession.active">
        <div class="space-y-4">
          <div class="card">
            <h3 class="text-lg font-bold mb-2">Elige tu rutina</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">Ejercicios espec√≠ficos para tu contexto: pies cavos, cifosis, parestesias y rigidez.</p>
            
            <div class="space-y-3">
              <button @click="startMobilityRoutine('morning')" class="w-full p-4 rounded-2xl border-2 text-left" style="border-color: #fbbf24; background: #fffbeb;">
                <div class="flex items-center gap-4">
                  <span class="text-3xl">‚òÄÔ∏è</span>
                  <div class="flex-1">
                    <div class="font-bold text-lg">Ma√±ana</div>
                    <div class="text-sm" style="color: var(--text-secondary);">Quitar rigidez matutina</div>
                  </div>
                  <span class="font-bold" style="color: var(--text-muted);">5 min</span>
                </div>
              </button>
              
              <button @click="startMobilityRoutine('micropause')" class="w-full p-4 rounded-2xl border-2 text-left" style="border-color: #60a5fa; background: #eff6ff;">
                <div class="flex items-center gap-4">
                  <span class="text-3xl">üíª</span>
                  <div class="flex-1">
                    <div class="font-bold text-lg">Micro-pausa</div>
                    <div class="text-sm" style="color: var(--text-secondary);">Cada hora de oficina</div>
                  </div>
                  <span class="font-bold" style="color: var(--text-muted);">2 min</span>
                </div>
              </button>
              
              <button @click="startMobilityRoutine('rest')" class="w-full p-4 rounded-2xl border-2 text-left" style="border-color: #a78bfa; background: #f5f3ff;">
                <div class="flex items-center gap-4">
                  <span class="text-3xl">üåô</span>
                  <div class="flex-1">
                    <div class="font-bold text-lg">D√≠a de descanso</div>
                    <div class="text-sm" style="color: var(--text-secondary);">Restauraci√≥n completa</div>
                  </div>
                  <span class="font-bold" style="color: var(--text-muted);">12 min</span>
                </div>
              </button>
            </div>
          </div>
          
          <!-- Info -->
          <div class="card" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5);">
            <h4 class="font-bold mb-2">üí° Recomendaci√≥n</h4>
            <ul class="text-sm space-y-1" style="color: var(--text-secondary);">
              <li>‚Ä¢ <strong>Ma√±ana</strong>: Todos los d√≠as al despertar</li>
              <li>‚Ä¢ <strong>Micro-pausa</strong>: Cada 45-60 min sentado</li>
              <li>‚Ä¢ <strong>Descanso</strong>: D√≠as sin entrenamiento</li>
            </ul>
          </div>
        </div>
      </template>
      
      <!-- Rutina activa -->
      <template x-if="mobilitySession.active">
        <div class="space-y-4">
          <!-- Header rutina -->
          <div class="card">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-lg font-bold" x-text="getMobilityRoutineTitle()"></h3>
                <p class="text-sm" style="color: var(--text-secondary);" x-text="'Ejercicio ' + (mobilitySession.currentIndex + 1) + ' de ' + mobilitySession.exercises.length"></p>
              </div>
              <button @click="cancelMobilitySession()" class="action-btn" style="background: #fee2e2; color: #dc2626;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            
            <!-- Progress bar -->
            <div class="w-full h-2 rounded-full" style="background: #e2e8f0;">
              <div class="h-2 rounded-full transition-all" style="background: var(--accent);" :style="'width: ' + ((mobilitySession.currentIndex) / mobilitySession.exercises.length * 100) + '%'"></div>
            </div>
          </div>
          
          <!-- Ejercicio actual -->
          <div class="card">
            <div class="text-center py-4">
              <div class="text-5xl mb-4" x-text="getCurrentMobilityExercise().emoji"></div>
              <h2 class="text-2xl font-bold mb-2" x-text="getCurrentMobilityExercise().name"></h2>
              <p class="text-lg mb-2" style="color: var(--accent);" x-text="getCurrentMobilityExercise().duration"></p>
              <p class="text-sm mb-4" style="color: var(--text-secondary);" x-text="getCurrentMobilityExercise().instruction"></p>
              
              <!-- Link a Google -->
              <a :href="'https://www.google.com/search?q=' + encodeURIComponent(getCurrentMobilityExercise().name + ' ejercicio')" 
                 target="_blank" 
                 class="inline-flex items-center gap-2 text-sm px-4 py-2 rounded-full mb-4"
                 style="background: #f1f5f9; color: var(--text-secondary);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                ¬øC√≥mo se hace?
              </a>
              
              <!-- Timer visual -->
              <template x-if="mobilityTimer.active">
                <div class="mb-4">
                  <!-- Label de serie/descanso/lado -->
                  <template x-if="getCurrentMobilityExercise().hasSets || getCurrentMobilityExercise().hasSides">
                    <div class="text-lg font-bold mb-2" :style="mobilityTimer.isResting ? 'color: #f59e0b;' : 'color: var(--accent);'" x-text="getMobilityTimerLabel()"></div>
                  </template>
                  <div class="text-6xl font-bold mb-2" :style="mobilityTimer.remaining <= 3 ? 'color: var(--danger);' : (mobilityTimer.isResting ? 'color: #f59e0b;' : 'color: var(--accent);')" x-text="mobilityTimer.remaining"></div>
                  <div class="w-full h-3 rounded-full" style="background: #e2e8f0;">
                    <div class="h-3 rounded-full transition-all" :style="'background: ' + (mobilityTimer.isResting ? '#f59e0b' : 'var(--accent)') + '; width: ' + (mobilityTimer.remaining / mobilityTimer.total * 100) + '%'"></div>
                  </div>
                </div>
              </template>
            </div>
            
            <!-- Botones -->
            <div class="flex gap-3">
              <template x-if="!mobilityTimer.active && getCurrentMobilityExercise().timed">
                <button @click="startMobilityTimer()" class="btn btn-primary flex-1">
                  ‚ñ∂Ô∏è Iniciar timer
                </button>
              </template>
              <template x-if="mobilityTimer.active">
                <button @click="skipMobilityTimer()" class="btn btn-secondary flex-1">
                  ‚è≠Ô∏è Saltar
                </button>
              </template>
              <template x-if="!getCurrentMobilityExercise().timed">
                <button @click="nextMobilityExercise()" class="btn btn-primary flex-1">
                  <span x-text="mobilitySession.currentIndex === mobilitySession.exercises.length - 1 ? '‚úÖ Finalizar' : '‚û°Ô∏è Siguiente'"></span>
                </button>
              </template>
            </div>
          </div>
          
          <!-- Lista de ejercicios -->
          <div class="card">
            <h4 class="font-semibold mb-3" style="color: var(--text-secondary);">Ejercicios</h4>
            <div class="space-y-2">
              <template x-for="(ex, idx) in mobilitySession.exercises" :key="idx">
                <div class="flex items-center gap-3 p-2 rounded-xl" :style="idx === mobilitySession.currentIndex ? 'background: #ecfdf5;' : (idx < mobilitySession.currentIndex ? 'opacity: 0.5;' : '')">
                  <span class="text-xl" x-text="idx < mobilitySession.currentIndex ? '‚úÖ' : ex.emoji"></span>
                  <span class="flex-1 text-sm" :class="idx === mobilitySession.currentIndex ? 'font-bold' : ''" x-text="ex.name"></span>
                  <span class="text-xs" style="color: var(--text-muted);" x-text="ex.duration"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
      </template>
      
    </div>
  </div>

  <!-- ==================== MODALES ==================== -->
  
  <!-- Check-in -->
  <div x-show="showCheckinModal" x-transition class="modal-overlay" @click.self="showCheckinModal = false">
    <div class="modal-content safe-bottom">
      <h2 class="modal-title">¬øC√≥mo est√°s hoy?</h2>
      
      <div class="space-y-6">
        <div>
          <label class="font-bold block mb-4">¬øCu√°nto tiempo tienes?</label>
          <div class="grid grid-cols-5 gap-2">
            <template x-for="t in [20, 30, 45, 60, 90]" :key="t">
              <button @click="checkinForm.tiempo = t" class="time-btn" :class="{ 'selected': checkinForm.tiempo === t }">
                <div class="text-lg font-bold" x-text="t"></div>
                <div class="text-xs" style="color: var(--text-muted);">min</div>
              </button>
            </template>
          </div>
        </div>
        
        <div>
          <div class="flex justify-between items-center mb-3">
            <label class="font-bold">Estado general</label>
            <span class="text-3xl" x-text="getStateEmoji(checkinForm.estado)"></span>
          </div>
          <input type="range" class="slider" min="1" max="5" x-model.number="checkinForm.estado">
        </div>
        
        <div>
          <div class="flex justify-between items-center mb-3">
            <label class="font-bold">Dolor rodilla</label>
            <span class="font-bold text-xl" :class="checkinForm.dolorRodilla >= profile.umbralRodilla ? 'text-orange-600' : ''" x-text="checkinForm.dolorRodilla + '/10'"></span>
          </div>
          <input type="range" class="slider" min="0" max="10" x-model.number="checkinForm.dolorRodilla">
          <template x-if="checkinForm.dolorRodilla >= profile.umbralRodilla">
            <p class="text-sm mt-1 text-orange-600">‚ö†Ô∏è Supera tu umbral. Se adaptar√°n los ejercicios.</p>
          </template>
        </div>
        
        <div>
          <div class="flex justify-between items-center mb-3">
            <label class="font-bold">Dolor cuello</label>
            <span class="font-bold text-xl" :class="checkinForm.dolorCuello >= profile.umbralCuello ? 'text-orange-600' : ''" x-text="checkinForm.dolorCuello + '/10'"></span>
          </div>
          <input type="range" class="slider" min="0" max="10" x-model.number="checkinForm.dolorCuello">
          <template x-if="checkinForm.dolorCuello >= profile.umbralCuello">
            <p class="text-sm mt-1 text-orange-600">‚ö†Ô∏è Supera tu umbral. Se adaptar√°n los ejercicios.</p>
          </template>
        </div>
        
        <template x-if="checkinForm.ubicacion === 'gym'">
          <div class="flex items-center justify-between gap-4">
            <div>
              <label class="font-bold">Gym saturado</label>
              <p class="text-sm" style="color: var(--text-secondary);">Priorizar√© peso libre</p>
            </div>
            <div class="toggle" :class="{ 'active': checkinForm.gymSaturado }" @click="checkinForm.gymSaturado = !checkinForm.gymSaturado" tabindex="0"></div>
          </div>
        </template>
      </div>
      
      <button @click="submitCheckin()" class="btn btn-primary w-full mt-6">Guardar</button>
    </div>
  </div>
  
  <!-- Timer flotante (no bloquea la app) -->
  <div x-show="showTimerModal" x-transition class="timer-float">
    <div class="timer-float-content">
      <div class="flex items-center gap-4">
        <!-- C√≠rculo de progreso mini -->
        <div class="relative w-14 h-14 flex-shrink-0">
          <svg class="progress-ring w-full h-full" viewBox="0 0 100 100">
            <circle class="bg" cx="50" cy="50" r="45"/>
            <circle class="progress" cx="50" cy="50" r="45" :stroke-dasharray="283" :stroke-dashoffset="283 - (283 * timerProgress / 100)"/>
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <span class="text-lg font-bold" :style="timerRemaining === 0 ? 'color: var(--accent)' : ''" x-text="timerRemaining"></span>
          </div>
        </div>
        
        <!-- Info -->
        <div class="flex-1">
          <div class="font-bold" x-text="timerRemaining === 0 ? '¬°Listo!' : (timerLabel || 'Descanso')"></div>
          <div class="text-sm" style="color: var(--text-secondary);" x-text="formatTimer(timerRemaining)"></div>
        </div>
        
        <!-- Botones -->
        <div class="flex items-center gap-2">
          <button @click="addTimerSeconds(-15)" class="timer-float-btn">-15</button>
          <button @click="addTimerSeconds(15)" class="timer-float-btn">+15</button>
          <button @click="stopTimer()" class="timer-float-btn-ok">OK</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Descanso entre ejercicios -->
  <div x-show="showRestBetweenModal" x-transition class="modal-overlay modal-center">
    <div class="modal-content modal-content-center text-center p-6">
      <p class="text-xl font-bold mb-2" style="color: var(--accent);">‚úì Ejercicio completado</p>
      <p class="mb-4" style="color: var(--text-secondary);">¬øDescansar antes del siguiente?</p>
      <div class="flex gap-3">
        <button @click="startRestBetween(30)" class="btn btn-secondary flex-1">30s</button>
        <button @click="startRestBetween(60)" class="btn btn-secondary flex-1">60s</button>
        <button @click="startRestBetween(90)" class="btn btn-secondary flex-1">90s</button>
      </div>
      <button @click="showRestBetweenModal = false" class="btn btn-primary w-full mt-4">Continuar</button>
    </div>
  </div>
  
  <!-- M3: Pain Modal mejorado con opci√≥n de quitar ejercicios -->
  <div x-show="showPainModal" x-transition class="modal-overlay modal-center" @click.self="showPainModal = false">
    <div class="modal-content modal-content-center">
      <h2 class="modal-title">¬øQu√© te duele?</h2>
      <div class="space-y-3">
        <button @click="selectPainArea('rodilla')" class="btn btn-secondary w-full justify-start text-lg">ü¶µ Rodilla</button>
        <button @click="selectPainArea('cuello')" class="btn btn-secondary w-full justify-start text-lg">ü¶¥ Cuello</button>
        <button @click="selectPainArea('espalda')" class="btn btn-secondary w-full justify-start text-lg">üîô Espalda baja</button>
        <button @click="selectPainArea('hombro')" class="btn btn-secondary w-full justify-start text-lg">üí™ Hombro</button>
      </div>
      <button @click="showPainModal = false" class="btn btn-secondary w-full mt-5">Cancelar</button>
    </div>
  </div>
  
  <!-- M3: Modal de confirmaci√≥n de dolor -->
  <div x-show="showPainConfirmModal" x-transition class="modal-overlay modal-center" @click.self="showPainConfirmModal = false">
    <div class="modal-content modal-content-center">
      <h2 class="modal-title">¬øQu√© quieres hacer?</h2>
      <p class="mb-4" style="color: var(--text-secondary);">
        Hay <span class="font-bold" x-text="getRelatedExercisesCount(selectedPainArea)"></span> ejercicios que podr√≠an afectar a tu <span class="font-bold" x-text="getPainAreaName(selectedPainArea)"></span>.
      </p>
      <div class="space-y-3">
        <button @click="handlePainShowAlternatives()" class="btn btn-secondary w-full">
          ‚ÜîÔ∏è Mostrar alternativas
        </button>
        <button @click="handlePainRemoveExercises()" class="btn btn-danger w-full">
          üóëÔ∏è Quitar estos ejercicios
        </button>
      </div>
      <button @click="showPainConfirmModal = false" class="btn btn-secondary w-full mt-5">Cancelar</button>
    </div>
  </div>
  
  <!-- Postponed -->
  <div x-show="showPostponedModal" x-transition class="modal-overlay" @click.self="showPostponedModal = false">
    <div class="modal-content safe-bottom" style="max-height: 70vh;">
      <h2 class="modal-title">‚è≥ Pospuestos</h2>
      <div class="space-y-4">
        <template x-for="ex in getPostponedExercises()" :key="ex.id">
          <div class="flex items-center justify-between gap-4 p-4 rounded-xl" style="background: #fffbeb;">
            <div>
              <div class="font-bold" x-text="ex.name"></div>
              <div style="color: var(--text-secondary);" x-text="ex.prescription"></div>
            </div>
            <button @click="restoreFromModal(ex)" class="btn btn-sm btn-primary">Hacer</button>
          </div>
        </template>
      </div>
      <button @click="showPostponedModal = false" class="btn btn-secondary w-full mt-5">Cerrar</button>
    </div>
  </div>
  
  <!-- Cancel -->
  <div x-show="showCancelModal" x-transition class="modal-overlay modal-center" @click.self="showCancelModal = false">
    <div class="modal-content modal-content-center">
      <h2 class="modal-title">¬øCancelar sesi√≥n?</h2>
      <p style="color: var(--text-secondary);" class="mb-5">Se perder√° el progreso.</p>
      <div class="space-y-3">
        <button @click="cancelSession()" class="btn btn-danger w-full">S√≠, cancelar</button>
        <button @click="showCancelModal = false" class="btn btn-secondary w-full">Continuar</button>
      </div>
    </div>
  </div>
  
  <!-- Finish -->
  <div x-show="showFinishModal" x-transition class="modal-overlay modal-center" @click.self="showFinishModal = false">
    <div class="modal-content modal-content-center">
      <h2 class="modal-title">¬øFinalizar sesi√≥n?</h2>
      
      <div class="text-center mb-4 p-4 rounded-xl" style="background: #f8fafc;">
        <div class="text-3xl font-bold mb-1" style="color: var(--accent);" x-text="formatSessionTime(sessionElapsed)"></div>
        <div style="color: var(--text-secondary);">Duraci√≥n total</div>
      </div>
      
      <template x-if="getIncompleteCount() > 0">
        <div class="info-box warning mb-4">
          <span><strong x-text="getIncompleteCount()"></strong> ejercicios sin completar</span>
        </div>
      </template>
      
      <div class="space-y-3">
        <button @click="finishSession()" class="btn btn-primary w-full">S√≠, finalizar</button>
        <button @click="showFinishModal = false" class="btn btn-secondary w-full">Seguir</button>
      </div>
    </div>
  </div>
  
  <!-- Backup -->
  <div x-show="showBackupModal" x-transition class="modal-overlay modal-center" @click.self="showBackupModal = false">
    <div class="modal-content modal-content-center">
      <h2 class="modal-title">Backup</h2>
      <template x-if="needsBackupReminder()">
        <div class="info-box warning mb-5">
          <span>‚ö†Ô∏è <strong x-text="profile.sessionsSinceBackup"></strong> sesiones sin backup</span>
        </div>
      </template>
      <div class="space-y-3">
        <button @click="exportData()" class="btn btn-primary w-full">üì§ Exportar</button>
        <label class="btn btn-secondary w-full cursor-pointer">
          üì• Importar
          <input type="file" accept=".json" @change="importData($event)" class="hidden">
        </label>
      </div>
      <button @click="showBackupModal = false" class="btn btn-secondary w-full mt-5">Cerrar</button>
    </div>
  </div>

  <!-- ==================== NAV ==================== -->
  <nav x-show="!showOnboarding && !pinLocked">
    <div class="flex justify-around">
      <button @click="currentScreen = 'home'" :class="currentScreen === 'home' ? 'active' : 'inactive'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>Hoy</span>
      </button>
      <button @click="currentScreen = 'mobility'" :class="currentScreen === 'mobility' ? 'active' : 'inactive'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
        <span>Movilidad</span>
      </button>
      <button @click="currentScreen = 'settings'" :class="currentScreen === 'settings' ? 'active' : 'inactive'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span>Ajustes</span>
      </button>
      <button @click="currentScreen = 'stats'" :class="currentScreen === 'stats' ? 'active' : 'inactive'">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        <span>Stats</span>
      </button>
    </div>
  </nav>

  <script>
    const APP_VERSION = '4.4';
    
    // B1: Configuraci√≥n corregida - potencia intermedio ahora 90s (era correcto, pero verificado)
    const NIVEL_CONFIG = {
      1: { descansoPotencia: 120, descansoFuerza: 90, descansoResistencia: 60, descansoCore: 45, seriesExtra: false, intensidad: 'Moderada' },
      2: { descansoPotencia: 90, descansoFuerza: 75, descansoResistencia: 45, descansoCore: 30, seriesExtra: false, intensidad: 'Alta' },
      3: { descansoPotencia: 60, descansoFuerza: 60, descansoResistencia: 30, descansoCore: 20, seriesExtra: true, intensidad: 'Muy alta' }
    };
    
    // Rutinas de movilidad
    const MOBILITY_ROUTINES = {
      morning: {
        title: '‚òÄÔ∏è Rutina Ma√±ana',
        duration: '5 min',
        exercises: [
          { name: 'Respiraci√≥n nasal lenta', emoji: 'üå¨Ô∏è', duration: '1 min', seconds: 60, instruction: 'Inhala 4 seg nariz, exhala 6-7 seg. Relaja hombros.', timed: true },
          { name: 'Gato-Vaca suave', emoji: 'üê±', duration: '10 reps', instruction: 'Muy suave, sin forzar. Moviliza toda la columna.', timed: false },
          { name: 'Movilidad tobillo', emoji: 'ü¶∂', duration: '10 cada lado', instruction: 'Rodilla hacia la pared, tal√≥n pegado al suelo. Alterna.', timed: false },
          { name: 'Chin Tucks (doble ment√≥n)', emoji: 'üßë', duration: '10 reps', instruction: 'Lleva la barbilla atr√°s (no abajo). Aguanta 3 seg cada una.', timed: false }
        ]
      },
      micropause: {
        title: 'üíª Micro-pausa',
        duration: '2 min',
        exercises: [
          { name: 'Chin Tucks', emoji: 'üßë', duration: '10 reps', instruction: 'Barbilla atr√°s, como sacando papada. Aguanta 3 seg cada una.', timed: false },
          { name: 'Nerve Flossing ci√°tico', emoji: 'üßµ', duration: '15 reps', instruction: 'Sentado: sube cabeza + pie hacia ti. Baja cabeza + estira pie.', timed: false },
          { name: 'Extensi√≥n tor√°cica en silla', emoji: 'ü™ë', duration: '30 seg', seconds: 30, instruction: 'Manos en nuca, abre codos y arquea espalda sobre respaldo.', timed: true }
        ]
      },
      rest: {
        title: 'üåô D√≠a de descanso',
        duration: '12 min',
        exercises: [
          { name: 'Respiraci√≥n nasal profunda', emoji: 'üå¨Ô∏è', duration: '2 min', seconds: 120, instruction: 'Inhala 4 seg, exhala 7 seg. Baja el tono del sistema nervioso.', timed: true },
          { name: 'Pelota tenis en planta pie', emoji: 'üéæ', duration: '1 min cada pie', sideTime: 60, instruction: 'Rueda presionando fuerte el arco. Libera fascia plantar.', timed: true, hasSides: true, sideLabels: ['ü¶∂ Pie izquierdo', 'ü¶∂ Pie derecho'] },
          { name: 'Movilidad tobillo', emoji: 'ü¶∂', duration: '10 cada lado', instruction: 'Rodilla a pared, tal√≥n pegado. Alterna piernas.', timed: false },
          { name: 'Short foot (agarre suelo)', emoji: 'üë£', duration: '10 cada pie', instruction: 'Sin mover dedos, intenta acortar el pie "agarrando" el suelo.', timed: false },
          { name: 'Estiramiento piramidal', emoji: 'üçë', duration: '1 min cada lado', sideTime: 60, instruction: 'Sentado, tobillo sobre rodilla contraria. Incl√≠nate adelante.', timed: true, hasSides: true, sideLabels: ['ü¶µ Pierna izquierda', 'ü¶µ Pierna derecha'] },
          { name: 'Estiramiento psoas', emoji: 'ü¶µ', duration: '1 min cada lado', sideTime: 60, instruction: 'Rodilla en suelo, aprieta gl√∫teo, inclina pelvis. Sin arquear lumbar.', timed: true, hasSides: true, sideLabels: ['ü¶µ Pierna izquierda', 'ü¶µ Pierna derecha'] },
          { name: 'Open Book', emoji: 'üìñ', duration: '10 cada lado', instruction: 'Tumbado de lado, gira tronco abriendo el brazo. Alterna lados.', timed: false },
          { name: 'Wall Sit isom√©trico', emoji: 'üß±', duration: '3x45 seg', sets: 3, workTime: 45, restTime: 30, instruction: 'Espalda en pared, rodillas 90¬∞. Cura tendinopat√≠a sin cargar.', timed: true, hasSets: true },
          { name: 'Passive Hang (colgarse)', emoji: 'üôÜ', duration: '30-60 seg', seconds: 45, instruction: 'Si tienes barra: cu√©lgate relajado. Descomprime columna.', timed: true }
        ]
      }
    };
    
    const EJERCICIOS = {
      'respiracion': { id: 'respiracion', name: 'Respiraci√≥n diafragm√°tica', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'none' },
      'cat-cow': { id: 'cat-cow', name: 'Cat-Cow', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: [], trackType: 'none' },
      'wall-slides': { id: 'wall-slides', name: 'Wall slides', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'none' },
      'puente-gluteo': { id: 'puente-gluteo', name: 'Puente de gl√∫teo', patron: 'warmup', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'none' },
      'puente-gluteo-trabajo': { id: 'puente-gluteo-trabajo', name: 'Puente gl√∫teo', patron: 'bisagra', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'bodyweight' },
      'puente-gluteo-peso': { id: 'puente-gluteo-peso', name: 'Puente gl√∫teo (con peso)', patron: 'bisagra', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['puente-gluteo-trabajo'], soloGym: true, trackType: 'peso' },
      
      // Potencia - gym
      'remo-polea-potencia': { id: 'remo-polea-potencia', name: 'Remo polea (explosivo)', patron: 'potencia', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['remo-mancuerna'], soloGym: true, trackType: 'peso' },
      'jalon-potencia': { id: 'jalon-potencia', name: 'Jal√≥n polea (explosivo)', patron: 'potencia', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['dominadas'], soloGym: true, trackType: 'peso' },
      'prensa-potencia': { id: 'prensa-potencia', name: 'Prensa (explosiva)', patron: 'potencia', requiereEquipo: ['prensa'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-goblet'], soloGym: true, trackType: 'peso' },
      
      // Potencia - casa
      'remo-banda-potencia': { id: 'remo-banda-potencia', name: 'Remo banda (explosivo)', patron: 'potencia', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true, trackType: 'banda' },
      'dominadas-explosivas': { id: 'dominadas-explosivas', name: 'Dominadas explosivas', patron: 'potencia', requiereEquipo: ['barraDominadas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['remo-banda-potencia'], soloCasa: true, trackType: 'bodyweight' },
      'sentadilla-goblet-potencia': { id: 'sentadilla-goblet-potencia', name: 'Sentadilla goblet (explosiva)', patron: 'potencia', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-peso-corporal'], soloCasa: true, trackType: 'peso' },
      'sentadilla-peso-corporal': { id: 'sentadilla-peso-corporal', name: 'Sentadilla explosiva', patron: 'potencia', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], soloCasa: true, trackType: 'bodyweight' },
      
      // Tir√≥n
      'remo-mancuerna': { id: 'remo-mancuerna', name: 'Remo mancuerna', patron: 'tiron', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['remo-polea'], trackType: 'peso' },
      'remo-polea': { id: 'remo-polea', name: 'Remo polea', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['remo-mancuerna'], soloGym: true, trackType: 'peso' },
      'remo-banda': { id: 'remo-banda', name: 'Remo banda', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true, trackType: 'banda' },
      'jalon-polea': { id: 'jalon-polea', name: 'Jal√≥n polea', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['dominadas'], soloGym: true, trackType: 'peso' },
      'dominadas': { id: 'dominadas', name: 'Dominadas', patron: 'tiron', requiereEquipo: ['barraDominadas'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['jalon-polea'], trackType: 'bodyweight' },
      'jalon-banda': { id: 'jalon-banda', name: 'Jal√≥n banda', patron: 'tiron', requiereEquipo: ['bandas', 'barraDominadas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], soloCasa: true, trackType: 'banda' },
      'face-pull-polea': { id: 'face-pull-polea', name: 'Face Pull', patron: 'tiron', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['band-pull-apart'], soloGym: true, trackType: 'peso' },
      'face-pull-banda': { id: 'face-pull-banda', name: 'Face Pull banda', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['band-pull-apart'], soloCasa: true, trackType: 'banda' },
      'band-pull-apart': { id: 'band-pull-apart', name: 'Band Pull-Apart', patron: 'tiron', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'banda' },
      
      // Bisagra
      'rdl-mancuernas': { id: 'rdl-mancuernas', name: 'RDL mancuernas', patron: 'bisagra', requiereEquipo: ['mancuernas'], riesgoRodilla: 1, riesgoCuello: 1, sustitutos: ['puente-gluteo-trabajo'], trackType: 'peso' },
      'rdl-banda': { id: 'rdl-banda', name: 'RDL banda', patron: 'bisagra', requiereEquipo: ['bandas'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['puente-gluteo-trabajo'], soloCasa: true, trackType: 'banda' },
      'curl-femoral': { id: 'curl-femoral', name: 'Curl femoral', patron: 'bisagra', requiereEquipo: ['maquina'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], soloGym: true, trackType: 'peso' },
      'curl-femoral-banda': { id: 'curl-femoral-banda', name: 'Curl femoral banda', patron: 'bisagra', requiereEquipo: ['bandas'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], soloCasa: true, trackType: 'banda' },
      
      // Sentadilla
      'prensa': { id: 'prensa', name: 'Prensa', patron: 'sentadilla', requiereEquipo: ['prensa'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-goblet'], soloGym: true, trackType: 'peso' },
      'sentadilla-barra': { id: 'sentadilla-barra', name: 'Sentadilla barra', patron: 'sentadilla', requiereEquipo: [], riesgoRodilla: 2, riesgoCuello: 1, sustitutos: ['sentadilla-goblet'], soloGym: true, trackType: 'peso' },
      'sentadilla-goblet': { id: 'sentadilla-goblet', name: 'Sentadilla Goblet', patron: 'sentadilla', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-cuerpo'], trackType: 'peso' },
      'sentadilla-cuerpo': { id: 'sentadilla-cuerpo', name: 'Sentadilla caja', patron: 'sentadilla', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: [], trackType: 'bodyweight' },
      'split-squat': { id: 'split-squat', name: 'Split Squat', patron: 'sentadilla', requiereEquipo: ['mancuernas'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['sentadilla-cuerpo'], trackType: 'peso' },
      'step-up': { id: 'step-up', name: 'Step-ups', patron: 'sentadilla', requiereEquipo: ['step'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['sentadilla-cuerpo'], soloCasa: true, trackType: 'peso' },
      
      // Empuje
      'press-mancuernas': { id: 'press-mancuernas', name: 'Press mancuernas', patron: 'empuje', requiereEquipo: ['mancuernas', 'banco'], riesgoRodilla: 0, riesgoCuello: 1, riesgoHombro: 2, sustitutos: ['press-suelo', 'flexiones'], trackType: 'peso' },
      'press-inclinado': { id: 'press-inclinado', name: 'Press inclinado 30¬∞', patron: 'empuje', requiereEquipo: ['mancuernas', 'banco'], riesgoRodilla: 0, riesgoCuello: 1, riesgoHombro: 1, sustitutos: ['press-mancuernas', 'flexiones'], trackType: 'peso' },
      'press-suelo': { id: 'press-suelo', name: 'Press suelo', patron: 'empuje', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 0, riesgoHombro: 1, sustitutos: ['flexiones'], trackType: 'peso' },
      'flexiones': { id: 'flexiones', name: 'Flexiones', patron: 'empuje', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 1, riesgoHombro: 1, sustitutos: [], trackType: 'bodyweight' },
      'elevaciones-laterales': { id: 'elevaciones-laterales', name: 'Elevaciones laterales', patron: 'empuje', requiereEquipo: ['mancuernas'], riesgoRodilla: 0, riesgoCuello: 0, riesgoHombro: 1, sustitutos: [], trackType: 'peso' },
      'elevaciones-banda': { id: 'elevaciones-banda', name: 'Elevaciones banda', patron: 'empuje', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, riesgoHombro: 1, sustitutos: [], soloCasa: true, trackType: 'banda' },
      
      // Core
      'pallof-polea': { id: 'pallof-polea', name: 'Pallof Press', patron: 'core', requiereEquipo: ['polea'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['plancha-lateral'], soloGym: true, trackType: 'peso' },
      'pallof-banda': { id: 'pallof-banda', name: 'Pallof banda', patron: 'core', requiereEquipo: ['bandas'], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: ['plancha-lateral'], soloCasa: true, trackType: 'banda' },
      'plancha-lateral': { id: 'plancha-lateral', name: 'Plancha lateral', patron: 'core', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'isometrico', tiempoBase: 30 },
      'dead-bug': { id: 'dead-bug', name: 'Dead Bug', patron: 'core', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'bodyweight' },
      
      // Cardio - M4: a√±adido trackType 'cardio'
      'bicicleta': { id: 'bicicleta', name: 'Bicicleta', patron: 'cardio', requiereEquipo: ['bicicleta'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['cinta', 'remo-ergometro'], soloGym: true, trackType: 'cardio' },
      'cinta': { id: 'cinta', name: 'Cinta inclinada', patron: 'cardio', requiereEquipo: ['cinta'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['bicicleta'], soloGym: true, trackType: 'cardio' },
      'remo-ergometro': { id: 'remo-ergometro', name: 'Remo erg√≥metro', patron: 'cardio', requiereEquipo: ['remo'], riesgoRodilla: 0, riesgoCuello: 1, sustitutos: ['bicicleta'], soloGym: true, trackType: 'cardio' },
      'escaleras': { id: 'escaleras', name: 'Subir/bajar escaleras', patron: 'cardio', requiereEquipo: ['escaleras'], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['marcha-sitio'], soloCasa: true, trackType: 'cardio' },
      'saltar-cuerda': { id: 'saltar-cuerda', name: 'Saltar cuerda', patron: 'cardio', requiereEquipo: ['cuerda'], riesgoRodilla: 2, riesgoCuello: 0, sustitutos: ['jumping-jacks'], trackType: 'cardio' },
      'jumping-jacks': { id: 'jumping-jacks', name: 'Jumping Jacks', patron: 'cardio', requiereEquipo: [], riesgoRodilla: 1, riesgoCuello: 0, sustitutos: ['marcha-sitio'], trackType: 'cardio' },
      'marcha-sitio': { id: 'marcha-sitio', name: 'Marcha en sitio', patron: 'cardio', requiereEquipo: [], riesgoRodilla: 0, riesgoCuello: 0, sustitutos: [], trackType: 'cardio' }
    };

    function app() {
      return {
        currentScreen: 'home',
        screenTitles: { home: 'Entrenamiento', mobility: 'Movilidad', settings: 'Ajustes', stats: 'Estad√≠sticas' },
        
        // M7: Onboarding
        showOnboarding: false,
        onboardingLevel: null,
        
        // PIN de acceso
        pinLocked: true,
        pinValue: '',
        pinError: '',
        isCreatingPin: false,
        
        showCheckinModal: false,
        showTimerModal: false,
        showPainModal: false,
        showPainConfirmModal: false,
        selectedPainArea: null,
        showBackupModal: false,
        showPostponedModal: false,
        showCancelModal: false,
        showFinishModal: false,
        showPreview: false,
        showRestBetweenModal: false,
        
        timerEndTime: null,
        timerTotal: 0,
        timerRemaining: 0,
        timerProgress: 100,
        timerLabel: null,
        timerInterval: null,
        
        sessionStartTime: null,
        sessionElapsed: 0,
        sessionInterval: null,
        
        // Movilidad
        mobilitySession: {
          active: false,
          routineType: null,
          exercises: [],
          currentIndex: 0
        },
        mobilityTimer: {
          active: false,
          total: 0,
          remaining: 0,
          interval: null,
          // Para series (Wall Sit)
          currentSet: 0,
          totalSets: 0,
          isResting: false,
          workTime: 0,
          restTime: 0,
          // Para lados (estiramientos)
          currentSide: 0,
          totalSides: 0,
          sideLabels: []
        },
        
        // Audio para iOS
        audioContext: null,
        audioUnlocked: false,
        
        profile: {
          nivel: 2,
          problemasCuello: true,
          tendinopatiaRodilla: true,
          umbralRodilla: 5,
          umbralCuello: 4,
          autoBackup: false,
          sessionsSinceBackup: 0,
          lastBackupDate: null,
          weeksWithoutDeload: 0,
          lastDeloadDate: null,
          onboardingCompleted: false
        },
        
        materialCasa: {
          mancuernas: { tiene: false, configType: 'peso', config: '' },
          bandas: { tiene: false, configType: 'banda', config: '' },
          barraDominadas: { tiene: false, configType: null, config: '' },
          kettlebell: { tiene: false, configType: 'peso', config: '' },
          cuerda: { tiene: false, configType: null, config: '' },
          banco: { tiene: false, configType: null, config: '' },
          step: { tiene: false, configType: null, config: '' },
          escaleras: { tiene: false, configType: null, config: '' }
        },
        
        materialNames: {
          mancuernas: 'Mancuernas',
          bandas: 'Bandas el√°sticas',
          barraDominadas: 'Barra dominadas',
          kettlebell: 'Kettlebell',
          cuerda: 'Cuerda saltar',
          banco: 'Banco',
          step: 'Step/Caj√≥n',
          escaleras: 'Escaleras'
        },
        
        checkinForm: { ubicacion: null, tiempo: 45, estado: 3, dolorRodilla: 0, dolorCuello: 0, gymSaturado: false, deloadWeek: false },
        todayCheckin: null,
        nextDayType: 'A',
        currentSession: null,
        recentSessions: [],
        exerciseHistory: {},
        metricsHistory: [],
        newMetric: { peso: null, cintura: null },
        weekDays: [],
        
        // PRs y estad√≠sticas avanzadas
        prHistory: {}, // { 'ejercicio-id': [{ value: 60, date: '2024-01-15' }, ...] }
        prExercises: ['sentadilla-barra', 'prensa', 'jalon-polea', 'dominadas', 'remo-polea', 'rdl-mancuernas', 'press-inclinado'],
        selectedPRExercise: 'prensa',
        weeklyStats: { completed: 0 },
        
        init() {
          this.loadAllData();
          
          // Verificar PIN
          const savedPin = localStorage.getItem('coach_pin');
          const pinVerified = localStorage.getItem('coach_pin_verified');
          
          if (!savedPin) {
            // Primera vez: crear PIN
            this.isCreatingPin = true;
            this.pinLocked = true;
            return; // No cargar nada m√°s hasta crear PIN
          } else if (pinVerified === 'true') {
            // Ya verificado en esta sesi√≥n
            this.pinLocked = false;
          } else {
            // Necesita verificar
            this.pinLocked = true;
            return;
          }
          
          this.continueInit();
        },
        
        continueInit() {
          // M7: Verificar si es primer uso
          if (!this.profile.onboardingCompleted) {
            this.showOnboarding = true;
          }
          
          this.checkTodayCheckin();
          this.calculateNextDay();
          this.calculateWeekDays();
          this.calculateStats();
          
          if (this.currentSession && this.currentSession.startTime) {
            this.sessionStartTime = new Date(this.currentSession.startTime);
            this.startSessionTimer();
          }
        },
        
        // PIN functions
        handlePinInput(n) {
          if (n === 'del') {
            this.pinValue = this.pinValue.slice(0, -1);
            this.pinError = '';
          } else if (n !== null && this.pinValue.length < 4) {
            this.pinValue += n;
            this.pinError = '';
            
            // Auto-verificar al completar 4 d√≠gitos (solo si no est√° creando)
            if (!this.isCreatingPin && this.pinValue.length === 4) {
              this.verifyPin();
            }
          }
        },
        
        saveNewPin() {
          if (this.pinValue.length !== 4) return;
          localStorage.setItem('coach_pin', this.pinValue);
          localStorage.setItem('coach_pin_verified', 'true');
          this.pinLocked = false;
          this.isCreatingPin = false;
          this.pinValue = '';
          this.continueInit();
        },
        
        verifyPin() {
          const savedPin = localStorage.getItem('coach_pin');
          if (this.pinValue === savedPin) {
            localStorage.setItem('coach_pin_verified', 'true');
            this.pinLocked = false;
            this.pinValue = '';
            this.continueInit();
          } else {
            this.pinError = 'PIN incorrecto';
            this.pinValue = '';
          }
        },
        
        // M7: Onboarding functions
        setInitialLevel(level) {
          this.onboardingLevel = level;
        },
        
        completeOnboarding() {
          if (!this.onboardingLevel) return;
          this.profile.nivel = this.onboardingLevel;
          this.profile.onboardingCompleted = true;
          this.saveProfile();
          this.showOnboarding = false;
        },
        
        loadAllData() {
          ['profile', 'materialCasa', 'recentSessions', 'nextDayType', 'currentSession', 'metricsHistory', 'exerciseHistory', 'prHistory'].forEach(key => {
            const data = localStorage.getItem('coach_' + key);
            if (data) {
              try {
                const parsed = JSON.parse(data);
                if (typeof this[key] === 'object' && !Array.isArray(this[key])) {
                  this[key] = { ...this[key], ...parsed };
                } else {
                  this[key] = parsed;
                }
              } catch(e) {}
            }
          });
          
          // Limpiar keys extra de materialCasa (datos antiguos)
          const validKeys = Object.keys(this.materialNames);
          Object.keys(this.materialCasa).forEach(key => {
            if (!validKeys.includes(key)) {
              delete this.materialCasa[key];
            }
          });
          
          const todayData = localStorage.getItem('coach_todayCheckin');
          if (todayData) {
            try {
              const parsed = JSON.parse(todayData);
              if (new Date(parsed.date).toDateString() === new Date().toDateString()) {
                this.todayCheckin = parsed;
              }
            } catch(e) {}
          }
        },
        
        saveProfile() { localStorage.setItem('coach_profile', JSON.stringify(this.profile)); },
        saveMaterial() { localStorage.setItem('coach_materialCasa', JSON.stringify(this.materialCasa)); },
        saveNextDay() { localStorage.setItem('coach_nextDayType', JSON.stringify(this.nextDayType)); },
        saveSessions() { localStorage.setItem('coach_recentSessions', JSON.stringify(this.recentSessions)); },
        saveSession() { if (this.currentSession) localStorage.setItem('coach_currentSession', JSON.stringify(this.currentSession)); },
        saveMetricsHistory() { localStorage.setItem('coach_metricsHistory', JSON.stringify(this.metricsHistory)); },
        saveExerciseHistory() { localStorage.setItem('coach_exerciseHistory', JSON.stringify(this.exerciseHistory)); },
        savePRHistory() { localStorage.setItem('coach_prHistory', JSON.stringify(this.prHistory)); },
        
        getNivelConfig() { return NIVEL_CONFIG[this.profile.nivel] || NIVEL_CONFIG[2]; },
        getNivelLabel(n) { return ['', 'Principiante', 'Intermedio', 'Avanzado'][n] || 'Intermedio'; },
        
        // M5: Recordatorio de descarga
        shouldShowDeloadReminder() {
          return (this.profile.weeksWithoutDeload || 0) >= 4 && !this.checkinForm.deloadWeek;
        },
        
        dismissDeloadReminder() {
          this.profile.weeksWithoutDeload = 0;
          this.saveProfile();
        },
        
        acceptDeload() {
          this.checkinForm.deloadWeek = true;
          this.profile.weeksWithoutDeload = 0;
          this.profile.lastDeloadDate = new Date().toISOString();
          this.saveProfile();
        },
        
        tieneMaterialCasa() { return Object.values(this.materialCasa).some(m => m.tiene); },
        tieneEquipo(equipoList, esCasa) {
          if (!equipoList || equipoList.length === 0) return true;
          if (esCasa) return equipoList.every(eq => this.materialCasa[eq]?.tiene);
          return true;
        },
        
        checkTodayCheckin() {
          const data = localStorage.getItem('coach_todayCheckin');
          if (data) {
            try {
              const parsed = JSON.parse(data);
              if (new Date(parsed.date).toDateString() === new Date().toDateString()) {
                this.todayCheckin = parsed;
              }
            } catch(e) {}
          }
        },
        
        submitCheckin() {
          this.todayCheckin = { date: new Date().toISOString(), ...this.checkinForm };
          localStorage.setItem('coach_todayCheckin', JSON.stringify(this.todayCheckin));
          this.showCheckinModal = false;
        },
        
        resetCheckin() {
          this.todayCheckin = null;
          this.checkinForm = { ubicacion: null, tiempo: 45, estado: 3, dolorRodilla: 0, dolorCuello: 0, gymSaturado: false, deloadWeek: false };
          localStorage.removeItem('coach_todayCheckin');
        },
        
        getStateEmoji(s) { return ['', 'üò´', 'üòî', 'üòê', 'üôÇ', 'üí™'][s] || 'üòê'; },
        
        calculateNextDay() {
          if (this.recentSessions.length === 0) { this.nextDayType = 'A'; return; }
          const rotation = { 'A': 'B', 'B': 'C', 'C': 'A' };
          this.nextDayType = rotation[this.recentSessions[0].dayType] || 'A';
        },
        
        getDayTitle(d) { return { 'A': 'Upper Tir√≥n', 'B': 'Lower', 'C': 'Upper Empuje' }[d]; },
        getDaySubtitle(d) { return { 'A': 'Dominadas, Remo, Laterales, RDL', 'B': 'Sentadilla, Curl, Puente, Core', 'C': 'Press inclinado, Jal√≥n, Pierna' }[d]; },
        
        getPreviewBlocks() {
          if (!this.todayCheckin) return [];
          return this.buildBlocks();
        },
        
        getPreviewExerciseCount() {
          let count = 0;
          this.getPreviewBlocks().forEach(b => count += b.exercises.length);
          return count;
        },
        
        // M8: Tiempo restante estimado
        getEstimatedRemaining() {
          if (!this.currentSession) return 0;
          const total = this.getTotalCount();
          const completed = this.getCompletedCount();
          const remaining = total - completed;
          const avgPerExercise = 3; // minutos promedio por ejercicio
          return remaining * avgPerExercise;
        },
        
        isSessionValid() {
          const blocks = this.getPreviewBlocks();
          let main = 0;
          blocks.filter(b => ['potencia', 'fuerza', 'resistencia'].includes(b.tipo)).forEach(b => main += b.exercises.length);
          return main >= 3;
        },
        
        getSessionError() {
          if (this.todayCheckin?.ubicacion === 'casa' && !this.tieneMaterialCasa()) return 'Configura tu material en Ajustes.';
          return 'No hay suficientes ejercicios.';
        },
        
        buildBlocks() {
          const c = this.todayCheckin;
          if (!c) return [];
          
          const esCasa = c.ubicacion === 'casa';
          const tiempo = c.tiempo;
          const gymSat = c.gymSaturado;
          const dolorRod = c.dolorRodilla >= this.profile.umbralRodilla;
          const dolorCue = c.dolorCuello >= this.profile.umbralCuello;
          const cfg = this.getNivelConfig();
          const deload = c.deloadWeek;
          
          let blocks = [];
          
          if (tiempo >= 20) {
            blocks.push({
              name: 'Calentamiento',
              exercises: ['respiracion', 'cat-cow', 'wall-slides', 'puente-gluteo'].map(id => this.makeExercise(id, '10 reps', esCasa, false, null, gymSat)).filter(e => e)
            });
          }
          
          const day = this.nextDayType;
          if (day === 'A') blocks = blocks.concat(this.buildDayA(esCasa, tiempo, gymSat, dolorRod, cfg, deload));
          else if (day === 'B') blocks = blocks.concat(this.buildDayB(esCasa, tiempo, gymSat, dolorRod, cfg, deload));
          else blocks = blocks.concat(this.buildDayC(esCasa, tiempo, gymSat, dolorRod, cfg, deload));
          
          if (tiempo >= 30) {
            const coreEx = esCasa ? (this.tieneEquipo(['bandas'], true) ? 'pallof-banda' : 'plancha-lateral') : 'pallof-polea';
            const coreReps = deload ? '2x8 cada' : '2x10 cada';
            const coreExs = [this.makeExercise(coreEx, coreReps, esCasa, true, 'core', gymSat)];
            if (tiempo >= 45) coreExs.push(this.makeExercise('dead-bug', coreReps, esCasa, true, 'core', gymSat));
            blocks.push({
              name: 'Core', tipo: 'core', badge: 'üéØ Estabilidad',
              instruccion: 'Control total, sin compensar.',
              exercises: coreExs.filter(e => e)
            });
          }
          
          if (tiempo >= 45) {
            const cardioTime = tiempo >= 60 ? '10-15 min Z2' : '8 min Z2';
            const opts = [];
            if (esCasa) {
              if (this.tieneEquipo(['escaleras'], true)) opts.push({ id: 'escaleras', name: 'Escaleras' });
              if (this.tieneEquipo(['cuerda'], true) && !dolorRod) opts.push({ id: 'saltar-cuerda', name: 'Cuerda' });
              if (!dolorRod) opts.push({ id: 'jumping-jacks', name: 'Jumping Jacks' });
              opts.push({ id: 'marcha-sitio', name: 'Marcha' });
            } else {
              opts.push({ id: 'bicicleta', name: 'Bicicleta' });
              if (!dolorRod) opts.push({ id: 'cinta', name: 'Cinta' });
              opts.push({ id: 'remo-ergometro', name: 'Remo' });
            }
            if (opts.length > 0) {
              const main = this.makeExercise(opts[0].id, cardioTime, esCasa, false);
              if (main) {
                main.showSubs = true;
                main.substitutes = opts.slice(1).map(o => o.name);
                blocks.push({
                  name: 'Cardio Z2',
                  instruccion: 'Ritmo conversacional. Elige tu opci√≥n.',
                  exercises: [main]
                });
              }
            }
          }
          
          return blocks;
        },
        
        // D√çA A: Upper Tir√≥n + Pierna posterior
        buildDayA(esCasa, tiempo, gymSat, dolorRod, cfg, deload) {
          const blocks = [];
          const reps = deload ? '2x10' : '3x8-12';
          const repsAcc = deload ? '2x12' : '2-3x12-15';
          
          // PRINCIPAL: Tir√≥n vertical + horizontal
          const principal = [];
          if (esCasa) {
            if (this.tieneEquipo(['barraDominadas'], true)) principal.push(this.makeExercise('dominadas', deload ? '2x m√°x' : '3x m√°x', esCasa, true, 'fuerza', gymSat));
            else if (this.tieneEquipo(['bandas'], true)) principal.push(this.makeExercise('jalon-banda', reps, esCasa, true, 'fuerza', gymSat));
            if (this.tieneEquipo(['mancuernas'], true)) principal.push(this.makeExercise('remo-mancuerna', reps, esCasa, true, 'fuerza', gymSat));
            else if (this.tieneEquipo(['bandas'], true)) principal.push(this.makeExercise('remo-banda', reps, esCasa, true, 'fuerza', gymSat));
          } else {
            principal.push(this.makeExercise('jalon-polea', reps, esCasa, true, 'fuerza', gymSat));
            principal.push(this.makeExercise('remo-polea', reps, esCasa, true, 'fuerza', gymSat));
            if (tiempo >= 45) principal.push(this.makeExercise('remo-mancuerna', reps, esCasa, true, 'fuerza', gymSat));
          }
          if (principal.filter(e => e).length > 0) {
            blocks.push({
              name: 'Principal', tipo: 'fuerza', badge: 'üí™ Tir√≥n',
              instruccion: 'Controlado: aprieta espalda arriba.',
              exercises: principal.filter(e => e)
            });
          }
          
          // EMPUJE + HOMBRO (para equilibrio)
          const empuje = [];
          if (tiempo >= 45) {
            if (esCasa) {
              if (this.tieneEquipo(['mancuernas'], true)) empuje.push(this.makeExercise('press-suelo', repsAcc, esCasa, true, 'fuerza', gymSat));
              else empuje.push(this.makeExercise('flexiones', deload ? '2x m√°x' : '2-3x m√°x', esCasa, true, 'fuerza', gymSat));
              // Elevaciones laterales
              if (this.tieneEquipo(['mancuernas'], true)) empuje.push(this.makeExercise('elevaciones-laterales', repsAcc, esCasa, true, 'fuerza', gymSat));
              else if (this.tieneEquipo(['bandas'], true)) empuje.push(this.makeExercise('elevaciones-banda', repsAcc, esCasa, true, 'fuerza', gymSat));
            } else {
              empuje.push(this.makeExercise('press-mancuernas', repsAcc, esCasa, true, 'fuerza', gymSat));
              empuje.push(this.makeExercise('elevaciones-laterales', repsAcc, esCasa, true, 'fuerza', gymSat));
            }
          }
          if (empuje.filter(e => e).length > 0) {
            blocks.push({
              name: 'Empuje', tipo: 'fuerza', badge: 'üîÑ Balance',
              instruccion: 'Mant√©n esc√°pulas atr√°s.',
              exercises: empuje.filter(e => e)
            });
          }
          
          // PIERNA POSTERIOR (sin estr√©s rodilla)
          const pierna = [];
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas'], true)) pierna.push(this.makeExercise('rdl-mancuernas', reps, esCasa, true, 'fuerza', gymSat));
            else if (this.tieneEquipo(['bandas'], true)) pierna.push(this.makeExercise('rdl-banda', reps, esCasa, true, 'fuerza', gymSat));
            else pierna.push(this.makeExercise('puente-gluteo-trabajo', '3x15', esCasa, true, 'fuerza', gymSat));
          } else {
            pierna.push(this.makeExercise('rdl-mancuernas', reps, esCasa, true, 'fuerza', gymSat));
          }
          if (pierna.filter(e => e).length > 0) {
            blocks.push({
              name: 'Pierna', tipo: 'fuerza', badge: 'ü¶µ Posterior',
              instruccion: 'Bisagra de cadera, rodillas suaves.',
              exercises: pierna.filter(e => e)
            });
          }
          
          // ACCESORIO: Postura
          const accesorio = [];
          const fpEx = esCasa ? (this.tieneEquipo(['bandas'], true) ? 'face-pull-banda' : null) : 'face-pull-polea';
          if (fpEx) accesorio.push(this.makeExercise(fpEx, repsAcc, esCasa, true, 'resistencia', gymSat));
          if (accesorio.filter(e => e).length > 0) {
            blocks.push({
              name: 'Postura', tipo: 'resistencia', badge: 'üéØ Salud',
              instruccion: 'Rotaci√≥n externa, hombros atr√°s.',
              exercises: accesorio.filter(e => e)
            });
          }
          
          return blocks;
        },
        
        // D√çA B: Lower - Piernas completo
        buildDayB(esCasa, tiempo, gymSat, dolorRod, cfg, deload) {
          const blocks = [];
          const reps = deload ? '2x10' : '3x8-12';
          const repsAcc = deload ? '2x12' : '2-3x12-15';
          
          // CU√ÅDRICEPS
          const cuads = [];
          const repsSentBarra = deload ? '2x12' : '3x10-12'; // M√°s reps, menos peso para barra
          if (!dolorRod) {
            if (esCasa) {
              if (this.tieneEquipo(['mancuernas'], true)) cuads.push(this.makeExercise('sentadilla-goblet', reps, esCasa, true, 'fuerza', gymSat));
              else cuads.push(this.makeExercise('sentadilla-cuerpo', reps, esCasa, true, 'fuerza', gymSat));
              if (tiempo >= 45 && this.tieneEquipo(['mancuernas'], true)) cuads.push(this.makeExercise('split-squat', '2x10 cada', esCasa, true, 'fuerza', gymSat));
            } else {
              // Gym: sentadilla con barra (m√°s reps, menos peso = seguro)
              cuads.push(this.makeExercise('sentadilla-barra', repsSentBarra, esCasa, true, 'fuerza', gymSat));
              if (tiempo >= 45) cuads.push(this.makeExercise('split-squat', '2x10 cada', esCasa, true, 'fuerza', gymSat));
            }
          } else {
            cuads.push(this.makeExercise('sentadilla-cuerpo', repsAcc, esCasa, true, 'fuerza', gymSat));
          }
          if (cuads.filter(e => e).length > 0) {
            blocks.push({
              name: 'Cu√°driceps', tipo: 'fuerza', badge: 'ü¶µ Pierna anterior',
              instruccion: dolorRod ? 'Rango c√≥modo, sin forzar rodilla.' : 'Baja controlado, empuja con talones.',
              exercises: cuads.filter(e => e)
            });
          }
          
          // ISQUIOS/GL√öTEOS (sin RDL - ya est√° en d√≠a A)
          const posterior = [];
          if (esCasa) {
            // Puente gl√∫teo siempre disponible
            posterior.push(this.makeExercise('puente-gluteo-trabajo', reps, esCasa, true, 'fuerza', gymSat));
            // Curl femoral si hay bandas
            if (this.tieneEquipo(['bandas'], true)) posterior.push(this.makeExercise('curl-femoral-banda', repsAcc, esCasa, true, 'fuerza', gymSat));
          } else {
            // Gym: curl femoral m√°quina + puente con peso
            posterior.push(this.makeExercise('curl-femoral', reps, esCasa, true, 'fuerza', gymSat));
            if (tiempo >= 45) posterior.push(this.makeExercise('puente-gluteo-peso', repsAcc, esCasa, true, 'fuerza', gymSat));
          }
          if (posterior.filter(e => e).length > 0) {
            blocks.push({
              name: 'Isquios/Gl√∫teos', tipo: 'fuerza', badge: 'üçë Pierna posterior',
              instruccion: 'Contrae gl√∫teo arriba, control en bajada.',
              exercises: posterior.filter(e => e)
            });
          }
          
          // CORE EXTRA en d√≠a de piernas (solo plancha lateral, dead-bug ya est√° en Core general)
          if (tiempo >= 45) {
            const coreExtra = [];
            coreExtra.push(this.makeExercise('plancha-lateral', '2x30s cada', esCasa, true, 'core', gymSat));
            if (coreExtra.filter(e => e).length > 0) {
              blocks.push({
                name: 'Core extra', tipo: 'core', badge: 'üéØ Estabilidad',
                instruccion: 'Sin compensar con espalda baja.',
                exercises: coreExtra.filter(e => e)
              });
            }
          }
          
          return blocks;
        },
        
        // D√çA C: Upper Empuje + Pierna ligera
        buildDayC(esCasa, tiempo, gymSat, dolorRod, cfg, deload) {
          const blocks = [];
          const reps = deload ? '2x10' : '3x8-12';
          const repsAcc = deload ? '2x12' : '2-3x12-15';
          
          // PRINCIPAL: Empuje (press inclinado para m√°s deltoides anterior)
          const empuje = [];
          if (esCasa) {
            if (this.tieneEquipo(['mancuernas', 'banco'], true)) empuje.push(this.makeExercise('press-inclinado', reps, esCasa, true, 'fuerza', gymSat));
            else if (this.tieneEquipo(['mancuernas'], true)) empuje.push(this.makeExercise('press-suelo', reps, esCasa, true, 'fuerza', gymSat));
            else empuje.push(this.makeExercise('flexiones', deload ? '2x m√°x' : '3x m√°x', esCasa, true, 'fuerza', gymSat));
            if (this.tieneEquipo(['mancuernas'], true)) empuje.push(this.makeExercise('elevaciones-laterales', repsAcc, esCasa, true, 'fuerza', gymSat));
            else if (this.tieneEquipo(['bandas'], true)) empuje.push(this.makeExercise('elevaciones-banda', repsAcc, esCasa, true, 'fuerza', gymSat));
          } else {
            empuje.push(this.makeExercise('press-inclinado', reps, esCasa, true, 'fuerza', gymSat));
            empuje.push(this.makeExercise('elevaciones-laterales', repsAcc, esCasa, true, 'fuerza', gymSat));
            if (tiempo >= 45) empuje.push(this.makeExercise('flexiones', '2x m√°x', esCasa, true, 'fuerza', gymSat));
          }
          if (empuje.filter(e => e).length > 0) {
            blocks.push({
              name: 'Principal', tipo: 'fuerza', badge: 'üí™ Empuje',
              instruccion: 'Banco a 30¬∞, esc√°pulas juntas.',
              exercises: empuje.filter(e => e)
            });
          }
          
          // TIR√ìN (vertical + horizontal para balance)
          const tiron = [];
          if (tiempo >= 30) {
            // Tir√≥n vertical
            if (esCasa) {
              if (this.tieneEquipo(['barraDominadas'], true)) tiron.push(this.makeExercise('dominadas', deload ? '2x m√°x' : '2-3x m√°x', esCasa, true, 'fuerza', gymSat));
              else if (this.tieneEquipo(['bandas'], true)) tiron.push(this.makeExercise('jalon-banda', repsAcc, esCasa, true, 'fuerza', gymSat));
            } else {
              tiron.push(this.makeExercise('jalon-polea', repsAcc, esCasa, true, 'fuerza', gymSat));
            }
            // Tir√≥n horizontal
            if (tiempo >= 45) {
              if (esCasa) {
                if (this.tieneEquipo(['mancuernas'], true)) tiron.push(this.makeExercise('remo-mancuerna', repsAcc, esCasa, true, 'fuerza', gymSat));
                else if (this.tieneEquipo(['bandas'], true)) tiron.push(this.makeExercise('remo-banda', repsAcc, esCasa, true, 'fuerza', gymSat));
              } else {
                tiron.push(this.makeExercise('remo-mancuerna', repsAcc, esCasa, true, 'fuerza', gymSat));
              }
            }
          }
          if (tiron.filter(e => e).length > 0) {
            blocks.push({
              name: 'Tir√≥n', tipo: 'fuerza', badge: 'üîÑ Balance',
              instruccion: 'Aprieta espalda arriba.',
              exercises: tiron.filter(e => e)
            });
          }
          
          // PIERNA LIGERA (cu√°driceps sin estr√©s)
          const pierna = [];
          if (!dolorRod) {
            // Sentadilla ligera o step-ups
            if (esCasa) {
              if (this.tieneEquipo(['step'], true)) pierna.push(this.makeExercise('step-up', '2x10 cada', esCasa, true, 'fuerza', gymSat));
              else pierna.push(this.makeExercise('sentadilla-cuerpo', repsAcc, esCasa, true, 'fuerza', gymSat));
            } else {
              pierna.push(this.makeExercise('sentadilla-goblet', repsAcc, esCasa, true, 'fuerza', gymSat));
            }
          } else {
            // Si hay dolor, solo puente de gl√∫teo (sin rodilla)
            pierna.push(this.makeExercise('puente-gluteo-trabajo', '2x15', esCasa, true, 'fuerza', gymSat));
          }
          if (pierna.filter(e => e).length > 0) {
            blocks.push({
              name: 'Pierna', tipo: 'fuerza', badge: 'ü¶µ Ligero',
              instruccion: dolorRod ? 'Sin estr√©s en rodilla.' : 'Peso moderado, control total.',
              exercises: pierna.filter(e => e)
            });
          }
          
          // POSTURA: Face pull + Pull apart
          const postura = [];
          const fpEx = esCasa ? (this.tieneEquipo(['bandas'], true) ? 'face-pull-banda' : null) : 'face-pull-polea';
          if (fpEx) postura.push(this.makeExercise(fpEx, repsAcc, esCasa, true, 'resistencia', gymSat));
          if (this.tieneEquipo(['bandas'], esCasa) || !esCasa) {
            if (tiempo >= 45 && !deload) postura.push(this.makeExercise('band-pull-apart', '2x20', esCasa, true, 'resistencia', gymSat));
          }
          if (postura.filter(e => e).length > 0) {
            blocks.push({
              name: 'Postura', tipo: 'resistencia', badge: 'üéØ Salud',
              instruccion: 'Rotaci√≥n externa, hombros atr√°s.',
              exercises: postura.filter(e => e)
            });
          }
          
          return blocks;
        },
        
        generateSession() {
          this.currentSession = {
            id: Date.now(),
            date: new Date().toISOString(),
            startTime: new Date().toISOString(),
            dayType: this.nextDayType,
            ubicacion: this.todayCheckin.ubicacion,
            tiempo: this.todayCheckin.tiempo,
            blocks: this.buildBlocks(),
            completed: false
          };
          this.saveSession();
          this.sessionStartTime = new Date();
          this.startSessionTimer();
        },
        
        makeExercise(id, prescription, esCasa, trackSets, tipo, gymSat) {
          const ex = EJERCICIOS[id];
          if (!ex) return null;
          if (esCasa && ex.soloGym) return null;
          if (!esCasa && ex.soloCasa) return null;
          if (!this.tieneEquipo(ex.requiereEquipo, esCasa)) {
            for (const subId of (ex.sustitutos || [])) {
              const sub = this.makeExercise(subId, prescription, esCasa, trackSets, tipo, gymSat);
              if (sub) return sub;
            }
            return null;
          }
          
          const cfg = this.getNivelConfig();
          let restTime = null;
          if (tipo === 'potencia') restTime = cfg.descansoPotencia;
          else if (tipo === 'fuerza') restTime = cfg.descansoFuerza;
          else if (tipo === 'resistencia') restTime = cfg.descansoResistencia;
          else if (tipo === 'core') restTime = cfg.descansoCore;
          
          const numSets = parseInt(prescription.match(/(\d+)x/)?.[1] || 2);
          
          // B2: Filtrar sustitutos por ubicaci√≥n
          const subs = (ex.sustitutos || [])
            .map(s => EJERCICIOS[s])
            .filter(s => s && !(esCasa && s.soloGym) && !(!esCasa && s.soloCasa))
            .map(s => s.name);
          
          return {
            id: ex.id,
            name: ex.name,
            prescription,
            trackSets,
            trackType: ex.trackType || 'peso',
            sets: trackSets && ex.trackType !== 'cardio' && ex.trackType !== 'none' ? Array(numSets).fill(null).map(() => ({ value: null, reps: null, rir: null })) : [],
            restTime,
            substitutes: subs,
            completed: false,
            postponed: false,
            removed: false,
            showSubs: gymSat,
            minutesCompleted: null
          };
        },
        
        // M1: Etiquetas mejoradas
        getTrackLabel(type) {
          return {
            'peso': 'Kg total',
            'banda': 'Resist.',
            'bodyweight': null,
            'cardio': null
          }[type] || 'Kg';
        },
        
        // M1: Placeholders mejorados
        getTrackPlaceholder(type) {
          return {
            'peso': 'kg total',
            'banda': 'color',
            'bodyweight': '',
            'cardio': ''
          }[type] || 'kg';
        },
        
        getLastValue(exId) {
          const h = this.exerciseHistory[exId];
          if (!h || h.length === 0) return null;
          return h[h.length - 1];
        },
        
        getProgressionHint(exId) {
          const h = this.exerciseHistory[exId];
          if (!h || h.length < 2) return null;
          
          const last = parseFloat(h[h.length - 1]);
          const prev = parseFloat(h[h.length - 2]);
          
          if (isNaN(last) || isNaN(prev)) return null;
          
          // Si subi√≥ respecto al anterior
          if (last > prev) {
            return { text: '‚Üë Subiste', color: 'var(--accent)' };
          }
          
          // Si repiti√≥ el mismo peso 2+ veces
          if (h.length >= 2) {
            const lastTwo = h.slice(-2).map(v => parseFloat(v));
            if (lastTwo[0] === lastTwo[1]) {
              // Si lleva 3+ veces igual, sugerir subir
              if (h.length >= 3 && parseFloat(h[h.length - 3]) === last) {
                return { text: 'üí™ ¬°Sube peso!', color: '#f59e0b' };
              }
              return { text: '‚Üí Mant√©n o sube', color: 'var(--text-secondary)' };
            }
          }
          
          // Si baj√≥
          if (last < prev) {
            return { text: '‚Üì Bajaste', color: 'var(--text-muted)' };
          }
          
          return null;
        },
        
        saveExerciseValue(exId, value) {
          if (!value) return;
          if (!this.exerciseHistory[exId]) this.exerciseHistory[exId] = [];
          this.exerciseHistory[exId].push(value);
          if (this.exerciseHistory[exId].length > 20) this.exerciseHistory[exId] = this.exerciseHistory[exId].slice(-20);
          this.saveExerciseHistory();
          
          // Guardar en prHistory si es un ejercicio de PR
          if (this.prExercises.includes(exId)) {
            this.savePRValue(exId, value);
          }
        },
        
        savePRValue(exId, value) {
          if (!this.prHistory[exId]) this.prHistory[exId] = [];
          const numValue = typeof value === 'number' ? value : parseFloat(value);
          if (isNaN(numValue)) return;
          
          this.prHistory[exId].push({
            value: numValue,
            date: new Date().toISOString().split('T')[0]
          });
          this.savePRHistory();
        },
        
        getPR(exId) {
          const history = this.prHistory[exId];
          if (!history || history.length === 0) return null;
          
          // Para dominadas es reps (m√°s = mejor), para el resto es peso
          if (exId === 'dominadas') {
            return history.reduce((max, h) => h.value > max.value ? h : max, history[0]);
          }
          return history.reduce((max, h) => h.value > max.value ? h : max, history[0]);
        },
        
        getPRHistory(exId) {
          return this.prHistory[exId] || [];
        },
        
        // Estad√≠sticas de consistencia
        getStreak() {
          if (this.recentSessions.length === 0) return 0;
          
          let streak = 0;
          const now = new Date();
          const oneWeek = 7 * 24 * 60 * 60 * 1000;
          
          // Agrupar sesiones por semana
          for (let i = 0; i < 52; i++) {
            const weekStart = new Date(now - (i * oneWeek) - (now.getDay() * 24 * 60 * 60 * 1000));
            const weekEnd = new Date(weekStart.getTime() + oneWeek);
            
            const sessionsThisWeek = this.recentSessions.filter(s => {
              const d = new Date(s.date);
              return d >= weekStart && d < weekEnd;
            });
            
            if (sessionsThisWeek.length > 0) {
              streak++;
            } else if (i > 0) {
              break;
            }
          }
          return streak;
        },
        
        getSessionsThisYear() {
          const yearStart = new Date(new Date().getFullYear(), 0, 1);
          return this.recentSessions.filter(s => new Date(s.date) >= yearStart).length;
        },
        
        getSessionsThisMonth() {
          const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
          return this.recentSessions.filter(s => new Date(s.date) >= monthStart).length;
        },
        
        getAvgSessionsPerWeek() {
          if (this.recentSessions.length === 0) return 0;
          
          const firstSession = new Date(Math.min(...this.recentSessions.map(s => new Date(s.date))));
          const weeks = Math.max(1, (new Date() - firstSession) / (7 * 24 * 60 * 60 * 1000));
          return (this.recentSessions.length / weeks).toFixed(1);
        },
        
        getPRExerciseName(exId) {
          const names = {
            'sentadilla-barra': 'Sentadilla',
            'prensa': 'Prensa',
            'jalon-polea': 'Jal√≥n',
            'dominadas': 'Dominadas',
            'remo-polea': 'Remo',
            'rdl-mancuernas': 'RDL',
            'press-inclinado': 'Press incl.'
          };
          return names[exId] || exId;
        },
        
        getPRUnit(exId) {
          return exId === 'dominadas' ? 'reps' : 'kg';
        },
        
        formatPRDate(dateStr) {
          if (!dateStr) return '';
          const d = new Date(dateStr);
          const now = new Date();
          const diffDays = Math.floor((now - d) / (24 * 60 * 60 * 1000));
          
          if (diffDays === 0) return 'Hoy';
          if (diffDays === 1) return 'Ayer';
          if (diffDays < 7) return `Hace ${diffDays}d`;
          if (diffDays < 30) return `Hace ${Math.floor(diffDays/7)}sem`;
          return d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        },
        
        getPRBarHeight(exId, value) {
          const history = this.prHistory[exId] || [];
          if (history.length === 0) return 0;
          
          const values = history.map(h => h.value);
          const max = Math.max(...values);
          const min = Math.min(...values);
          
          if (max === min) return 50;
          return Math.max(10, ((value - min) / (max - min)) * 90 + 10);
        },
        
        getPRProgress(exId) {
          const history = this.prHistory[exId] || [];
          if (history.length < 2) return 0;
          
          const first = history[0].value;
          const last = history[history.length - 1].value;
          return (last - first).toFixed(1);
        },
        
        postponeExercise(bIdx, eIdx) {
          this.currentSession.blocks[bIdx].exercises[eIdx].postponed = true;
          this.saveSession();
        },
        
        restoreFromModal(ex) {
          for (let b of this.currentSession.blocks) {
            for (let e of b.exercises) {
              if (e.id === ex.id && e.postponed) { e.postponed = false; break; }
            }
          }
          this.saveSession();
          this.showPostponedModal = false;
        },
        
        getPostponedExercises() {
          if (!this.currentSession) return [];
          const p = [];
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => { if (e.postponed && !e.removed) p.push(e); }));
          return p;
        },
        
        getCompletedCount() {
          if (!this.currentSession) return 0;
          let c = 0;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => { if (e.completed && !e.removed) c++; }));
          return c;
        },
        
        getTotalCount() {
          if (!this.currentSession) return 0;
          let c = 0;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => { if (!e.removed) c++; }));
          return c;
        },
        
        getIncompleteCount() { return this.getTotalCount() - this.getCompletedCount() - this.getPostponedExercises().length; },
        
        completeExercise(bIdx, eIdx) {
          const ex = this.currentSession.blocks[bIdx].exercises[eIdx];
          ex.completed = !ex.completed;
          ex.postponed = false;
          
          if (ex.completed && ex.trackSets && ex.sets) {
            const values = ex.sets.map(s => s.value).filter(v => v);
            if (values.length > 0) this.saveExerciseValue(ex.id, values[values.length - 1]);
          }
          
          this.saveSession();
          
          if (ex.completed && this.getIncompleteCount() > 0) {
            this.showRestBetweenModal = true;
          }
        },
        
        swapExercise(bIdx, eIdx, newName) {
          const newEx = Object.values(EJERCICIOS).find(e => e.name === newName);
          if (!newEx) return;
          const old = this.currentSession.blocks[bIdx].exercises[eIdx];
          const esCasa = this.currentSession.ubicacion === 'casa';
          
          // B2: Filtrar sustitutos del nuevo ejercicio por ubicaci√≥n
          const subs = (newEx.sustitutos || [])
            .map(s => EJERCICIOS[s])
            .filter(s => s && !(esCasa && s.soloGym) && !(!esCasa && s.soloCasa))
            .map(s => s.name);
          
          this.currentSession.blocks[bIdx].exercises[eIdx] = { 
            ...old, 
            id: newEx.id, 
            name: newEx.name, 
            trackType: newEx.trackType, 
            substitutes: subs, 
            showSubs: false 
          };
          this.saveSession();
        },
        
        // M3: Sistema de dolor mejorado
        selectPainArea(area) {
          this.selectedPainArea = area;
          this.showPainModal = false;
          this.showPainConfirmModal = true;
        },
        
        getPainAreaName(area) {
          return { 'rodilla': 'rodilla', 'cuello': 'cuello', 'espalda': 'espalda baja', 'hombro': 'hombro' }[area] || area;
        },
        
        getRelatedExercisesCount(area) {
          if (!this.currentSession || !area) return 0;
          let count = 0;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => {
            if (e.removed || e.completed) return;
            const ex = EJERCICIOS[e.id];
            if (!ex) return;
            if (area === 'rodilla' && ex.riesgoRodilla >= 2) count++;
            else if (area === 'cuello' && ex.riesgoCuello >= 2) count++;
            else if (area === 'espalda' && ex.patron === 'bisagra') count++;
            else if (area === 'hombro' && (ex.riesgoHombro >= 2 || ex.patron === 'empuje')) count++;
          }));
          return count;
        },
        
        handlePainShowAlternatives() {
          const area = this.selectedPainArea;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => {
            const ex = EJERCICIOS[e.id];
            if (!ex) return;
            if ((area === 'rodilla' && ex.riesgoRodilla >= 2) || 
                (area === 'cuello' && ex.riesgoCuello >= 2) || 
                (area === 'espalda' && ex.patron === 'bisagra') || 
                (area === 'hombro' && (ex.riesgoHombro >= 2 || ex.patron === 'empuje'))) {
              e.showSubs = true;
            }
          }));
          this.saveSession();
          this.showPainConfirmModal = false;
        },
        
        handlePainRemoveExercises() {
          const area = this.selectedPainArea;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => {
            if (e.completed) return;
            const ex = EJERCICIOS[e.id];
            if (!ex) return;
            if ((area === 'rodilla' && ex.riesgoRodilla >= 2) || 
                (area === 'cuello' && ex.riesgoCuello >= 2) || 
                (area === 'espalda' && ex.patron === 'bisagra') || 
                (area === 'hombro' && (ex.riesgoHombro >= 2 || ex.patron === 'empuje'))) {
              e.removed = true;
            }
          }));
          this.saveSession();
          this.showPainConfirmModal = false;
        },
        
        // Timer
        startTimer(seconds) {
          this.initAudio(); // Inicializar audio con la interacci√≥n del usuario
          this.timerTotal = seconds;
          this.timerEndTime = Date.now() + seconds * 1000;
          this.timerRemaining = seconds;
          this.timerProgress = 100;
          this.timerLabel = null;
          this.showTimerModal = true;
          
          if (this.timerInterval) clearInterval(this.timerInterval);
          this.timerInterval = setInterval(() => {
            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((this.timerEndTime - now) / 1000));
            this.timerRemaining = remaining;
            this.timerProgress = (remaining / this.timerTotal) * 100;
            
            if (remaining === 0) this.timerFinished();
          }, 100);
        },
        
        startIsometricTimer(exercise, lado) {
          // Extraer segundos de la prescripci√≥n o usar tiempoBase
          let seconds = 30; // default
          const match = exercise.prescription?.match(/(\d+)s/);
          if (match) seconds = parseInt(match[1]);
          else if (EXERCISES[exercise.id]?.tiempoBase) seconds = EXERCISES[exercise.id].tiempoBase;
          
          this.initAudio();
          this.timerTotal = seconds;
          this.timerEndTime = Date.now() + seconds * 1000;
          this.timerRemaining = seconds;
          this.timerProgress = 100;
          this.timerLabel = lado === 'izq' ? 'üîµ Lado izquierdo' : 'üü† Lado derecho';
          this.showTimerModal = true;
          
          if (this.timerInterval) clearInterval(this.timerInterval);
          this.timerInterval = setInterval(() => {
            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((this.timerEndTime - now) / 1000));
            this.timerRemaining = remaining;
            this.timerProgress = (remaining / this.timerTotal) * 100;
            
            if (remaining === 0) this.timerFinished();
          }, 100);
        },
        
        // Audio para iOS
        audioContext: null,
        audioUnlocked: false,
        
        initAudio() {
          if (!this.audioContext) {
            try {
              this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) {
              console.log('No AudioContext');
            }
          }
          
          // Desbloquear audio en iOS (reproducir silencio)
          if (this.audioContext && !this.audioUnlocked) {
            // Crear buffer de silencio
            const buffer = this.audioContext.createBuffer(1, 1, 22050);
            const source = this.audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(this.audioContext.destination);
            source.start(0);
            
            // Reanudar si est√° suspendido
            if (this.audioContext.state === 'suspended') {
              this.audioContext.resume();
            }
            
            this.audioUnlocked = true;
          }
        },
        
        playBeep() {
          // Vibraci√≥n (Android/algunos navegadores)
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }
          
          // Sonido con Web Audio API
          if (this.audioContext) {
            try {
              if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
              }
              
              const now = this.audioContext.currentTime;
              
              // Triple beep
              for (let i = 0; i < 3; i++) {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                
                osc.frequency.value = i === 2 ? 1000 : 800; // Tercer beep m√°s agudo
                osc.type = 'square'; // M√°s audible que sine
                
                gain.gain.setValueAtTime(0.3, now + i * 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.2 + 0.15);
                
                osc.start(now + i * 0.2);
                osc.stop(now + i * 0.2 + 0.15);
              }
            } catch(e) {
              console.log('Beep error:', e);
            }
          }
        },
        
        timerFinished() {
          clearInterval(this.timerInterval);
          this.playBeep();
        },
        
        stopTimer() {
          if (this.timerInterval) clearInterval(this.timerInterval);
          this.showTimerModal = false;
        },
        
        addTimerSeconds(s) {
          this.timerEndTime += s * 1000;
          this.timerTotal = Math.max(this.timerTotal, Math.ceil((this.timerEndTime - Date.now()) / 1000));
        },
        
        formatTimer(s) { return Math.floor(s / 60) + ':' + (s % 60).toString().padStart(2, '0'); },
        
        startRestBetween(s) {
          this.showRestBetweenModal = false;
          this.startTimer(s);
        },
        
        startSessionTimer() {
          if (this.sessionInterval) clearInterval(this.sessionInterval);
          this.sessionInterval = setInterval(() => {
            if (this.sessionStartTime) {
              this.sessionElapsed = Math.floor((Date.now() - this.sessionStartTime.getTime()) / 1000);
            }
          }, 1000);
        },
        
        formatSessionTime(s) {
          const m = Math.floor(s / 60);
          const sec = s % 60;
          return m + ':' + sec.toString().padStart(2, '0');
        },
        
        confirmFinish() {
          this.showFinishModal = true;
        },
        
        finishSession() {
          if (this.sessionInterval) clearInterval(this.sessionInterval);
          
          let completed = 0, total = 0;
          this.currentSession.blocks.forEach(b => b.exercises.forEach(e => { 
            if (!e.removed) {
              total++; 
              if (e.completed) completed++; 
            }
          }));
          
          this.recentSessions.unshift({
            date: this.currentSession.date,
            dayType: this.currentSession.dayType,
            ubicacion: this.currentSession.ubicacion,
            tiempo: this.currentSession.tiempo,
            duration: this.sessionElapsed,
            completed: completed >= total * 0.7,
            completedExercises: completed,
            totalExercises: total
          });
          
          this.saveSessions();
          this.calculateNextDay();
          this.saveNextDay();
          localStorage.removeItem('coach_currentSession');
          this.currentSession = null;
          this.sessionStartTime = null;
          this.sessionElapsed = 0;
          this.resetCheckin();
          this.calculateStats();
          
          // M5: Incrementar semanas sin descarga
          this.profile.sessionsSinceBackup = (this.profile.sessionsSinceBackup || 0) + 1;
          // Cada 3 sesiones = aproximadamente 1 semana
          if (this.recentSessions.length % 3 === 0) {
            this.profile.weeksWithoutDeload = (this.profile.weeksWithoutDeload || 0) + 1;
          }
          this.saveProfile();
          this.showFinishModal = false;
          
          if (this.profile.autoBackup) this.exportData();
        },
        
        cancelSession() {
          if (this.sessionInterval) clearInterval(this.sessionInterval);
          localStorage.removeItem('coach_currentSession');
          this.currentSession = null;
          this.sessionStartTime = null;
          this.sessionElapsed = 0;
          this.showCancelModal = false;
        },
        
        saveNewMetric() {
          if (!this.newMetric.peso && !this.newMetric.cintura) return;
          this.metricsHistory.push({
            date: new Date().toISOString(),
            peso: this.newMetric.peso,
            cintura: this.newMetric.cintura
          });
          this.saveMetricsHistory();
          this.newMetric = { peso: null, cintura: null };
        },
        
        getWeightTrend() {
          if (this.metricsHistory.length < 2) return 0;
          const first = this.metricsHistory[0].peso;
          const last = this.metricsHistory[this.metricsHistory.length - 1].peso;
          if (!first || !last) return 0;
          return Math.round((last - first) * 10) / 10;
        },
        
        getMetricBarHeight(value, type) {
          const values = this.metricsHistory.map(m => m[type]).filter(v => v);
          if (values.length === 0) return 50;
          const min = Math.min(...values);
          const max = Math.max(...values);
          if (max === min) return 50;
          return 20 + ((value - min) / (max - min)) * 80;
        },
        
        calculateWeekDays() {
          const days = [];
          const names = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
          const today = new Date();
          for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            days.push({ date: d.toDateString(), label: names[d.getDay()] });
          }
          this.weekDays = days;
        },
        
        calculateStats() {
          const weekStart = new Date();
          weekStart.setDate(weekStart.getDate() - 6);
          this.weeklyStats.completed = this.recentSessions.filter(s => new Date(s.date) >= weekStart).length;
        },
        
        getWorkoutDayClass(day) {
          const s = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          if (!s) return 'stat-bar-empty';
          return s.completed ? 'stat-bar-complete' : 'stat-bar-partial';
        },
        
        getWorkoutDayHeight(day) {
          const s = this.recentSessions.find(s => new Date(s.date).toDateString() === day.date);
          return s ? (s.completed ? 60 : 35) : 12;
        },
        
        getTotalCompletedSessions() { return this.recentSessions.filter(s => s.completed).length; },
        
        getAverageDuration() {
          const withDuration = this.recentSessions.filter(s => s.duration);
          if (withDuration.length === 0) return '‚Äî';
          const avg = withDuration.reduce((sum, s) => sum + s.duration, 0) / withDuration.length;
          return Math.round(avg / 60);
        },
        
        formatDate(str) {
          const d = new Date(str);
          const today = new Date();
          if (d.toDateString() === today.toDateString()) return 'Hoy';
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          if (d.toDateString() === yesterday.toDateString()) return 'Ayer';
          return d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        },
        
        needsBackupReminder() { return (this.profile.sessionsSinceBackup || 0) >= 5; },
        getLastBackupDate() { return this.profile.lastBackupDate ? new Date(this.profile.lastBackupDate).toLocaleDateString('es-ES') : 'Nunca'; },
        
        exportData() {
          const data = { version: APP_VERSION, date: new Date().toISOString(), profile: this.profile, materialCasa: this.materialCasa, recentSessions: this.recentSessions, nextDayType: this.nextDayType, metricsHistory: this.metricsHistory, exerciseHistory: this.exerciseHistory, prHistory: this.prHistory };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `coach-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          this.profile.sessionsSinceBackup = 0;
          this.profile.lastBackupDate = new Date().toISOString();
          this.saveProfile();
          this.showBackupModal = false;
        },
        
        async importData(e) {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const data = JSON.parse(await file.text());
            if (data.profile) { this.profile = { ...this.profile, ...data.profile }; this.saveProfile(); }
            if (data.materialCasa) { this.materialCasa = { ...this.materialCasa, ...data.materialCasa }; this.saveMaterial(); }
            if (data.recentSessions) { this.recentSessions = data.recentSessions; this.saveSessions(); }
            if (data.nextDayType) { this.nextDayType = data.nextDayType; this.saveNextDay(); }
            if (data.metricsHistory) { this.metricsHistory = data.metricsHistory; this.saveMetricsHistory(); }
            if (data.exerciseHistory) { this.exerciseHistory = data.exerciseHistory; this.saveExerciseHistory(); }
            if (data.prHistory) { this.prHistory = data.prHistory; this.savePRHistory(); }
            this.calculateStats();
            alert('‚úÖ Importado');
          } catch(err) { alert('‚ùå Error: ' + err.message); }
          e.target.value = '';
          this.showBackupModal = false;
        },
        
        // ==================== FUNCIONES MOVILIDAD ====================
        startMobilityRoutine(type) {
          const routine = MOBILITY_ROUTINES[type];
          if (!routine) return;
          
          this.mobilitySession = {
            active: true,
            routineType: type,
            exercises: [...routine.exercises],
            currentIndex: 0
          };
        },
        
        getMobilityRoutineTitle() {
          if (!this.mobilitySession.routineType) return '';
          return MOBILITY_ROUTINES[this.mobilitySession.routineType]?.title || '';
        },
        
        getCurrentMobilityExercise() {
          if (!this.mobilitySession.exercises.length) return { name: '', emoji: '', duration: '', instruction: '', timed: false };
          return this.mobilitySession.exercises[this.mobilitySession.currentIndex] || this.mobilitySession.exercises[0];
        },
        
        getMobilityTimerLabel() {
          const ex = this.getCurrentMobilityExercise();
          // Series (Wall Sit)
          if (ex.hasSets) {
            if (this.mobilityTimer.isResting) {
              return 'üòÆ‚Äçüí® Descanso';
            }
            return 'üí™ Serie ' + this.mobilityTimer.currentSet + '/' + this.mobilityTimer.totalSets;
          }
          // Lados (estiramientos)
          if (ex.hasSides && this.mobilityTimer.sideLabels.length) {
            return this.mobilityTimer.sideLabels[this.mobilityTimer.currentSide] || '';
          }
          return '';
        },
        
        playTimerSound() {
          this.playBeep();
        },
        
        startMobilityTimer() {
          this.initAudio(); // Inicializar audio con la interacci√≥n del usuario
          const exercise = this.getCurrentMobilityExercise();
          
          // Reset
          this.mobilityTimer.currentSet = 0;
          this.mobilityTimer.totalSets = 0;
          this.mobilityTimer.isResting = false;
          this.mobilityTimer.currentSide = 0;
          this.mobilityTimer.totalSides = 0;
          this.mobilityTimer.sideLabels = [];
          
          // Ejercicio con series (Wall Sit)
          if (exercise.hasSets) {
            this.mobilityTimer.totalSets = exercise.sets;
            this.mobilityTimer.currentSet = 1;
            this.mobilityTimer.workTime = exercise.workTime;
            this.mobilityTimer.restTime = exercise.restTime;
            this.mobilityTimer.total = exercise.workTime;
            this.mobilityTimer.remaining = exercise.workTime;
          } 
          // Ejercicio con lados (estiramientos)
          else if (exercise.hasSides) {
            this.mobilityTimer.totalSides = 2;
            this.mobilityTimer.currentSide = 0;
            this.mobilityTimer.sideLabels = exercise.sideLabels || ['Lado 1', 'Lado 2'];
            this.mobilityTimer.total = exercise.sideTime;
            this.mobilityTimer.remaining = exercise.sideTime;
          }
          // Ejercicio simple
          else {
            if (!exercise.seconds) return;
            this.mobilityTimer.total = exercise.seconds;
            this.mobilityTimer.remaining = exercise.seconds;
          }
          
          this.mobilityTimer.active = true;
          
          this.mobilityTimer.interval = setInterval(() => {
            this.mobilityTimer.remaining--;
            if (this.mobilityTimer.remaining <= 0) {
              this.handleMobilityTimerComplete();
            }
          }, 1000);
        },
        
        handleMobilityTimerComplete() {
          this.playTimerSound();
          
          const exercise = this.getCurrentMobilityExercise();
          
          // Si tiene series (Wall Sit)
          if (exercise.hasSets) {
            if (this.mobilityTimer.isResting) {
              // Termina descanso, empieza siguiente serie
              this.mobilityTimer.currentSet++;
              this.mobilityTimer.isResting = false;
              this.mobilityTimer.total = this.mobilityTimer.workTime;
              this.mobilityTimer.remaining = this.mobilityTimer.workTime;
            } else {
              // Termina serie de trabajo
              if (this.mobilityTimer.currentSet >= this.mobilityTimer.totalSets) {
                // √öltima serie completada
                this.completeMobilityTimer();
              } else {
                // Empieza descanso
                this.mobilityTimer.isResting = true;
                this.mobilityTimer.total = this.mobilityTimer.restTime;
                this.mobilityTimer.remaining = this.mobilityTimer.restTime;
              }
            }
          } 
          // Si tiene lados (estiramientos)
          else if (exercise.hasSides) {
            if (this.mobilityTimer.currentSide < this.mobilityTimer.totalSides - 1) {
              // Cambiar al siguiente lado
              this.mobilityTimer.currentSide++;
              this.mobilityTimer.total = exercise.sideTime;
              this.mobilityTimer.remaining = exercise.sideTime;
            } else {
              // Ambos lados completados
              this.completeMobilityTimer();
            }
          }
          // Ejercicio simple
          else {
            this.completeMobilityTimer();
          }
        },
        
        completeMobilityTimer() {
          clearInterval(this.mobilityTimer.interval);
          this.mobilityTimer.active = false;
          this.mobilityTimer.isResting = false;
          this.mobilityTimer.currentSet = 0;
          this.mobilityTimer.totalSets = 0;
          this.mobilityTimer.currentSide = 0;
          this.mobilityTimer.totalSides = 0;
          this.nextMobilityExercise();
        },
        
        skipMobilityTimer() {
          clearInterval(this.mobilityTimer.interval);
          this.mobilityTimer.active = false;
          this.mobilityTimer.isResting = false;
          this.mobilityTimer.currentSet = 0;
          this.mobilityTimer.totalSets = 0;
          this.mobilityTimer.currentSide = 0;
          this.mobilityTimer.totalSides = 0;
          this.nextMobilityExercise();
        },
        
        nextMobilityExercise() {
          if (this.mobilitySession.currentIndex >= this.mobilitySession.exercises.length - 1) {
            // Finalizar rutina
            this.completeMobilitySession();
          } else {
            this.mobilitySession.currentIndex++;
          }
        },
        
        completeMobilitySession() {
          this.playTimerSound();
          this.mobilitySession.active = false;
          this.mobilitySession.currentIndex = 0;
          this.mobilitySession.exercises = [];
          alert('‚úÖ ¬°Rutina completada! Tu cuerpo te lo agradece.');
        },
        
        cancelMobilitySession() {
          if (confirm('¬øCancelar la rutina de movilidad?')) {
            clearInterval(this.mobilityTimer.interval);
            this.mobilityTimer.active = false;
            this.mobilityTimer.isResting = false;
            this.mobilitySession.active = false;
            this.mobilitySession.currentIndex = 0;
            this.mobilitySession.exercises = [];
          }
        },
        
        confirmReset() {
          if (confirm('¬øBorrar TODOS los datos?')) {
            localStorage.clear();
            location.reload();
          }
        }
      };
    }
  </script>
</body>
</html>
